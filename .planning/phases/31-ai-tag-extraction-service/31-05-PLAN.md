---
phase: 31-ai-tag-extraction-service
plan: 05
type: execute
wave: 1
depends_on:
  - 31-04
files_modified:
  - src/App.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - Toast notification shows when quota exceeded after climb save
    - Toast notification uses user-friendly messages from useTagExtractionFeedback hook
  artifacts:
    - path: src/App.tsx
      provides: Quota exceeded toast integration
      contains: "showQuotaReached\\(\\)"
      imports: ["useTagExtractionFeedback"]
  key_links:
    - from: "src/App.tsx"
      to: "src/hooks/useTagExtractionFeedback.ts"
      via: "Import and call showQuotaReached function"
      pattern: "useTagExtractionFeedback\\(\\).*showQuotaReached"
    - from: "src/App.tsx"
      to: "src/services/climbs.ts"
      via: "Handle climb save success and check quota"
      pattern: "createClimb.mutate.*onSuccess"
---

<objective>
Wire quota exceeded toast notification to App.tsx - integrates useTagExtractionFeedback hook to display warning toast when daily tag extraction quota is reached after climb save. This closes the gap identified in verification where quota state existed but UI notification wasn't connected.

Purpose: Complete EXTR-08 (graceful failure with user notification) for the quota exceeded case, which is the most common error users will encounter.
Output: Toast notification appears when quota exceeded after climb save, informing users of time until reset.

**Scope Note:** This plan implements quota exceeded notification only. Full extraction error handling (api_error, network_error, etc.) requires architectural changes to the service API (modifying createClimb to return extractionError) or implementing an event system. These decisions should be made in a dedicated design plan, not in this gap closure plan.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/31-ai-tag-extraction-service/31-VERIFICATION.md
@.planning/phases/31-ai-tag-extraction-service/31-04-SUMMARY.md
@.planning/phases/31-ai-tag-extraction-service/31-04-PLAN.md

# Existing infrastructure
@src/App.tsx
@src/hooks/useTagExtractionFeedback.ts
@src/services/climbs.ts
@src/services/tagExtraction.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Import and use useTagExtractionFeedback hook in App.tsx</name>
  <files>src/App.tsx</files>
  <action>
    Modify src/App.tsx to wire quota exceeded toast notification to climb save flow:

    1. Add import at top of file (after existing imports, maintain import order):
       ```typescript
       import { useTagExtractionFeedback } from '@/hooks/useTagExtractionFeedback'
       ```

    2. In Layout component, add hook call before handleClimbSubmit:
       ```typescript
       const { showQuotaReached } = useTagExtractionFeedback()
       ```

    3. In handleClimbSubmit, modify createClimb success handler:
       ```typescript
       createClimb.mutate(data, {
         onSuccess: () => {
           loggerRef.current?.resetAllState()
           if (profile?.close_logger_after_add) {
             setLoggerOpen(false)
           }
           toast.success('Climb logged successfully')

           // Show quota warning if reached
           // The useTagExtractionFeedback hook tracks quota state
           // When quota is reached, show warning toast with reset time
           if (showQuotaReached) {
             showQuotaReached()
           }
         },
         onError: (error) => {
           console.error('Failed to create climb:', error)
           setErrorMessage(error.message || 'Failed to save climb')
         },
       })
       ```

    4. Note: The useTagExtractionFeedback hook (from Phase 31-04) already:
       - Tracks tag_count via useTagQuota() hook
       - Provides showQuotaReached() function with user-friendly message
       - Calculates time until quota reset (midnight UTC)
       - Uses a flag to avoid spamming the toast

    5. This implementation handles the most common and user-visible error case (quota exceeded).
       Other extraction errors (api_error, network_error) are logged but not shown to users yet.
       These require architectural changes to the service layer to flow error information back to App.tsx.

    For details on why only quota notification is implemented, see the objective scope note above.
  </action>
  <verify>
    Run: pnpm typecheck - no TypeScript errors
    Run: pnpm lint - no errors
    Check: useTagExtractionFeedback imported in App.tsx
    Check: showQuotaReached() called in handleClimbSubmit
  </verify>
  <done>App.tsx uses useTagExtractionFeedback hook to show quota reached toast after climb save</done>
</task>

</tasks>

<verification>
After completion:
1. Run "pnpm typecheck" - no TypeScript errors
2. Run "pnpm lint" - no lint errors
3. Verify useTagExtractionFeedback import in App.tsx
4. Verify showQuotaReached() called in handleClimbSubmit onSuccess handler
5. Test scenario: Save climb when quota is at limit (49/50), verify warning toast appears
6. Verify toast message includes time until reset
7. Verify climb still saves successfully (non-blocking)

**Note on extraction error handling:**
This plan implements quota exceeded notification only. Other extraction errors (api_error, network_error, etc.) require:
- Modifying the service API to return extractionError (breaking change to createClimb)
- Or implementing an event emitter to notify App.tsx when extraction fails
- Or using a global state store (Zustand) to share extraction errors

These are architectural design decisions beyond the scope of this gap closure plan. A future plan should be created to:
1. Evaluate the options (event system vs global state vs service API change)
2. Implement the chosen approach
3. Wire all extraction error types to toast notifications

This plan addresses the most critical gap from verification by ensuring users are informed when they reach their daily quota.
</verification>

<success_criteria>
Toast notification appears for quota exceeded after climb save. Users are informed when they reach daily limit with reset time. EXTR-08 (graceful failure with user notification) partially complete - quota handling implemented. Other extraction errors remain logged but not shown to users pending architectural decision.
</success_criteria>

<output>
After completion, create `.planning/phases/31-ai-tag-extraction-service/31-05-SUMMARY.md`
</output>
