---
phase: 31-ai-tag-extraction-service
plan: 07
type: execute
wave: 1
depends_on: [31-04, 31-05]
files_modified: [src/services/climbs.ts, src/App.tsx, src/hooks/useClimbs.ts]
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Toast notification shows when tag extraction fails (api_error, network_error, unknown)"
  artifacts:
    - path: "src/hooks/useClimbs.ts"
      provides: "useCreateClimb hook with extractionError state"
      exports: ["useCreateClimb"]
    - path: "src/services/climbs.ts"
      provides: "createClimb returns extractionError in callback"
      exports: ["createClimb"]
    - path: "src/App.tsx"
      provides: "showExtractionError() called for non-quota errors"
      contains: "showExtractionError"
  key_links:
    - from: "src/services/climbs.ts"
      to: "src/hooks/useClimbs.ts"
      via: "extractionError callback parameter"
      pattern: "onExtractionError.*errorType"
    - from: "src/hooks/useClimbs.ts"
      to: "src/App.tsx"
      via: "extractionError state from mutation"
      pattern: "extractionError.*errorType"
    - from: "src/App.tsx"
      to: "src/hooks/useTagExtractionFeedback.ts"
      via: "showExtractionError() function call"
      pattern: "showExtractionError\\(extractionError\\)"
---

<objective>
Wire tag extraction error notifications to UI for api_error, network_error, and unknown error types. Uses optional callback pattern to flow extraction errors from service layer to App.tsx while maintaining fire-and-forget async extraction architecture.

Purpose: Complete EXTR-08 (graceful failure with user notification) by showing toast notifications when tag extraction fails (beyond quota exceeded case which is already wired).

Output: Toast notifications appear for all extraction error types (api_error, network_error, unknown) when tag extraction fails after climb save.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/phases/31-ai-tag-extraction-service/31-VERIFICATION.md
@.planning/phases/31-ai-tag-extraction-service/31-04-SUMMARY.md
@.planning/phases/31-ai-tag-extraction-service/31-05-SUMMARY.md

@src/services/tagExtraction.ts
@src/services/climbs.ts
@src/hooks/useTagExtractionFeedback.ts
@src/App.tsx
@src/hooks/useClimbs.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add extraction error callback to createClimb</name>
  <files>src/services/climbs.ts</files>
  <action>
Modify createClimb function to accept an optional onExtractionError callback parameter:

1. Update createClimb signature:
   ```typescript
   export async function createClimb(
     input: CreateClimbInput,
     onExtractionError?: (errorType: TagExtractionErrorType) => void
   ): Promise<Climb>
   ```

2. Pass onExtractionError to triggerTagExtraction call (line 68):
   ```typescript
   triggerTagExtraction(climb, user.id)
     .then((result: TagExtractionResult) => {
       if (!result.success && result.errorType !== undefined) {
         console.warn(`Tag extraction failed: ${result.errorType}`)
         // Notify UI via callback
         onExtractionError?.(result.errorType)
       }
     })
   ```

3. Do NOT await the extraction (maintain fire-and-forget pattern)
4. Callback is optional - maintains backward compatibility
5. Only call callback for actual errors, not for quota_exceeded (handled separately by UI state)

Reference: src/hooks/useClimbs.ts for callback usage pattern (see onTagsExtracted in existing codebase)
  </action>
  <verify>
TypeScript compilation passes (npx tsc --noEmit)
</verify>
  <done>
createClimb accepts optional onExtractionError callback and calls it with errorType when extraction fails (excluding quota_exceeded)
</done>
</task>

<task type="auto">
  <name>Task 2: Add extraction error state to useCreateClimb hook</name>
  <files>src/hooks/useClimbs.ts</files>
  <action>
Modify useCreateClimb hook to track extraction errors and pass callback to createClimb:

1. Add extractionError state to hook:
   ```typescript
   const [extractionError, setExtractionError] = useState<TagExtractionErrorType | undefined>(undefined)
   ```

2. Pass onExtractionError callback to createClimb in mutationFn:
   ```typescript
   mutationFn: async (data) => createClimb(data, setExtractionError)
   ```

3. Return extractionError from hook (add to return object):
   ```typescript
   return {
     ...existing returns,
     extractionError
   }
   ```

4. Clear extractionError when mutation starts (to avoid stale errors):
   ```typescript
   onSuccess: () => {
     // ...existing code...
     setExtractionError(undefined)
   }
   ```

Reference: src/services/climbs.ts createClimb function signature (Task 1)
Reference: src/hooks/useTagExtractionFeedback.ts for TagExtractionErrorType import
  </action>
  <verify>
TypeScript compilation passes (npx tsc --noEmit)
</verify>
  <done>
useCreateClimb hook tracks extractionError state and returns it to calling component
</done>
</task>

<task type="auto">
  <name>Task 3: Wire extraction error toast to App.tsx</name>
  <files>src/App.tsx</files>
  <action>
Modify App.tsx to show extraction error toast when extraction fails:

1. Extract extractionError from useTagExtractionFeedback hook (line 82):
   ```typescript
   const { isQuotaReached, showQuotaReached, showExtractionError } = useTagExtractionFeedback()
   ```

2. Extract extractionError from useCreateClimb hook (add to line 83 destructuring):
   ```typescript
   const createClimb = useCreateClimb()
   const updateClimb = useUpdateClimb()
   const deleteClimb = useDeleteClimb()
   const extractionError = createClimb.extractionError
   ```

3. Add useEffect to show extraction error toast when error is set:
   ```typescript
   useEffect(() => {
     if (extractionError !== undefined && extractionError !== 'quota_exceeded') {
       showExtractionError(extractionError)
     }
   }, [extractionError, showExtractionError])
   ```

4. Explicitly exclude 'quota_exceeded' since that's handled by isQuotaReached logic (lines 120-124)
5. Toast appears after "Climb logged successfully" message

Reference: src/hooks/useTagExtractionFeedback.ts for showExtractionError function
Reference: src/hooks/useClimbs.ts for extractionError state
  </action>
  <verify>
TypeScript compilation passes (npx tsc --noEmit)
ESLint passes (npm run lint)
</verify>
  <done>
App.tsx shows toast notification when extractionError is set (api_error, network_error, unknown)
</done>
</task>

</tasks>

<verification>
## Overall Phase Checks

- Toast notification displays for api_error when Edge Function returns error
- Toast notification displays for network_error when fetch fails
- Toast notification displays for unknown error for unexpected failures
- Quota exceeded continues to use existing isQuotaReached logic (no regression)
- Tag extraction remains non-blocking (fire-and-forget pattern maintained)
- User sees "Climb logged successfully" toast, then extraction error toast (if applicable)

## Manual Verification Steps

1. Mock Edge Function failure (disable OPENROUTER_API_KEY in Supabase)
2. Save climb with notes
3. Verify "Climb logged successfully" toast appears
4. Verify "Tag extraction failed. You can add tags manually." toast appears
5. Repeat with network error (disable network in DevTools)
6. Verify "Tag extraction failed due to network. Check your connection." toast appears
</verification>

<success_criteria>
Toast notifications appear for all extraction error types (api_error, network_error, unknown) after successful climb save. EXTR-08 (graceful failure with user notification) is 100% complete.
</success_criteria>

<output>
After completion, create `.planning/phases/31-ai-tag-extraction-service/31-07-SUMMARY.md`
</output>
