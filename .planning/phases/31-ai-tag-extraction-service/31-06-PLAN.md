---
phase: 31-ai-tag-extraction-service
plan: 06
type: execute
wave: 1
depends_on:
  - 31-02
files_modified: []
autonomous: false
gap_closure: true

user_setup:
  - service: supabase
    why: "Push database migrations and deploy Edge Function"
    commands:
      - command: npx supabase db push
        description: "Push tag extraction migrations to database"
      - command: npx supabase functions deploy openrouter-tag-extract --no-verify-jwt
        description: "Deploy tag extraction Edge Function"
    dashboard_config:
      - task: "Set OPENROUTER_TAG_MODEL environment variable"
        location: "Supabase Dashboard -> Edge Functions -> openrouter-tag-extract -> Environment variables"
        value: "Your chosen OpenRouter model (e.g., anthropic/claude-3-haiku, openai/gpt-4o-mini)"
      - task: "Verify OPENROUTER_API_KEY is set"
        location: "Supabase Dashboard -> Edge Functions -> openrouter-tag-extract -> Environment variables"

must_haves:
  truths:
    - Migrations applied to production database (tag_count, tag_extraction_api_usage, tags_extracted_at)
    - Edge Function deployed and accessible
    - Environment variables configured (OPENROUTER_TAG_MODEL, OPENROUTER_API_KEY)
    - Edge Function can be invoked without errors
  artifacts:
    - path: supabase/migrations/20260121000001_add_tag_count.sql
      provides: tag_count column and increment_tag_count RPC
      status: "deployed to production"
    - path: supabase/migrations/20260121000002_create_tag_extraction_api_usage.sql
      provides: API usage tracking table
      status: "deployed to production"
    - path: supabase/migrations/20260121000003_add_tags_extracted_at.sql
      provides: Extraction timestamp column
      status: "deployed to production"
    - path: supabase/functions/openrouter-tag-extract/index.ts
      provides: Tag extraction Edge Function
      status: "deployed to production"
  key_links:
    - from: "supabase/migrations"
      to: "production database"
      via: "npx supabase db push command"
    - from: "supabase/functions/openrouter-tag-extract/index.ts"
      to: "Supabase Edge Functions runtime"
      via: "npx supabase functions deploy command"
---

<objective>
Deploy database migrations and Edge Function to production - applies tag extraction migrations to database and deploys openrouter-tag-extract Edge Function with required environment variables. This closes gap identified in verification where migration files existed but deployment status was unknown.

Purpose: Complete database infrastructure and make Edge Function operational for Phase 31 functionality.
Output: Database migrations applied, Edge Function deployed and configured with environment variables.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/31-ai-tag-extraction-service/31-VERIFICATION.md
@.planning/phases/31-ai-tag-extraction-service/31-01-SUMMARY.md
@.planning/phases/31-ai-tag-extraction-service/31-02-SUMMARY.md

# Deployment targets
@supabase/migrations/20260121000001_add_tag_count.sql
@supabase/migrations/20260121000002_create_tag_extraction_api_usage.sql
@supabase/migrations/20260121000003_add_tags_extracted_at.sql
@supabase/functions/openrouter-tag-extract/index.ts
@supabase/functions/openrouter-tag-extract/deno.json
</context>

<tasks>

<task type="checkpoint:human-action">
  <name>Task 1: Push database migrations to production</name>
  <files>supabase/migrations/*.sql</files>
  <what-built>Three migration files created in Phase 31-01 (tag_count, tag_extraction_api_usage, tags_extracted_at) that need to be applied to production database.</what-built>
  <how-to-verify>
    1. Open terminal in project root
    2. Run: npx supabase db push
    3. Verify output shows all three migrations applied successfully:
       - Applying migration 20260121000001_add_tag_count.sql
       - Applying migration 20260121000002_create_tag_extraction_api_usage.sql
       - Applying migration 20260121000003_add_tags_extracted_at.sql
    4. Confirm no errors in output
  </how-to-verify>
  <resume-signal>Type "deployed" or "migrations applied" to continue</resume-signal>
</task>

<task type="checkpoint:human-action">
  <name>Task 2: Deploy Edge Function to Supabase</name>
  <files>supabase/functions/openrouter-tag-extract/*</files>
  <what-built>Edge Function implementation (openrouter-tag-extract/index.ts) created in Phase 31-02 that needs to be deployed to Supabase runtime.</what-built>
  <how-to-verify>
    1. Ensure migrations are pushed (Task 1 completed)
    2. Run: npx supabase functions deploy openrouter-tag-extract --no-verify-jwt
    3. Verify output shows:
       - Deployed Function: openrouter-tag-extract
       - URL: https://[project-ref].supabase.co/functions/v1/openrouter-tag-extract
    4. Confirm no errors in output
  </how-to-verify>
  <resume-signal>Type "deployed" or "function deployed" to continue</resume-signal>
</task>

<task type="checkpoint:human-action">
  <name>Task 3: Configure environment variables in Supabase Dashboard</name>
  <files>supabase/functions/openrouter-tag-extract/index.ts</files>
  <what-built>Edge Function requires OPENROUTER_TAG_MODEL and OPENROUTER_API_KEY environment variables to function. These must be configured in Supabase Dashboard.</what-built>
  <how-to-verify>
    1. Navigate to: Supabase Dashboard -> Edge Functions -> openrouter-tag-extract -> Environment variables
    2. Verify OPENROUTER_TAG_MODEL is set (e.g., anthropic/claude-3-haiku, openai/gpt-4o-mini)
    3. Verify OPENROUTER_API_KEY is set (your OpenRouter API key from https://openrouter.ai/keys)
    4. Save environment variables
    5. Test Edge Function by calling it from your app (save a climb with notes)
  </how-to-verify>
  <resume-signal>Type "configured" or "env vars set" to continue</resume-signal>
</task>

</tasks>

<verification>
After completion:
1. Run "npx supabase db push" - confirm all three migrations applied without errors
2. Run "npx supabase functions deploy openrouter-tag-extract --no-verify-jwt" - confirm deployment successful
3. Verify OPENROUTER_TAG_MODEL is set in Supabase Dashboard
4. Verify OPENROUTER_API_KEY is set in Supabase Dashboard
5. Test Edge Function:
   - Save a climb with notes in the app
   - Verify no errors in browser console related to tag extraction
   - Check Supabase logs: Dashboard -> Edge Functions -> openrouter-tag-extract -> Logs
   - Verify climb.style_tags and climb.failure_reasons are populated after ~3-5 seconds
6. Verify quota tracking works:
   - Check user_limits table has tag_count incremented
   - After 50 climbs, verify 429 response is returned for next extraction
</verification>

<success_criteria>
Database migrations applied to production (tag_count, tag_extraction_api_usage, tags_extracted_at). Edge Function deployed and accessible. Environment variables configured (OPENROUTER_TAG_MODEL, OPENROUTER_API_KEY). Tag extraction works end-to-end on climb save.
</success_criteria>

<output>
After completion, create `.planning/phases/31-ai-tag-extraction-service/31-06-SUMMARY.md`
</output>
