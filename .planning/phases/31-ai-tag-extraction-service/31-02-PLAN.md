---
phase: 31-ai-tag-extraction-service
plan: 02
type: execute
wave: 2
depends_on:
  - 31-01
files_modified:
  - supabase/functions/openrouter-tag-extract/index.ts
  - supabase/functions/_shared/anonymize.ts
autonomous: true

must_haves:
  truths:
    - Edge Function validates JWT and extracts user_id
    - Edge Function checks tag_count quota before calling OpenRouter (50 climbs/day)
    - Edge Function calls OpenRouter API with structured JSON output
    - Edge Function validates response (3 max styles, 1-3 failure reasons, confidence >= 70)
    - Edge Function updates climbs table with extracted tags and tags_extracted_at
    - Edge Function tracks cost in tag_extraction_api_usage table
    - Edge Function returns immediately (non-blocking) with success response
    - PII anonymization removes gym/crag names and email/phone patterns
  artifacts:
    - path: supabase/functions/openrouter-tag-extract/index.ts
      provides: Tag extraction Edge Function
      contains: "openai.chat.completions.create"
      exports: ["POST handler"]
    - path: supabase/functions/_shared/anonymize.ts
      provides: PII anonymization utilities
      contains: "function anonymizeNotes"
  key_links:
    - from: "openrouter-tag-extract/index.ts"
      to: "user_limits"
      via: "increment_tag_count RPC call before API"
      pattern: "supabase\\.rpc\\('increment_tag_count'"
    - from: "openrouter-tag-extract/index.ts"
      to: "OpenRouter API"
      via: "openai.chat.completions.create"
      pattern: "response_format.*json_object"
    - from: "openrouter-tag-extract/index.ts"
      to: "climbs"
      via: "UPDATE with style_tags and failure_reasons arrays"
      pattern: "UPDATE.*climbs.*style_tags"
    - from: "openrouter-tag-extract/index.ts"
      to: "tag_extraction_api_usage"
      via: "INSERT with usage.cost from OpenRouter"
      pattern: "INSERT.*tag_extraction_api_usage.*cost_usd"
---

<objective>
Edge Function implementation for AI tag extraction - validates JWT, enforces quota, calls OpenRouter API with structured JSON, validates response, updates climb with tags, and tracks costs. Returns immediately (non-blocking) to avoid blocking save flow.

Purpose: Core backend service for EXTR-01, EXTR-02, EXTR-05, EXTR-06. Never blocks climb save - runs async after persist.
Output: Edge Function at supabase/functions/openrouter-tag-extract/index.ts.
</object>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/31-ai-tag-extraction-service/31-RESEARCH.md
@.planning/phases/31-ai-tag-extraction-service/31-CONTEXT.md
@.planning/REQUIREMENTS.md
@.planning/phases/31-ai-tag-extraction-service/31-01-SUMMARY.md

# Existing Edge Function patterns
@supabase/functions/openrouter-coach/index.ts
@supabase/functions/_shared/cors.ts
@src/lib/validation.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create PII anonymization utilities module</name>
  <files>supabase/functions/_shared/anonymize.ts</files>
  <action>
    Create supabase/functions/_shared/anonymize.ts with:

    1. anonymizeNotes(notes: string): string function that:
       - Returns notes if empty/null
       - Replaces gym names (Rock City, Planet Granite, etc.) with "indoor_gym"
       - Replaces crag names (Red Rocks, Yosemite, etc.) with "outdoor_crags"
       - Removes email patterns using regex: /\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}\b/g
       - Replaces with "[EMAIL_REMOVED]"
       - Removes phone patterns using regex: /\b\d{3}[-.]?\d{3}[-.]?\d{4}\b/g
       - Replaces with "[PHONE_REMOVED]"

    Follow the pattern from RESEARCH.md (lines 187-204).

    Export the function for use in openrouter-tag-extract.
  </action>
  <verify>
    Run: deno check supabase/functions/_shared/anonymize.ts
    Check: "import { anonymizeNotes } from 'npm:../_shared/anonymize.ts'" in Edge Function compiles
  </verify>
  <done>anonymizeNotes function exists and removes PII patterns</done>
</task>

<task type="auto">
  <name>Task 2: Create openrouter-tag-extract Edge Function</name>
  <files>supabase/functions/openrouter-tag-extract/index.ts</files>
  <action>
    Create supabase/functions/openrouter-tag-extract/index.ts with:

    1. Imports:
       - corsHeaders from supabase/functions/_shared/cors.ts
       - anonymizeNotes from supabase/functions/_shared/anonymize.ts
       - OpenAI from 'npm:openai@4'
       - createClient from 'npm:@supabase/supabase-js@2'
       - VALID_STYLES and VALID_FAILURE_REASONS from src/lib/validation.ts (copy constants if import doesn't work in Deno)

    2. Request body parsing:
       - Expects { climb_id: UUID, notes: string, user_id: UUID }
       - Returns 400 if missing fields

    3. JWT validation:
       - Validate Authorization header (Bearer token)
       - Extract user_id from token
       - Match user_id from token with user_id from body
       - Return 401 if invalid or mismatched

    4. Quota enforcement (from RESEARCH.md lines 143-173):
       - Query user_limits for tag_count and limit_date
       - Compare limit_date with CURRENT_DATE, reset to 0 if different day
       - Check if tag_count >= 50 (DAILY_TAG_LIMIT)
       - If quota exceeded: Return 429 with error message and limit info
       - Call increment_tag_count(user_id) BEFORE OpenRouter API call

    5. Token estimation and truncation (from RESEARCH.md lines 432-448):
       - estimateTokenCount(text: string): number function
       - Count words (split by whitespace, filter empty)
       - Estimate character-based: Math.ceil(text.length / 4)
       - Return max(wordCount, charBasedEstimate)
       - If estimatedTokens > 1000, truncate notes proportionally

    6. PII anonymization:
       - Call anonymizeNotes(notes) before sending to OpenRouter

    7. OpenRouter API call:
       - Use OPENROUTER_TAG_MODEL env var (no default)
       - Temperature: 0.2
       - response_format: { type: 'json_object' }
       - System prompt: "Extract climbing tags from notes. Return JSON with style_tags and failure_reasons arrays. Each tag must have name (enum) and confidence (0-100). Only include tags with confidence >= 70. Maximum 3 styles + 3 failure reasons. At least 1 failure reason required."
       - User message: `Notes: ${truncatedNotes}`

    8. Response validation (from RESEARCH.md lines 487-537):
       - validateTagResponse(content: string) function
       - Parse JSON, throw if invalid
       - Validate style_tags array (max 3 items)
       - Validate each style tag name in VALID_STYLES
       - Validate confidence is number 0-100
       - Validate failure_reasons array (1-3 items, min 1 required)
       - Validate each failure reason name in VALID_FAILURE_REASONS
       - Filter tags with confidence >= 70

    9. Retry logic (from RESEARCH.md lines 214-263):
       - MAX_RETRIES = 2
       - Loop for attempts 0 to MAX_RETRIES-1
       - Try API call and validation
       - On success: Update climb with tags, track cost, return { success: true }
       - On failure: Log warning, wait 1000ms * (attempt + 1) (exponential backoff)
       - If all retries fail: Return { success: true, tags_extracted: false, error: 'Tag extraction failed, you can add tags manually' }

    10. Update climb with tags:
        - UPDATE climbs SET style_tags = [...], failure_reasons = [...], tags_extracted_at = now() WHERE id = climb_id
        - Use valid tags from filtered response

    11. Track API usage (from RESEARCH.md lines 386-405):
        - INSERT into tag_extraction_api_usage with:
          - user_id, prompt_tokens, completion_tokens, total_tokens
          - cost_usd = usage.cost (from OpenRouter response)
          - model = tagModel
          - endpoint = 'openrouter-tag-extract'
          - time_window_start = now()
        - Log error if insert fails but continue

    12. Response handling:
        - Always return { success: true } (non-blocking)
        - If extraction failed after retries, include tags_extracted: false and error message
        - Include CORS headers
        - No streaming needed (simple JSON response)

    Follow patterns from openrouter-coach/index.ts for JWT validation, quota enforcement, and cost tracking.

    Create constants for:
    - VALID_STYLES: ['Slab', 'Vert', 'Overhang', 'Roof', 'Dyno', 'Crimp', 'Sloper', 'Pinch']
    - VALID_FAILURE_REASONS: ['Pumped', 'Finger Strength', 'Core', 'Power', 'Bad Feet', 'Body Position', 'Beta Error', 'Precision', 'Fear', 'Commitment', 'Focus']
    - DAILY_TAG_LIMIT = 50
    - MAX_TOKENS = 1000
    - CONFIDENCE_THRESHOLD = 70
    - MAX_STYLES = 3
    - MAX_FAILURE_REASONS = 3
    - MIN_FAILURE_REASONS = 1
  </action>
  <verify>
    Run: deno check supabase/functions/openrouter-tag-extract/index.ts
    Run: npx supabase functions deploy openrouter-tag-extract --no-verify-jwt
    Check: "curl -X POST http://localhost:54321/functions/v1/openrouter-tag-extract -H 'Authorization: Bearer <token>' -d '{"climb_id": "...", "notes": "test", "user_id": "..."}'" returns 200 or 429
  </verify>
  <done>Edge Function validates JWT, enforces quota, extracts tags with validation, updates climb, tracks costs, returns immediately</done>
</task>

</tasks>

<verification>
After completion:
1. Run "deno check supabase/functions/_shared/anonymize.ts" - no errors
2. Run "deno check supabase/functions/openrouter-tag-extract/index.ts" - no errors
3. Run "npx supabase functions deploy openrouter-tag-extract --no-verify-jwt" - deployment successful
4. Test with valid JWT: Should return { success: true } or quota exceeded message
5. Test quota enforcement: After 50 calls, should return 429 with "Daily quota reached" message
6. Test response validation: Send malformed JSON from LLM (mock), should retry twice then fail gracefully
7. Test PII anonymization: Call anonymizeNotes("Email: test@example.com Phone: 555-123-4567 at Rock City"), should return "[EMAIL_REMOVED] [PHONE_REMOVED] at indoor_gym"
</verification>

<success_criteria>
openrouter-tag-extract Edge Function deployed and functioning. Enforces 50 climbs/day quota, validates tags (confidence >= 70, max 3 styles, 1-3 failure reasons), tracks costs, and never blocks save flow.
</success_criteria>

<output>
After completion, create `.planning/phases/31-ai-tag-extraction-service/31-02-SUMMARY.md`
</output>
