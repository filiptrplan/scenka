---
phase: 31-ai-tag-extraction-service
plan: 04
type: execute
wave: 4
depends_on:
  - 31-03
files_modified:
  - src/components/ui/toast.ts
  - src/hooks/useTagExtractionFeedback.ts
  - src/pages/Logger.tsx
autonomous: true

must_haves:
  truths:
    - Toast notification shows when tag extraction fails (Edge Function error)
    - Toast notification shows when quota exceeded (429 response)
    - Toast notification shows when quota reached (hard limit)
    - Form shows daily quota indicator (X/50 used)
    - Error messages are user-friendly, not technical
    - All toast notifications use sonner library (project standard)
  artifacts:
    - path: src/hooks/useTagExtractionFeedback.ts
      provides: Tag extraction error feedback hook
      contains: "function useTagExtractionFeedback"
      exports: ["useTagExtractionFeedback"]
    - path: src/pages/Logger.tsx
      provides: Logger with quota indicator
      contains: "DAILY_TAG_LIMIT.*50"
    - path: src/components/ui/toast.ts
      provides: Toast notifications (if not already exists)
      contains: "toast\\(\\.\\.\\)"
  key_links:
    - from: "src/services/tagExtraction.ts"
      to: "src/hooks/useTagExtractionFeedback.ts"
      via: "Error handling triggers toast"
      pattern: "toast\\(\\.\\.\\)"
    - from: "src/hooks/useTagExtractionFeedback.ts"
      to: "src/pages/Logger.tsx"
      via: "Quota state displayed"
      pattern: "quotaCount.*DAILY_TAG_LIMIT"
---

<objective>
Error handling and user feedback - adds toast notifications for extraction failures and quota exceeded, displays daily quota indicator in logger form. Handles EXTR-08 (graceful failure with user notification).

Purpose: Provides user feedback when extraction fails (EXTR-08) and quota tracking visibility (EXTR-06). Prepares for Phase 32 (manual tag editing when extraction fails).
Output: Toast notifications for errors, quota indicator in logger form.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/31-ai-tag-extraction-service/31-RESEARCH.md
@.planning/phases/31-ai-tag-extraction-service/31-CONTEXT.md
@.planning/REQUIREMENTS.md
@.planning/phases/31-ai-tag-extraction-service/31-03-SUMMARY.md

# Existing UI patterns
@src/pages/Logger.tsx
@src/components/ui/toast.ts
@src/lib/constants.ts
@supabase/functions/openrouter-coach/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create tag extraction feedback hook</name>
  <files>src/hooks/useTagExtractionFeedback.ts</files>
  <action>
    Create src/hooks/useTagExtractionFeedback.ts with:

    1. useTagExtractionFeedback() hook that:

    2. State management:
       - quotaCount: number (0-50, from user_limits.tag_count)
       - isQuotaReached: boolean (quotaCount >= 50)
       - isLoading: boolean (initial load state)

    3. Fetch quota on mount:
       - Query user_limits table for tag_count
       - Use useQuery from @tanstack/react-query
       - Query key: ['tag-quota']
       - Handle errors gracefully (default to 0 if query fails)

    4. showExtractionError(errorType: string) function:
       - Takes errorType: 'api_error' | 'quota_exceeded' | 'network_error' | 'unknown'
       - Uses sonner toast (import { toast } from 'sonner')
       - Toast messages:
         - api_error: "Tag extraction failed. You can add tags manually."
         - quota_exceeded: "Daily quota reached - tags extracted tomorrow. Add manually in Settings."
         - network_error: "Tag extraction failed due to network. Check your connection."
         - unknown: "Tag extraction failed. You can add tags manually."
       - Toast variant: 'error' or 'warning'

    5. showQuotaReached() function:
       - Shows toast: "You've reached your daily tag extraction quota (50 climbs). Add tags manually or try again tomorrow."
       - Toast variant: 'info'

    6. Return object with:
       - quotaCount: number
       - isQuotaReached: boolean
       - isLoading: boolean
       - showExtractionError: (errorType: string) => void
       - showQuotaReached: () => void

    Import supabase client: import { supabase } from '@/lib/supabase'

    Import DAILY_TAG_LIMIT: import { DAILY_TAG_LIMIT } from '@/lib/constants'

    Follow Context.md decisions for toast messages.

    Export useTagExtractionFeedback function.
  </action>
  <verify>
    Run: pnpm typecheck - no TypeScript errors
    Check: "import { useTagExtractionFeedback } from '@/hooks/useTagExtractionFeedback'" in Logger.tsx compiles
  </verify>
  <done>useTagExtractionFeedback hook provides quota state and error toast functions</done>
</task>

<task type="auto">
  <name>Task 2: Wire extraction errors to toast in tagExtraction service</name>
  <files>src/services/tagExtraction.ts</files>
  <action>
    Modify src/services/tagExtraction.ts to add error toast notifications:

    1. Import toast from 'sonner' (or create local error emitter if toast not available in service layer)

    2. If toast not available in service layer (services shouldn't import UI):
       - Create error callback parameter in triggerTagExtraction
       - Or return error type from function for UI to handle

    3. Recommended approach: Return error type, let UI handle toasts
       - Change triggerTagExtraction to return Promise<{ success: boolean; errorType?: string }>
       - Map errors to error types:
         - 429 -> 'quota_exceeded'
         - Network errors -> 'network_error'
         - API errors -> 'api_error'
         - Unknown -> 'unknown'

    4. Update triggerTagExtraction signature:
       - triggerTagExtraction(climb: Climb, userId: string): Promise<{ success: boolean; errorType?: string }>

    5. Return success: true on successful invocation (even if extraction fails later, invocation succeeded)

    6. Return success: false with errorType if Edge Function invocation fails

    7. Log all errors as before

    Alternatively, if services can use toast (check existing patterns in codebase):
   - Import toast and call directly in catch blocks

    Check existing service patterns in climbs.ts, auth.ts, etc. to see if they import toast.

    If existing services don't import toast, use the return-value approach (better architecture).
  </action>
  <verify>
    Run: pnpm typecheck - no TypeScript errors
    Check: triggerTagExtraction returns correct type in climbs.ts usage
  </verify>
  <done>triggerTagExtraction returns error type for UI toast notifications</done>
</task>

<task type="auto">
  <name>Task 3: Add quota indicator and error handling to Logger</name>
  <files>src/pages/Logger.tsx</files>
  <action>
    Modify src/pages/Logger.tsx to:

    1. Import useTagExtractionFeedback hook from '@/hooks/useTagExtractionFeedback'

    2. Add hook to component:
       - const { quotaCount, isQuotaReached, isLoading, showExtractionError, showQuotaReached } = useTagExtractionFeedback()

    3. Add quota indicator in logger form:
       - Display "Tags extracted today: {quotaCount}/50"
       - Use small text, muted color (text-muted-foreground)
       - Place near submit button or at bottom of form
       - Show loading state if isLoading
       - Show warning color if isQuotaReached (text-amber-500 or similar)

    4. Handle extraction errors from triggerTagExtraction:
       - In climb save handler, after triggerTagExtraction call:
       - Check return value: const { success, errorType } = await triggerTagExtraction(climb, userId).catch(...)
       - If !success, call showExtractionError(errorType || 'unknown')
       - Handle promise rejection: triggerTagExtraction(...).catch(err => showExtractionError('api_error'))

    5. Show quota reached warning if isQuotaReached:
       - Optional: Call showQuotaReached() once when component mounts and quota is reached
       - Or show visual indicator only (less intrusive)

    6. Style:
       - Quota indicator: small text, muted or warning color depending on state
       - Placement: non-intrusive, below submit button or at form bottom
       - Responsive: visible on mobile (don't hide)

    Follow existing Logger.tsx patterns for UI elements.

    Import DAILY_TAG_LIMIT if needed: import { DAILY_TAG_LIMIT } from '@/lib/constants'

    Ensure quota indicator doesn't block form submission (informational only).
  </action>
  <verify>
    Run: pnpm typecheck - no TypeScript errors
    Run: pnpm lint - no errors
    Visual check: Quota indicator displays in logger form
    Test: Trigger extraction error, verify toast appears
  </verify>
  <done>Logger shows quota indicator (X/50) and displays toast on extraction errors</done>
</task>

<task type="auto">
  <name>Task 4: Ensure toast component exists (if not already)</name>
  <files>src/components/ui/toast.ts</files>
<action>
    Check if src/components/ui/toast.ts exists:

    1. If exists: No changes needed (sonner already set up)

    2. If not exists:
       - Create src/components/ui/toast.ts
       - Set up sonner Toaster component
       - Follow shadcn/ui sonner pattern
       - Import { Toaster } from 'sonner'
       - Export Toaster component
       - Add to app layout (likely src/App.tsx or src/main.tsx)

    Check existing codebase for sonner usage in other components (search for "import.*from 'sonner'").

    If sonner not in package.json: Add to dependencies and install (but project likely already has it).
  </action>
  <verify>
  Run: pnpm typecheck - no errors
  Check: "import { toast } from 'sonner'" works in useTagExtractionFeedback.ts
  </verify>
  <done>sonner toast available for error notifications</done>
</task>

</tasks>

<verification>
After completion:
1. Run "pnpm typecheck" - no TypeScript errors
2. Run "pnpm lint" - no lint errors
3. Visual check - Logger form shows quota indicator (e.g., "Tags extracted today: 5/50")
4. Test quota indicator:
   - Query user_limits table, verify tag_count matches UI
   - Reset quota to 49, save climb, verify UI shows 50/50
   - Verify indicator turns warning color at 50/50
5. Test extraction failure toast:
   - Mock Edge Function error, save climb
   - Verify toast appears: "Tag extraction failed. You can add tags manually."
   - Verify toast color/style (error/warning)
6. Test quota exceeded toast:
   - Mock 429 response from Edge Function, save climb
   - Verify toast appears: "Daily quota reached - tags extracted tomorrow."
7. Test network error toast:
   - Disconnect network, save climb
   - Verify toast appears: "Tag extraction failed due to network."
8. Verify toasts don't block form or cause layout shifts
</verification>

<success_criteria>
Toast notifications appear for extraction failures (api_error, quota_exceeded, network_error). Logger displays quota indicator (X/50). User informed when extraction fails (EXTR-08).
</success_criteria>

<output>
After completion, create `.planning/phases/31-ai-tag-extraction-service/31-04-SUMMARY.md`
</output>
