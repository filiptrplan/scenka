---
phase: 31-ai-tag-extraction-service
plan: 04
type: execute
wave: 4
depends_on:
  - 31-03
files_modified:
  - src/services/tagExtraction.ts
  - src/services/climbs.ts
  - src/hooks/useTagExtractionFeedback.ts
  - src/pages/Logger.tsx
autonomous: true

must_haves:
  truths:
    - Toast notification shows when tag extraction fails (Edge Function error)
    - Toast notification shows when quota exceeded (429 response)
    - Toast notification shows when quota reached (hard limit)
    - Form shows daily quota indicator (X/50 used)
    - Error messages are user-friendly, not technical
    - All toast notifications use sonner library (project standard)
    - Service layer returns error type object, UI layer handles toast display (clean architecture)
  artifacts:
    - path: src/services/tagExtraction.ts
      provides: Tag extraction with error type return
      contains: "Promise<{ success: boolean; errorType?: string }>"
      exports: ["triggerTagExtraction"]
    - path: src/services/climbs.ts
      provides: Climb logging with tag extraction trigger and error handling
      contains: "triggerTagExtraction.*then\\(.*errorType"
    - path: src/hooks/useTagExtractionFeedback.ts
      provides: Tag extraction error feedback hook
      contains: "function showExtractionError"
      exports: ["useTagExtractionFeedback"]
    - path: src/pages/Logger.tsx
      provides: Logger with quota indicator and error toast display
      contains: "showExtractionError\\(errorType\\)"
  key_links:
    - from: "src/services/tagExtraction.ts"
      to: "src/hooks/useTagExtractionFeedback.ts"
      via: "Service returns error type, hook calls toast"
      pattern: "errorType.*quota_exceeded|api_error|network_error"
    - from: "src/services/climbs.ts"
      to: "src/services/tagExtraction.ts"
      via: "Service trigger returns error type object"
      pattern: "triggerTagExtraction\\(.*\\).then\\(.*errorType"
    - from: "src/pages/Logger.tsx"
      to: "src/hooks/useTagExtractionFeedback.ts"
      via: "Component calls showExtractionError based on error type"
      pattern: "showExtractionError\\(result.errorType\\)"
---

<objective>
Error handling and user feedback - adds toast notifications for extraction failures and quota exceeded, displays daily quota indicator in logger form. Architecture: service layer returns error type object, UI layer handles toast display (clean separation). Handles EXTR-08 (graceful failure with user notification).

Purpose: Provides user feedback when extraction fails (EXTR-08) and quota tracking visibility (EXTR-06). Prepares for Phase 32 (manual tag editing when extraction fails).
Output: Toast notifications for errors, quota indicator in logger form.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/31-ai-tag-extraction-service/31-RESEARCH.md
@.planning/phases/31-ai-tag-extraction-service/31-CONTEXT.md
@.planning/REQUIREMENTS.md
@.planning/phases/31-ai-tag-extraction-service/31-03-SUMMARY.md

# Existing UI patterns
@src/pages/Logger.tsx
@src/services/tagExtraction.ts
@src/services/climbs.ts
@src/hooks/useTagExtractionFeedback.ts
@src/components/ui/toast.ts
@src/lib/constants.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Modify tagExtraction service to return error type object</name>
  <files>src/services/tagExtraction.ts</files>
  <action>
    Modify src/services/tagExtraction.ts to return error type object (clean architecture - no toast imports in service layer):

    1. Update triggerTagExtraction return type:
       - Change from: Promise<void>
       - Change to: Promise<{ success: boolean; errorType?: 'quota_exceeded' | 'api_error' | 'network_error' | 'unknown' }>

    2. Update function signature:
       - triggerTagExtraction(climb: Climb, userId: string): Promise<{ success: boolean; errorType?: string }>

    3. In error handling catch block:
       - Map errors to error types:
         - 429 -> errorType: 'quota_exceeded'
         - Network errors -> errorType: 'network_error'
         - API errors (5xx) -> errorType: 'api_error'
         - Other errors -> errorType: 'unknown'

    4. Return values:
       - Return { success: true } on successful Edge Function invocation (even if extraction fails later)
       - Return { success: false, errorType: '...' } on Edge Function invocation failure
       - Return { success: false, errorType: '...' } on network errors

    5. Log all errors as before (logging stays in service layer)

    6. IMPORTANT: Do NOT import toast in service layer - UI handles toasts based on returned error type

    Example pattern:
    ```typescript
    try {
      const { error } = await supabase.functions.invoke('openrouter-tag-extract', { ... })

      if (error) {
        const errorType = error.status === 429 ? 'quota_exceeded' : 'api_error'
        return { success: false, errorType }
      }

      return { success: true }
    } catch (err) {
      const errorType = err.message?.includes('fetch') ? 'network_error' : 'unknown'
      return { success: false, errorType }
    }
    ```

    Update climbs.ts import of this function accordingly.
  </action>
  <verify>
    Run: pnpm typecheck - no TypeScript errors
    Check: triggerTagExtraction returns correct type { success: boolean; errorType?: string }
  </verify>
  <done>triggerTagExtraction returns error type object for UI to handle</done>
</task>

<task type="auto">
  <name>Task 2: Update climbs service to handle error type</name>
  <files>src/services/climbs.ts</files>
  <action>
    Modify src/services/climbs.ts to handle error type returned from triggerTagExtraction:

    1. In climb save handler (after successful insert):
       - Change from: `triggerTagExtraction(climb, userId).catch(...)`
       - Change to: Handle the returned error type object

    2. Pattern:
       ```typescript
       // Save climb first (must succeed)
       const { data, error } = await supabase.from('climbs').insert(climbData).select().single()

       if (error) throw error

       // Trigger tag extraction AFTER save succeeds (non-blocking)
       triggerTagExtraction(data, userId)
         .then(result => {
           if (!result.success && result.errorType) {
             // Store error type for UI to handle (could use global state or callback)
             // For now, just log - UI will handle via quota query
             console.log(`Tag extraction failed: ${result.errorType}`)
           }
         })
         .catch(err => {
           console.error('Failed to trigger tag extraction:', err)
         })

       return data
       ```

    3. Note: The actual toast display happens in Logger.tsx component (Task 4), not in service layer

    4. Ensure triggerTagExtraction is NOT awaited (fire-and-forget pattern)

    5. Keep logging for debugging

    The service layer only stores or passes error information - UI layer handles user feedback.
  </action>
  <verify>
    Run: pnpm typecheck - no TypeScript errors
    Check: climbs.ts does not import toast (UI layer handles toasts)
  </verify>
  <done>climbs service handles error type object without importing toast</done>
</task>

<task type="auto">
  <name>Task 3: Create tag extraction feedback hook</name>
  <files>src/hooks/useTagExtractionFeedback.ts</files>
  <action>
    Create src/hooks/useTagExtractionFeedback.ts with:

    1. useTagExtractionFeedback() hook that:

    2. State management:
       - quotaCount: number (0-50, from user_limits.tag_count)
       - isQuotaReached: boolean (quotaCount >= 50)
       - isLoading: boolean (initial load state)

    3. Fetch quota on mount:
       - Query user_limits table for tag_count
       - Use useQuery from @tanstack/react-query
       - Query key: ['tag-quota']
       - Handle errors gracefully (default to 0 if query fails)

    4. showExtractionError(errorType: string) function:
       - Takes errorType: 'api_error' | 'quota_exceeded' | 'network_error' | 'unknown'
       - Imports toast from 'sonner' (UI layer can import toast)
       - Toast messages:
         - api_error: "Tag extraction failed. You can add tags manually."
         - quota_exceeded: "Daily quota reached - tags extracted tomorrow. Add manually in Settings."
         - network_error: "Tag extraction failed due to network. Check your connection."
         - unknown: "Tag extraction failed. You can add tags manually."
       - Toast variant: 'error' or 'warning'

    5. showQuotaReached() function:
       - Shows toast: "You've reached your daily tag extraction quota (50 climbs). Add tags manually or try again tomorrow."
       - Toast variant: 'info'

    6. Return object with:
       - quotaCount: number
       - isQuotaReached: boolean
       - isLoading: boolean
       - showExtractionError: (errorType: string) => void
       - showQuotaReached: () => void

    Import supabase client: import { supabase } from '@/lib/supabase'

    Import DAILY_TAG_LIMIT: import { DAILY_TAG_LIMIT } from '@/lib/constants'

    Follow Context.md decisions for toast messages.

    Export useTagExtractionFeedback function.
  </action>
  <verify>
    Run: pnpm typecheck - no TypeScript errors
    Check: "import { useTagExtractionFeedback } from '@/hooks/useTagExtractionFeedback'" in Logger.tsx compiles
  </verify>
  <done>useTagExtractionFeedback hook provides quota state and error toast functions</done>
</task>

<task type="auto">
  <name>Task 4: Add quota indicator and error handling to Logger</name>
  <files>src/pages/Logger.tsx</files>
  <action>
    Modify src/pages/Logger.tsx to:

    1. Import useTagExtractionFeedback hook from '@/hooks/useTagExtractionFeedback'

    2. Add hook to component:
       - const { quotaCount, isQuotaReached, isLoading, showExtractionError, showQuotaReached } = useTagExtractionFeedback()

    3. Add quota indicator in logger form:
       - Display "Tags extracted today: {quotaCount}/50"
       - Use small text, muted color (text-muted-foreground)
       - Place near submit button or at bottom of form
       - Show loading state if isLoading
       - Show warning color if isQuotaReached (text-amber-500 or similar)

    4. Handle extraction errors from triggerTagExtraction:
       - In climb save handler, after triggerTagExtraction call:
       - Check for quota exceeded via isQuotaReached state (from hook)
       - If quota is reached after save, call showQuotaReached()
       - Use query invalidation to refresh quota after save

    5. Show quota reached warning if isQuotaReached:
       - Optional: Call showQuotaReached() once when component mounts and quota is reached
       - Or show visual indicator only (less intrusive)

    6. Style:
       - Quota indicator: small text, muted or warning color depending on state
       - Placement: non-intrusive, below submit button or at form bottom
       - Responsive: visible on mobile (don't hide)

    Follow existing Logger.tsx patterns for UI elements.

    Import DAILY_TAG_LIMIT if needed: import { DAILY_TAG_LIMIT } from '@/lib/constants'

    Ensure quota indicator doesn't block form submission (informational only).
  </action>
  <verify>
    Run: pnpm typecheck - no TypeScript errors
    Run: pnpm lint - no errors
    Visual check: Quota indicator displays in logger form
    Test: Trigger extraction error scenario, verify toast appears
  </verify>
  <done>Logger shows quota indicator (X/50) and displays toast on extraction errors</done>
</task>

<task type="auto">
  <name>Task 5: Ensure toast component exists (if not already)</name>
  <files>src/components/ui/toast.ts</files>
  <action>
    Check if src/components/ui/toast.ts exists:

    1. If exists: No changes needed (sonner already set up)

    2. If not exists:
       - Create src/components/ui/toast.ts
       - Set up sonner Toaster component
       - Follow shadcn/ui sonner pattern
       - Import { Toaster } from 'sonner'
       - Export Toaster component
       - Add to app layout (likely src/App.tsx or src/main.tsx)

    Check existing codebase for sonner usage in other components (search for "import.*from 'sonner'").

    If sonner not in package.json: Add to dependencies and install (but project likely already has it).
  </action>
  <verify>
    Run: pnpm typecheck - no errors
    Check: "import { toast } from 'sonner'" works in useTagExtractionFeedback.ts
  </verify>
  <done>sonner toast available for error notifications</done>
</task>

</tasks>

<verification>
After completion:
1. Run "pnpm typecheck" - no TypeScript errors
2. Run "pnpm lint" - no lint errors
3. Architecture check - service layer (tagExtraction.ts) does NOT import toast
4. Architecture check - UI layer (useTagExtractionFeedback.ts) DOES import toast and handles display
5. Visual check - Logger form shows quota indicator (e.g., "Tags extracted today: 5/50")
6. Test quota indicator:
   - Query user_limits table, verify tag_count matches UI
   - Reset quota to 49, save climb, verify UI shows 50/50
   - Verify indicator turns warning color at 50/50
7. Test extraction failure toast:
   - Mock Edge Function error, save climb
   - Verify toast appears: "Tag extraction failed. You can add tags manually."
   - Verify toast color/style (error/warning)
8. Test quota exceeded toast:
   - Mock 429 response from Edge Function, save climb
   - Verify toast appears: "Daily quota reached - tags extracted tomorrow."
9. Test network error toast:
   - Disconnect network, save climb
   - Verify toast appears: "Tag extraction failed due to network."
10. Verify toasts don't block form or cause layout shifts
</verification>

<success_criteria>
Toast notifications appear for extraction failures (api_error, quota_exceeded, network_error). Logger displays quota indicator (X/50). User informed when extraction fails (EXTR-08). Clean architecture: service returns error type, UI handles toasts.
</success_criteria>

<output>
After completion, create `.planning/phases/31-ai-tag-extraction-service/31-04-SUMMARY.md`
</output>
