---
phase: 31-ai-tag-extraction-service
plan: 03
type: execute
wave: 3
depends_on:
  - 31-02
files_modified:
  - src/services/tagExtraction.ts
  - src/services/climbs.ts
  - src/lib/constants.ts
autonomous: true

must_haves:
  truths:
    - Climb save triggers async tag extraction after successful persist
    - Client service calls openrouter-tag-extract Edge Function
    - Tag extraction does NOT block climb save response (non-blocking)
    - Edge Function invocation errors don't prevent climb save
    - Service handles quota exceeded (429) gracefully
    - Service handles extraction failures gracefully
  artifacts:
    - path: src/services/tagExtraction.ts
      provides: Tag extraction client service
      contains: "function triggerTagExtraction"
      exports: ["triggerTagExtraction"]
    - path: src/services/climbs.ts
      provides: Climb logging with tag extraction trigger
      contains: "triggerTagExtraction.*after.*insert"
    - path: src/lib/constants.ts
      provides: Tag extraction limits
      contains: "DAILY_TAG_LIMIT.*50"
  key_links:
    - from: "src/services/climbs.ts"
      to: "src/services/tagExtraction.ts"
      via: "triggerTagExtraction call after save"
      pattern: "triggerTagExtraction\\(climb\\)"
    - from: "src/services/tagExtraction.ts"
      to: "supabase/functions/openrouter-tag-extract"
      via: "supabase.functions.invoke"
      pattern: "functions.invoke\\('openrouter-tag-extract'"
---

<objective>
Client service and wiring - creates tag extraction trigger after climb save, ensures non-blocking async execution, handles quota exceeded and extraction failures gracefully. Climbs save first, extraction happens after.

Purpose: Satisfies EXTR-03 (async extraction) and EXTR-04 (climb saves immediately, tags appear later). Prepares for Phase 32 (display/edit) by extracting tags.
Output: Tag extraction service wired into climb save flow.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/31-ai-tag-extraction-service/31-RESEARCH.md
@.planning/phases/31-ai-tag-extraction-service/31-CONTEXT.md
@.planning/REQUIREMENTS.md
@.planning/phases/31-ai-tag-extraction-service/31-02-SUMMARY.md

# Existing services reference
@src/services/climbs.ts
@src/lib/constants.ts
@supabase/functions/_shared/cors.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create tag extraction client service</name>
  <files>src/services/tagExtraction.ts</files>
  <action>
    Create src/services/tagExtraction.ts with:

    1. Constants:
       - DAILY_TAG_LIMIT = 50
       - TAG_EXTRACTION_TIMEOUT_MS = 5000 (fail-fast for Edge Function invocation, not API call)

    2. triggerTagExtraction(climb: Climb, userId: string): Promise<void> function that:
       - Takes climb object (must have id, notes) and userId
       - Validates climb.id and climb.notes exist
       - Calls supabase.functions.invoke('openrouter-tag-extract') with body:
         - climb_id: climb.id
         - notes: climb.notes
         - user_id: userId
       - Uses supabase client (import from src/lib/supabase.ts)

    3. Error handling:
       - Catch all errors from Edge Function invocation
       - Log error with context (climb_id, error message)
       - Do NOT throw - extraction failure shouldn't break climb save
       - Handle specific cases:
         - 429 (quota exceeded): Log "Quota exceeded for user", user informed via toast in Plan 04
         - 401 (unauthorized): Log "Unauthorized tag extraction request"
         - Network errors: Log "Network error triggering extraction"
         - Other errors: Log with error message

    4. Return type: Promise<void> (fire-and-forget pattern)

    Follow pattern from RESEARCH.md (lines 75-99) for async, non-blocking extraction.

    Export triggerTagExtraction function.

    Import supabase client: import { supabase } from '@/lib/supabase'

    Import type: import type { Climb } from '@/types'
  </action>
  <verify>
    Run: pnpm typecheck - no TypeScript errors
    Check: "import { triggerTagExtraction } from '@/services/tagExtraction'" in climbs.ts compiles
  </verify>
  <done>triggerTagExtraction function exists and calls Edge Function without blocking</done>
</task>

<task type="auto">
  <name>Task 2: Wire tag extraction into climb save flow</name>
  <files>src/services/climbs.ts</files>
  <action>
    Modify src/services/climbs.ts to:

    1. Import triggerTagExtraction from '@/services/tagExtraction'

    2. Find the climb save/insert function (likely logClimb or createClimb)

    3. After successful climb insert:
       - Extract climb object from response (data[0] or similar)
       - Extract userId (from auth or parameter)
       - Call triggerTagExtraction(climb, userId) with .catch() for error handling
       - Do NOT await triggerTagExtraction (fire-and-forget)

    4. Pattern:
       ```typescript
       // Save climb
       const { data, error } = await supabase.from('climbs').insert(climbData).select().single()

       if (error) throw error

       // Trigger tag extraction AFTER save succeeds (non-blocking)
       triggerTagExtraction(data, userId).catch(err => {
         console.error('Failed to trigger tag extraction:', err)
         // Continue - extraction failure doesn't break climb save
       })

       return data
       ```

    5. Ensure triggerTagExtraction is only called if:
       - Climb has notes (skip if empty notes)
       - Climb saved successfully (check for error first)

    6. Do NOT block save flow - return climb immediately after triggerTagExtraction call

    Follow pattern from RESEARCH.md (lines 75-99).

    Make sure to import the Climb type if needed: import type { Climb } from '@/types'
  </action>
  <verify>
    Run: pnpm typecheck - no TypeScript errors
    Run: pnpm lint - no errors
    Test: Trigger climb save, check console for "Triggered tag extraction for climb:" log
  </verify>
  <done>Tag extraction triggers after successful climb save without blocking</done>
</task>

<task type="auto">
  <name>Task 3: Add tag extraction constants to lib/constants</name>
  <files>src/lib/constants.ts</files>
  <action>
    Modify src/lib/constants.ts to add:

    1. DAILY_TAG_LIMIT = 50

    2. TAG_EXTRACTION_TIMEOUT_MS = 5000 (Edge Function invocation timeout, not API call timeout)

    3. (Optional) Add comment: "Tag extraction happens async after climb save (EXTR-03)"

    Export constants for use in UI components (Plan 04).

    Maintain existing constant format and organization.
  </action>
  <verify>
    Run: pnpm typecheck - no TypeScript errors
    Check: "import { DAILY_TAG_LIMIT } from '@/lib/constants'" compiles
  </verify>
  <done>DAILY_TAG_LIMIT and TAG_EXTRACTION_TIMEOUT_MS constants available for UI use</done>
</task>

</tasks>

<verification>
After completion:
1. Run "pnpm typecheck" - no TypeScript errors
2. Run "pnpm lint" - no lint errors
3. Test climb save:
   - Save climb with notes
   - Verify climb saves immediately (UI shows climb)
   - Check browser console for "Triggered tag extraction for climb: ..." log
   - Verify Edge Function called (check Supabase logs or test locally)
4. Test extraction failure:
   - Disable Edge Function (or use invalid API key)
   - Save climb with notes
   - Verify climb still saves successfully
   - Check console for extraction error log
   - Verify UI shows climb (no blocking behavior)
5. Test quota handling (mock 429 response):
   - Mock 429 response from Edge Function
   - Save climb
   - Verify climb saves
   - Check console for "Quota exceeded" log
   - (Plan 04 will add toast notification)
</verification>

<success_criteria>
Climb save triggers async tag extraction. Extraction does NOT block save. Extraction failures don't prevent climb save. Quota exceeded handled gracefully.
</success_criteria>

<output>
After completion, create `.planning/phases/31-ai-tag-extraction-service/31-03-SUMMARY.md`
</output>
