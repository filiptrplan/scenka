---
phase: 25-user-climbing-context-for-prompts
plan: 04
type: execute
wave: 3
depends_on: [25-03]
files_modified:
  - supabase/functions/openrouter-coach/index.ts
  - supabase/functions/openrouter-chat/index.ts
  - supabase/functions/_shared/system-prompt.ts
autonomous: true
user_setup:
  - service: supabase
    why: "Deploy updated Edge Functions with climbing context integration"
    env_vars: []
    dashboard_config:
      - task: "Deploy openrouter-coach function"
        location: "Run: supabase functions deploy openrouter-coach"
      - task: "Deploy openrouter-chat function"
        location: "Run: supabase functions deploy openrouter-chat"

must_haves:
  truths:
    - "Coach Edge Function accepts climbing_context in request body"
    - "Coach Edge Function integrates climbing_context into user prompt"
    - "Chat Edge Function accepts climbing_context in request body"
    - "Chat Edge Function passes climbing_context to system prompt"
    - "System prompt includes climbing context section when provided"
  artifacts:
    - path: "supabase/functions/openrouter-coach/index.ts"
      provides: "Coach Edge Function with climbing context"
      contains: "climbing_context?: string | null"
    - path: "supabase/functions/openrouter-chat/index.ts"
      provides: "Chat Edge Function with climbing context"
      contains: "climbing_context?: string | null"
    - path: "supabase/functions/_shared/system-prompt.ts"
      provides: "Shared system prompt with context injection"
      contains: "climbingContext?: string | null"
  key_links:
    - from: "openrouter-coach RequestBody"
      to: "buildUserPrompt()"
      via: "function parameter"
      pattern: "climbingContext\\?: string"
    - from: "buildUserPrompt()"
      to: "user prompt string"
      via: "string concatenation"
      pattern: "User's Climbing Context:"
    - from: "openrouter-chat RequestBody"
      to: "getChatSystemPrompt()"
      via: "function argument"
      pattern: "getChatSystemPrompt\\(.*climbing_context"
---

<objective>
Integrate climbing context into both Edge Functions and shared system prompt module.

Purpose: Allow AI coach to use user-provided climbing context for more personalized recommendations and chat responses.
Output: Updated Edge Functions and system prompt that accept and use climbing_context.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/RESEARCH.md
@supabase/functions/openrouter-coach/index.ts
@supabase/functions/openrouter-chat/index.ts
@supabase/functions/_shared/system-prompt.ts
@src/services/coach.ts
</context>

<tasks>

<task type="auto">
  <name>Update system prompt module to accept climbing_context</name>
  <files>supabase/functions/_shared/system-prompt.ts</files>
  <action>
  Update getChatSystemPrompt() function signature:
  1. Add climbingContext parameter: function getChatSystemPrompt(patterns_data?: Record<string, unknown>, climbingContext?: string | null)
  2. Add climbing context section after User Profile section:
     if (climbingContext && climbingContext.trim().length > 0) {
       prompt += '\n\nUser Context:\n'
       prompt += climbingContext.trim() + '\n'
     }

  Place BEFORE "Provide helpful, concise answers..." footer instruction.
  </action>
  <verify>
  grep -q "climbingContext" supabase/functions/_shared/system-prompt.ts
  </verify>
  <done>
  getChatSystemPrompt() accepts climbingContext parameter and includes it in system prompt
  </done>
</task>

<task type="auto">
  <name>Update coach Edge Function to use climbing_context</name>
  <files>supabase/functions/openrouter-coach/index.ts</files>
  <action>
  Update openrouter-coach/index.ts:
  1. Add climbing_context to RequestBody interface: climbing_context?: string | null
  2. Add climbingContext parameter to buildUserPrompt() function
  3. In buildUserPrompt(), add climbing context section after User Profile section:
     if (climbingContext && climbingContext.trim().length > 0) {
       prompt += `\nUser's Climbing Context:\n${climbingContext.trim()}\n`
     }
  4. Pass body.climbing_context to buildUserPrompt() when calling it
  5. Add climbing_context to request body validation (optional field, no error if missing)

  Place climbing context section AFTER "Preferred grade scale" line and BEFORE "Failure Patterns" section.
  </action>
  <verify>
  grep -q "climbing_context" supabase/functions/openrouter-coach/index.ts
  </verify>
  <done>
  Coach Edge Function accepts climbing_context and integrates it into user prompt
  </done>
</task>

<task type="auto">
  <name>Update chat Edge Function to use climbing_context</name>
  <files>supabase/functions/openrouter-chat/index.ts</files>
  <action>
  Update openrouter-chat/index.ts:
  1. Add climbing_context to RequestBody interface: climbing_context?: string | null
  2. Pass body.climbing_context to getChatSystemPrompt() call
  3. Add climbing_context to request body validation (optional field, no error if missing)

  The climbing_context is now integrated into the system prompt via getChatSystemPrompt() from Task 1.
  </action>
  <verify>
  grep -q "climbing_context" supabase/functions/openrouter-chat/index.ts
  </verify>
  <done>
  Chat Edge Function accepts climbing_context and passes to system prompt
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Edge Functions updated with climbing context integration</what-built>
  <how-to-verify>
  1. Deploy Edge Functions:
     - supabase functions deploy openrouter-coach
     - supabase functions deploy openrouter-chat
  2. Test coach recommendations:
     - Navigate to coach page
     - Click "Regenerate" button
     - Verify recommendations include references to user's climbing context (if provided)
  3. Test chat:
     - Navigate to coach chat
     - Send message about climbing goals
     - Verify chat responses acknowledge user's climbing context (if provided)
  4. Test without context:
     - Set climbing_context to empty in settings
     - Verify coach and chat still work normally (graceful fallback)
  </how-to-verify>
  <resume-signal>Type "approved" if climbing context is integrated into both coach recommendations and chat responses</resume-signal>
</task>

</tasks>

<verification>
After deployment:
- Coach Edge Function accepts climbing_context in request
- Chat Edge Function accepts climbing_context in request
- System prompt includes "User Context:" section when climbing_context provided
- Recommendations and chat responses use climbing context when available
- No errors when climbing_context is null/undefined
</verification>

<success_criteria>
1. Edge Functions deployed successfully
2. Coach recommendations reference user's climbing context when provided
3. Chat responses reference user's climbing context when provided
4. Functions work correctly without climbing_context (backward compatible)
5. System prompt includes context in proper position (after system instructions, before patterns_data)
</success_criteria>

<output>
After completion, create `.planning/phases/25-user-climbing-context-for-prompts/25-04-SUMMARY.md`
</output>
