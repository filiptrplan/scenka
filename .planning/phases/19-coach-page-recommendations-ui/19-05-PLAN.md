---
phase: 19-coach-page-recommendations-ui
plan: 05
type: execute
wave: 3
depends_on: [19-02, 19-03]
files_modified: []
autonomous: true
must_haves:
  truths:
    - useCoachRecommendations hook has 24-hour staleTime for offline caching
    - useCoachRecommendations hook has 7-day gcTime for cache retention
    - Recommendations display cached data when offline
    - No API call is made when cache is fresh (<24h old)
    - User sees "Loading..." then cached data on slow network
    - TanStack Query handles cache invalidation after regeneration
  artifacts:
    - path: src/hooks/useCoach.ts
      provides: useCoachRecommendations with caching
      contains: "staleTime: 24 * 60 * 60 * 1000", "gcTime: 7 * 24 * 60 * 60 * 1000"
  key_links:
    - from: "useCoachRecommendations"
      to: "TanStack Query cache"
      via: "staleTime configuration"
      pattern: "staleTime: 24 \\* 60 \\* 60 \\* 1000"
    - from: "generateRecommendations.onSuccess"
      to: "cache invalidation"
      via: "queryClient.invalidateQueries"
      pattern: "invalidateQueries.*coachKeys\\.currentRecommendations"
---

<objective>
Verify offline caching of last recommendations is working
Purpose: Confirm TanStack Query caching configuration enables offline support with 24h cache
Output: Confirmed that recommendations persist offline and cache invalidation works correctly
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/19-coach-page-recommendations-ui/19-RESEARCH.md

@src/hooks/useCoach.ts
@src/services/coach.ts
</context>

<tasks>

<task type="auto">
  <name>Verify useCoachRecommendations caching configuration</name>
<files>src/hooks/useCoach.ts</files>
<action>
Review and verify the useCoachRecommendations hook has correct caching:

1. Read src/hooks/useCoach.ts and locate the useCoachRecommendations function

2. Verify the query configuration includes:
   - staleTime: 24 * 60 * 60 * 1000 (24 hours)
   - gcTime: 7 * 24 * 60 * 60 * 1000 (7 days)

3. Verify the queryKey uses the pattern:
   queryKey: coachKeys.currentRecommendations()
   OR
   queryKey: ['coach', 'recommendations', 'current']

4. Verify the queryFn properly handles Supabase and auth:
   - Checks if supabase is configured
   - Gets authenticated user
   - Calls getLatestRecommendations(user.id)

5. Document the caching behavior:
   - staleTime: Data is fresh for 24 hours, no refetch needed
   - gcTime: Cache persists for 7 days before garbage collection
   - Offline: Shows cached data immediately if offline

This task is primarily verification since the caching was implemented in Phase 18-05. The goal is to confirm it exists and is correctly configured.
  </action>
  <verify>
pnpm typecheck passes
</verify>
  <done>
useCoachRecommendations verified to have 24h staleTime and 7d gcTime for offline caching
</done>
</task>

<task type="auto">
  <name>Verify cache invalidation on regeneration</name>
<files>src/hooks/useCoach.ts</files>
<action>
Review and verify the useGenerateRecommendations hook properly invalidates cache:

1. Locate the useGenerateRecommendations function in src/hooks/useCoach.ts

2. Verify the onSuccess callback invalidates the recommendations query:
   onSuccess: () => {
     void queryClient.invalidateQueries({
       queryKey: coachKeys.currentRecommendations(),
     })
   }

3. Confirm the mutationFn calls generateRecommendations from coach.ts service

4. Document the cache invalidation flow:
   - User clicks "Regenerate Recommendations"
   - mutation.mutate() calls generateRecommendations service
   - On success, queryClient.invalidateQueries invalidates the cache
   - useCoachRecommendations automatically refetches fresh data
   - UI updates with new recommendations

This ensures that after regeneration, the user sees the updated recommendations, not stale cached data.
  </action>
  <verify>
pnpm typecheck passes
</verify>
  <done>
useGenerateRecommendations verified to invalidate cache on success
</done>
</task>

<task type="auto">
  <name>Document caching behavior and offline support</name>
<files>src/hooks/useCoach.ts</files>
<action>
Add inline documentation comments to explain the caching behavior:

1. Add comment above staleTime explaining the offline support:
   // 24 hours - show last cached recommendations, enable offline support

2. Add comment above gcTime explaining cache retention:
   // 7 days - persist cache for a week before garbage collection

3. Add comment above onSuccess explaining cache invalidation:
   // Invalidate recommendations cache to fetch fresh data after regeneration

Example of documented code:
export function useCoachRecommendations() {
  return useQuery({
    queryKey: coachKeys.currentRecommendations(),
    queryFn: async () => { ... },
    staleTime: 24 * 60 * 60 * 1000, // 24 hours - show last cached recommendations, enable offline support
    gcTime: 7 * 24 * 60 * 60 * 1000, // 7 days - persist cache for a week before garbage collection
  })
}

export function useGenerateRecommendations() {
  const queryClient = useQueryClient()

  return useMutation({
    mutationFn: generateRecommendations,
    onSuccess: () => {
      // Invalidate recommendations cache to fetch fresh data after regeneration
      void queryClient.invalidateQueries({
        queryKey: coachKeys.currentRecommendations(),
      })
    },
    ...
  })
}
  </action>
  <verify>
pnpm typecheck passes
</verify>
  <done>
Caching behavior documented with inline comments explaining staleTime, gcTime, and cache invalidation
</done>
</task>

</tasks>

<verification>
After completion, verify:
1. TypeScript compiles without errors
2. useCoachRecommendations has 24h staleTime for offline support
3. useCoachRecommendations has 7d gcTime for cache retention
4. useGenerateRecommendations invalidates cache on success
5. Inline comments document the caching behavior
6. No code changes needed if already correctly configured (verification task)
</verification>

<success_criteria>
Offline caching verified working with 24h staleTime and proper cache invalidation on regeneration
</success_criteria>

<output>
After completion, create `.planning/phases/19-coach-page-recommendations-ui/19-05-SUMMARY.md`
</output>
