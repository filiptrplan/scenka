---
phase: 24-projecting-focus-recommendations
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/functions/openrouter-coach/index.ts
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Edge Function system prompt includes projecting_focus field definition"
    - "validateResponse() function validates projecting_focus array with all required fields"
    - "Example output in prompt includes projecting_focus structure"
    - "System prompt provides guidance for qualitative grade guidance"
    - "System prompt includes gym limitation awareness"
  artifacts:
    - path: "supabase/functions/openrouter-coach/index.ts"
      provides: "Edge Function with projecting_focus generation"
      contains: "projecting_focus"
  key_links:
    - from: "buildUserPrompt()"
      to: "systemPrompt"
      via: "LLM prompt injection"
      pattern: "buildUserPrompt|systemPrompt"
---

<objective>
Extend Edge Function to generate projecting focus recommendations alongside weekly focus and drills.

Purpose: Provide users with guidance on selecting boulders to project based on their style weaknesses, with qualitative grade guidance and gym awareness.
Output: Updated openrouter-coach Edge Function that generates 3-4 projecting focus areas per recommendation.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@.planning/phases/24-projecting-focus-recommendations/24-CONTEXT.md
@.planning/phases/24-projecting-focus-recommendations/24-RESEARCH.md

@supabase/functions/openrouter-coach/index.ts
</context>

<tasks>

<task type="auto">
  <name>Update system prompt to include projecting_focus field</name>
  <files>supabase/functions/openrouter-coach/index.ts</files>
  <action>
    In supabase/functions/openrouter-coach/index.ts, modify the systemPrompt constant:

    1. After the line defining weekly_focus and drills fields, add projecting_focus field definition:
    ```
    - projecting_focus: An array of 3-4 project focus areas
    ```

    2. After the drill field definitions, add projecting_focus item structure:
    ```
    Each projecting focus item must have:
    - focus_area: A concise description of the type of climbs to focus on (e.g., "Crimpy Overhangs", "Tensiony Slabs", "Pinchy Overhangs")
    - description: Why this focus area addresses the user's weaknesses and what it will help improve
    - grade_guidance: Qualitative guidance on difficulty level (e.g., "slightly above your max grade", "within one letter grade of your hardest send")
    - rationale: How this focus area connects to the user's specific weakness data and climbing goals
    ```

    3. After the strength-to-technique reframing section, add guidelines for projecting focus:
    ```
    Guidelines for projecting focus:
    1. Base recommendations primarily on style weaknesses (e.g., if struggling with Sloper, recommend "Sloper problems" or "Sloper overhangs")
    2. Be mindful of gym limitations - recommend styles that most gyms set (e.g., crimpy overhangs are common; dynos with toe hooks are rare)
    3. Provide qualitative grade guidance only (e.g., "slightly above max grade") - not specific grade ranges
    4. Keep focus areas broad but add details (e.g., "crimpy overhangs" not just "overhangs")
    5. Include 3-4 focus areas to give users options
    ```

    NOTE: Do NOT modify the existing system prompt content about drills or strength-to-technique reframing. Only add the projecting_focus sections.
  </action>
  <verify>
    grep -A 50 "Return valid JSON with the following structure:" supabase/functions/openrouter-coach/index.ts | grep "projecting_focus"
  </verify>
  <done>
    systemPrompt includes projecting_focus field definition, each item structure, and guidelines with qualitative grade guidance and gym limitation awareness
  </done>
</task>

<task type="auto">
  <name>Update validateResponse to validate projecting_focus</name>
  <files>supabase/functions/openrouter-coach/index.ts</files>
  <action>
    In supabase/functions/openrouter-coach/index.ts, extend the validateResponse() function:

    After the drill validation loop (around line 306), add projecting_focus array validation:

    ```typescript
    // Validate projecting_focus array
    if (!Array.isArray(parsed.projecting_focus)) {
      throw new Error('Missing or invalid field: projecting_focus (must be an array)')
    }

    if (parsed.projecting_focus.length < 3 || parsed.projecting_focus.length > 4) {
      throw new Error('Field projecting_focus must contain 3-4 items')
    }

    // Validate each projecting_focus item
    parsed.projecting_focus.forEach((item: any, index: number) => {
      const itemNum = index + 1

      if (!item.focus_area || typeof item.focus_area !== 'string') {
        throw new Error(`Projecting focus ${itemNum}: Missing or invalid field: focus_area`)
      }
      if (item.focus_area.trim().length === 0) {
        throw new Error(`Projecting focus ${itemNum}: Field focus_area cannot be empty`)
      }

      if (!item.description || typeof item.description !== 'string') {
        throw new Error(`Projecting focus ${itemNum}: Missing or invalid field: description`)
      }
      if (item.description.trim().length < 20) {
        throw new Error(`Projecting focus ${itemNum}: Field description must be at least 20 characters`)
      }

      if (!item.grade_guidance || typeof item.grade_guidance !== 'string') {
        throw new Error(`Projecting focus ${itemNum}: Missing or invalid field: grade_guidance`)
      }

      if (!item.rationale || typeof item.rationale !== 'string') {
        throw new Error(`Projecting focus ${itemNum}: Missing or invalid field: rationale`)
      }
      if (item.rationale.trim().length < 15) {
        throw new Error(`Projecting focus ${itemNum}: Field rationale must be at least 15 characters`)
      }
    })
    ```

    This ensures the LLM returns properly structured projecting focus data with all required fields and minimum length constraints.
  </action>
  <verify>
    grep -A 30 "Validate projecting_focus array" supabase/functions/openrouter-coach/index.ts | head -10
  </verify>
  <done>
    validateResponse function validates projecting_focus array (3-4 items), each with focus_area, description (min 20 chars), grade_guidance, and rationale (min 15 chars)
  </done>
</task>

<task type="auto">
  <name>Update example output in buildUserPrompt</name>
  <files>supabase/functions/openrouter-coach/index.ts</files>
  <action>
    In supabase/functions/openrouter-coach/index.ts, update the buildUserPrompt function to include projecting_focus in the example output:

    Find the example output object in buildUserPrompt (around line 208). After the drills array closing bracket, add a projecting_focus array example:

    ```json
    ,
  "projecting_focus": [
    {
      "focus_area": "Crimpy Overhangs",
      "description": "Your 40% failure rate on crimp holds suggests you need more time on crimpy terrain. Overhangs will test your tension and body positioning on crimps.",
      "grade_guidance": "Focus on problems slightly above your max grade - challenging but realistic for a week of projecting",
      "rationale": "Builds finger strength on crimps while developing body tension skills for steep terrain"
    }
  ]
    ```

    Also update the request section to include projecting_focus in the numbered list (around line 203):
    Change "2. 3 specific training drills" to:
    ```
    2. 3 specific training drills with educational explanations
    3. 3-4 projecting focus areas for project selection this week
    ```
  </action>
  <verify>
    grep -A 10 "projecting_focus" supabase/functions/openrouter-coach/index.ts | head -5
  </verify>
  <done>
    Example output includes projecting_focus array with sample item containing all required fields, and request section mentions projecting focus generation
  </done>
</task>

</tasks>

<verification>
1. System prompt includes projecting_focus field definition, item structure, and guidelines with qualitative grade guidance and gym limitation awareness
2. validateResponse() validates projecting_focus array (3-4 items) with all required fields (focus_area, description, grade_guidance, rationale) and minimum length constraints
3. Example output in buildUserPrompt() includes projecting_focus with sample item
4. Request section in buildUserPrompt() mentions "3-4 projecting focus areas for project selection this week"
5. Edge Function can be deployed successfully: `supabase functions deploy openrouter-coach`
</verification>

<success_criteria>
Edge Function extended to generate projecting focus recommendations with proper validation, prompt guidance, and example output structure.
</success_criteria>

<output>
After completion, create `.planning/phases/24-projecting-focus-recommendations/24-01-SUMMARY.md`
</output>
