---
phase: 28-rework-chat-system-prompt-and-data-context
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/functions/_shared/system-prompt.ts
  - supabase/functions/openrouter-chat/index.ts
  - src/hooks/useStreamingChat.ts
autonomous: true

must_haves:
  truths:
    - "Chatbot responds with climbing coach persona (friendly but authoritative)"
    - "Chatbot only references recommendations when user specifically asks about them"
    - "Chatbot explains technique concepts first, then mentions drill names"
    - "Chatbot acknowledges recommendations page when discussing drills (e.g., 'From your recommendations page...')"
    - "When user says a drill doesn't work, chatbot offers alternatives without suggesting regeneration"
    - "Chatbot can answer questions about weekly focus, drills, and projecting focus areas"
    - "Chat works for users without recommendations (no errors, graceful degradation)"
  artifacts:
    - path: "supabase/functions/_shared/system-prompt.ts"
      provides: "Enhanced chat system prompt with recommendations support"
      contains: "getChatSystemPrompt function with recommendations parameter"
      exports: ["getChatSystemPrompt"]
    - path: "supabase/functions/openrouter-chat/index.ts"
      provides: "Edge Function that fetches recommendations and passes to system prompt"
      contains: "fetchRecommendationsIfMissing function"
      exports: []
    - path: "src/hooks/useStreamingChat.ts"
      provides: "Client-side hook that passes recommendations to Edge Function"
      contains: "useCoachRecommendations import and recommendations in request body"
      exports: ["useStreamingChat"]
  key_links:
    - from: "src/hooks/useStreamingChat.ts"
      to: "supabase/functions/openrouter-chat/index.ts"
      via: "POST request body with recommendations field"
      pattern: "body: JSON.stringify.*recommendations"
    - from: "supabase/functions/openrouter-chat/index.ts"
      to: "supabase/functions/_shared/system-prompt.ts"
      via: "getChatSystemPrompt function call"
      pattern: "getChatSystemPrompt.*recommendations"
    - from: "supabase/functions/openrouter-chat/index.ts"
      to: "coach_recommendations table"
      via: "Supabase client query"
      pattern: "from\\('coach_recommendations'\\).*select\\(.*\\).*limit\\(1\\)"
---

<objective>
Rework chat system prompt to be role-based (climbing coach), reactive to user questions, concept-first, and include latest recommendations in chatbot data context.

Purpose: Improve chatbot response quality and relevance by (1) establishing clear coaching persona and behavior, and (2) integrating weekly recommendations so users can discuss and ask questions about their current weekly focus, drills, and projecting focus areas.

Output: Enhanced chatbot that can discuss specific drills and focus areas from the user's weekly recommendations with proper coaching behavior.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/phases/28-rework-chat-system-prompt-and-data-context/28-CONTEXT.md
@.planning/phases/28-rework-chat-system-prompt-and-data-context/28-RESEARCH.md

@supabase/functions/_shared/system-prompt.ts
@supabase/functions/openrouter-chat/index.ts
@src/hooks/useStreamingChat.ts
@src/hooks/useCoach.ts
@src/services/coach.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update system-prompt.ts with role-based coaching behavior and recommendations support</name>
  <files>supabase/functions/_shared/system-prompt.ts</files>
  <action>
    Update the getChatSystemPrompt function in _shared/system-prompt.ts to:

    1. Add a new parameter: `recommendations?: RecommendationsData | null`
    2. Rewrite the system prompt with role-based coaching persona:
       - Role: Expert climbing coach, friendly but authoritative
       - Primary purpose: Help users clarify drills and recommendations, ask about alternatives
       - Behavior: Answer-focused, user drives conversation, reactive to user questions only
       - Reference style: Concept-first (explain technique concepts first, drill names secondary)
       - Acknowledgment: Explicitly tie to recommendations page when discussing drills

    3. Add behavior instructions:
       - "Only reference weekly recommendations if user specifically asks about them or mentions drills"
       - "Explain technique concepts first, then mention drill names as secondary identifiers"
       - "When explaining a drill, briefly describe it, then offer alternative approaches or variations"
       - "If user says a drill doesn't work for them, suggest alternative drills or approaches (do NOT suggest regenerating recommendations)"

    4. Add recommendations formatting:
       - Create a formatRecommendationsForLLM() helper function that formats recommendations in LLM-friendly format
       - Use clear section headers (## Your Weekly Focus, ## Drills for This Week, ## Projecting Focus Areas)
       - Concept-first format: "What to work on: [description]" before drill name
       - Include all drill fields: name, description, sets, reps, rest, measurable_outcome
       - Include projecting focus areas with focus_area, description, grade_guidance

    5. Conditional recommendations section:
       - Only add recommendations to prompt if recommendations and recommendations.content exist
       - Format as unified block with clear structure
       - Handle gracefully if recommendations are missing (no error, just skip section)

    Do NOT use raw JSON dumps - format as natural language with clear labels.
  </action>
  <verify>
    ```bash
    # Check system-prompt.ts has updated signature and formatting function
    grep -A 5 "export function getChatSystemPrompt" supabase/functions/_shared/system-prompt.ts | grep "recommendations"
    grep -q "formatRecommendationsForLLM" supabase/functions/_shared/system-prompt.ts
    grep -q "concept-first\|Only reference weekly recommendations" supabase/functions/_shared/system-prompt.ts
    ```
  </verify>
  <done>
    getChatSystemPrompt accepts recommendations parameter, includes role-based coaching persona with reactive behavior, concept-first explanations, and formats recommendations in LLM-friendly structure when available.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update openrouter-chat Edge Function to fetch recommendations and pass to system prompt</name>
  <files>supabase/functions/openrouter-chat/index.ts</files>
  <action>
    Update the openrouter-chat Edge Function to:

    1. Update RequestBody interface to include recommendations:
       - Add optional `recommendations?: RecommendationsData | null` field
       - Define RecommendationsData type matching coach_recommendations content structure (weekly_focus, drills[], projecting_focus[])

    2. Create fetchRecommendationsIfMissing() helper function:
       - Check if recommendations provided in request body
       - If provided and valid, return directly
       - If not provided or missing, fetch from coach_recommendations table
       - Query: select('*').eq('user_id', userId).order('created_at', { ascending: false }).limit(1).maybeSingle()
       - Return null on error or if no data exists (graceful degradation)
       - Follow pattern from openrouter-coach getExistingRecommendations() function

    3. Call fetchRecommendationsIfMissing() before building messages:
       - After JWT validation and limit check, call helper with userId and body.recommendations
       - Store result in `recommendations` variable

    4. Update getChatSystemPrompt() call:
       - Pass `recommendations` as third parameter
       - Ensure existing `patterns_data` and `climbing_context` parameters are preserved

    5. Log recommendation fetch for debugging:
       - Log "Recommendations found" or "No recommendations available" for monitoring

    IMPORTANT: Maintain all existing logic (limit check, message storage, SSE streaming, usage tracking). Do not break existing functionality.
  </action>
  <verify>
    ```bash
    # Check Edge Function has updated interface and fetch function
    grep -q "recommendations.*RecommendationsData" supabase/functions/openrouter-chat/index.ts
    grep -q "fetchRecommendationsIfMissing" supabase/functions/openrouter-chat/index.ts
    grep -A 3 "getChatSystemPrompt" supabase/functions/openrouter-chat/index.ts | grep -q "recommendations"
    ```
  </verify>
  <done>
    Edge Function accepts recommendations in request body, fetches from database if missing, and passes to getChatSystemPrompt while maintaining all existing functionality.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update useStreamingChat hook to fetch and pass recommendations</name>
  <files>src/hooks/useStreamingChat.ts</files>
  <action>
    Update the useStreamingChat hook to:

    1. Import useCoachRecommendations from '@/hooks/useCoach'

    2. Fetch recommendations in hook:
       - Add `const { data: recommendations } = useCoachRecommendations()` at component level
       - Leverage existing TanStack Query cache (24h staleTime means minimal refetch)

    3. Update sendMessage() request body:
       - Add `recommendations: recommendations` to JSON.stringify body
       - Preserve existing `message`, `patterns_data`, and `climbing_context` fields

    4. Add recommendations to dependency array:
       - Include `recommendations` in sendMessage useCallback dependencies
       - Ensures hook re-captures when recommendations change

    5. No changes to existing validation or error handling logic

    IMPORTANT: Use existing useCoachRecommendations() hook - do NOT implement custom recommendation fetching. Follow the existing pattern from coach-page.tsx for consistency.
  </action>
  <verify>
    ```bash
    # Check hook imports and uses recommendations
    grep -q "useCoachRecommendations" src/hooks/useStreamingChat.ts
    grep -q "recommendations: recommendations" src/hooks/useStreamingChat.ts
    grep -A 2 "sendMessage.*useCallback" src/hooks/useStreamingChat.ts | grep -q "recommendations"
    ```
  </verify>
  <done>
    useStreamingChat hook fetches recommendations via useCoachRecommendations() and passes to Edge Function in request body, enabling chatbot to discuss weekly focus, drills, and projecting focus areas.
  </done>
</task>

</tasks>

<verification>
1. Deploy updated Edge Functions:
   ```bash
   npx supabase functions deploy openrouter-chat
   ```

2. Test chat with recommendations (user with existing recommendations):
   - Start a chat session with user who has generated recommendations
   - Ask "What's my weekly focus?" - should answer with weekly_focus content
   - Ask "Tell me about the drills" - should explain concept-first, mention drill names
   - Ask "This drill doesn't work for me" - should offer alternatives, NOT suggest regeneration
   - Ask a question about projecting focus - should reference focus areas and grade guidance
   - Verify chatbot uses phrases like "From your recommendations page..." or "As I mentioned in your weekly drill..."

3. Test chat without recommendations (new user or no recommendations generated):
   - Start a chat session with user who has no recommendations
   - Ask any climbing question - should answer normally without errors
   - Verify no TypeError or crashes when recommendations is null
   - Verify Edge Function logs "No recommendations available"

4. Test reactive behavior:
   - Ask "How's my climbing going?" - should NOT mention recommendations unprompted
   - Ask "What are my drills?" - should reference recommendations explicitly
   - Verify chatbot only mentions recommendations when user asks about them

5. Run linting and type checking:
   ```bash
   pnpm lint
   pnpm typecheck
   ```
</verification>

<success_criteria>
1. Chatbot has clear climbing coach persona (friendly but authoritative)
2. Chatbot only references recommendations when user asks about them
3. Chatbot explains technique concepts first, then drill names
4. Chatbot acknowledges recommendations page when discussing drills
5. Chatbot offers alternatives when user says drill doesn't work (no regeneration suggestions)
6. Chatbot can discuss weekly focus, all 3 drills, and projecting focus areas
7. Chat works without recommendations (no errors, graceful degradation)
8. Edge Function logs recommendation fetch status
9. All linting and type checking passes
</success_criteria>

<output>
After completion, create `.planning/phases/28-rework-chat-system-prompt-and-data-context/28-01-SUMMARY.md`
</output>
