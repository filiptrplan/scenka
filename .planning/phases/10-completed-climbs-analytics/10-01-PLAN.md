---
phase: 10-completed-climbs-analytics
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [supabase/migrations/XXXX_add_redemption_at_column.sql, src/components/features/climb-card.tsx, src/components/features/charts-page.tsx]
autonomous: true
---

<objective>
Add redemption analytics tracking and visualization showing how many failed climbs are eventually completed.

Purpose: Track redemption rate to help climbers understand their progress and project completion patterns. When a failed climb is marked as sent (Phase 09 feature), we can now track and visualize this redemption data.

Output: Database migration for redemption tracking, updated ClimbCard to record redemption events, and new Redemption Rate chart in Analytics page.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-mark-failed-as-succeeded/09-RESEARCH.md
@.planning/phases/09-mark-failed-as-succeeded/09-01-SUMMARY.md
@src/components/features/charts-page.tsx
@src/components/features/climb-card.tsx
@supabase/migrations/20260105175622_create_climbs_table.sql
</context>

<tasks>
<task type="auto">
  <name>Task 1: Create migration for redemption_at column</name>
  <files>supabase/migrations/XXXX_add_redemption_at_column.sql</files>
  <action>Create Supabase migration to add `redemption_at TIMESTAMPTZ` nullable column to climbs table. This column will be populated when a failed climb is marked as sent. Migration should follow existing pattern from 20260105175622_create_climbs_table.sql: use proper naming convention (timestamp format with date prefix), no RLS policy changes needed (column is nullable and not part of access control), column should be nullable (TIMESTAMPTZ) to support optional redemption tracking. Use npx supabase migration new command to generate migration file name with timestamp.</action>
  <verify>Migration file created, structure matches existing migration patterns, column added to climbs table schema (check with npx supabase db push --dry-run)</verify>
  <done>Migration created with redemption_at nullable timestamp column on climbs table</done>
</task>

<task type="auto">
  <name>Task 2: Update ClimbCard to record redemption timestamp</name>
  <files>src/components/features/climb-card.tsx</files>
  <action>Modify the "Mark as Sent" button handler to also update redemption_at field when marking a failed climb as sent. Find the handleMarkAsSent function in ClimbCard component, update the mutation call to include redemption_at: new Date().toISOString() in the updates object alongside outcome: 'Sent' and failure_reasons: []. This ensures we track when redemptions occur. The useUpdateClimb hook will handle the update through updateClimb service with offline queue support.</action>
  <verify>TypeScript compiles with no errors (pnpm typecheck), redemption_at is included in update mutation payload</verify>
  <done>ClimbCard marks redemption_at timestamp when climb is marked as sent</done>
</task>

<task type="auto">
  <name>Task 3: Add Redemption Rate chart to ChartsPage</name>
  <files>src/components/features/charts-page.tsx</files>
  <action>Add new Redemption Rate chart section to ChartsPage following existing chart patterns (Anti-Style, Failure Radar, etc.). Chart should display redemption statistics by difficulty bucket to show which grade levels have highest redemption rates. Create useMemo hook redemptionRateData that:
1. Groups climbs by difficulty bucket (using existing getAllGradeBuckets and getDifficultyBucket from lib/grades)
2. For each bucket, calculates: total_sent (climbs with outcome='Sent'), redeems_sent (climbs with outcome='Sent' AND redemption_at IS NOT NULL)
3. Computes redemption_rate as percentage: (redeems_sent / total_sent * 100) when total_sent > 0, else 0
4. Returns array of objects: [{ name: 'Beginner', total_sent: 10, redeems_sent: 4, redemption_rate: 40 }, ...]

Render as BarChart with two stacked bars or separate bars:
- Red bar: Sent (non-redeemed) - total_sent - redeems_sent
- Emerald bar: Redeemed - redeems_sent
OR render as single bar with redemption_rate percentage for each bucket

Follow existing chart styling:
- Section header with teal-500 theme color lines: "REDEMPTION RATE"
- ResponsiveContainer with height-80
- BarChart with same margin and axis styling as existing charts
- Tooltip with same dark theme styling (backgroundColor: '#1a1a1a', border, fontFamily: 'monospace')
- XAxis with bucket names (Beginner, Intermediate, Advanced, Expert)
- YAxis with count values (or percentage if showing rate)
- Bar(s) with teal-500 color for redeemed data, gray-500 for non-redeemed
- Subtitle: "Redemption rate by difficulty bucket" using existing subtitle pattern

Add section before the final footer div in ChartsPage (after Style Distribution section, before "Data based on logged failures" footer). Handle empty data case (no redeemed climbs) by showing message or empty chart - similar to existing charts.</action>
  <verify>TypeScript compiles (pnpm typecheck), build succeeds (pnpm build), chart renders in Analytics page, redemption_at data flows from climbs through useMemo to chart</verify>
  <done>Redemption Rate chart added to Analytics page showing redemption statistics by difficulty bucket</done>
</task>

<task type="auto">
  <name>Task 4: Apply migration to database</name>
  <files>supabase/migrations/XXXX_add_redemption_at_column.sql</files>
  <action>Run npx supabase db push to apply the migration and add redemption_at column to climbs table. This will update the database schema and regenerate TypeScript types. After migration completes, run npx supabase gen types typescript --local to update generated types in src/types/supabase.ts (or wherever types are generated). Verify the new column is accessible in Climb type.</action>
  <verify>Migration applies successfully, npx supabase types gen completes without errors, TypeScript types include redemption_at field</verify>
  <done>Database schema updated with redemption_at column, TypeScript types regenerated</done>
</task>
</tasks>

<verification>
Before declaring plan complete:
- [ ] Migration file created with proper structure
- [ ] npx supabase db push applies migration successfully
- [ ] npx supabase gen types typescript --local regenerates types
- [ ] pnpm typecheck passes with no TypeScript errors
- [ ] pnpm build succeeds without errors
- [ ] ClimbCard updates redemption_at when marking as sent
- [ ] Redemption Rate chart renders in Analytics page
- [ ] Chart shows data by difficulty bucket
- [ ] Teal-500 theme color used for redemption data
</verification>

<success_criteria>

- Database has redemption_at nullable timestamp column on climbs table
- ClimbCard records redemption timestamp when marking failed climb as sent
- Redemption Rate chart displays in Analytics page
- Chart shows redemption statistics by difficulty bucket
- Chart uses consistent styling with existing analytics charts
- TypeScript types include redemption_at field
- All builds and type checks pass
</success_criteria>

<output>
After completion, create `.planning/phases/10-completed-climbs-analytics/10-01-SUMMARY.md`
</output>
