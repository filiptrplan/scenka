---
phase: 22-openrouter-model-configuration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/functions/openrouter-chat/index.ts
  - supabase/functions/openrouter-coach/index.ts
  - src/services/coach.ts
  - .env.example
autonomous: true
user_setup:
  - service: openrouter
    why: "LLM API for climbing coach"
    env_vars:
      - name: OPENROUTER_MODEL
        source: "Configure with: supabase secrets set OPENROUTER_MODEL=google/gemini-2.5-pro"

must_haves:
  truths:
    - "Both Edge Functions use model from OPENROUTER_MODEL env var (not hardcoded)"
    - "OpenRouter's usage.cost field is used directly for cost tracking (not calculateCost)"
    - "Chat endpoint tracks usage data after streaming completes"
    - "Coach endpoint uses OpenRouter's cost from response usage object"
    - "Internal calculateCost() functions removed from both Edge Function and client service"
    - "Error paths store model from env var in coach_api_usage table"
    - "Documentation added to .env.example for OPENROUTER_MODEL configuration"
  artifacts:
    - path: "supabase/functions/openrouter-chat/index.ts"
      provides: "SSE chat endpoint with configurable model and usage tracking"
      contains: "OPENROUTER_MODEL"
      exports: ["Deno.serve"]
    - path: "supabase/functions/openrouter-coach/index.ts"
      provides: "Non-streaming recommendations with configurable model and OpenRouter cost tracking"
      contains: "OPENROUTER_MODEL"
      exports: ["Deno.serve"]
    - path: "src/services/coach.ts"
      provides: "Client coach service without internal cost calculation"
      exports: ["generateRecommendations", "trackApiUsage"]
    - path: ".env.example"
      provides: "Documentation for OPENROUTER_MODEL configuration"
      contains: "OPENROUTER_MODEL"
  key_links:
    - from: "supabase/functions/openrouter-chat/index.ts"
      to: "Deno.env.get('OPENROUTER_MODEL')"
      via: "Environment variable at startup"
      pattern: "Deno\\.env\\.get\\('OPENROUTER_MODEL'\\)"
    - from: "supabase/functions/openrouter-chat/index.ts"
      to: "coach_api_usage"
      via: "Insert after streaming completes"
      pattern: "supabase\\.from\\('coach_api_usage'\\)\\.insert"
    - from: "supabase/functions/openrouter-coach/index.ts"
      to: "response.usage.cost"
      via: "Direct cost from OpenRouter response"
      pattern: "lastUsage\\.cost \\|\\| 0"
    - from: "src/services/coach.ts"
      to: "trackApiUsage function"
      via: "Cost parameter passed from Edge Function"
      pattern: "cost_usd.*parameter"
---

<objective>
Configure OpenRouter model selection via environment variables and use OpenRouter's cost data for accurate tracking.

Purpose: Enable easy model switching without code changes and ensure accurate cost tracking by using OpenRouter's provided usage.cost field instead of manual calculation.

Output: Both Edge Functions use OPENROUTER_MODEL env var, all cost tracking uses OpenRouter's cost data, internal calculateCost() functions removed.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-openrouter-model-configuration/22-CONTEXT.md
@.planning/phases/22-openrouter-model-configuration/22-RESEARCH.md
@supabase/functions/openrouter-chat/index.ts
@supabase/functions/openrouter-coach/index.ts
@src/services/coach.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Configure OpenRouter model in openrouter-chat Edge Function</name>
  <files>supabase/functions/openrouter-chat/index.ts</files>
  <action>
    Update supabase/functions/openrouter-chat/index.ts:
    1. Line 7: Add 'OPENROUTER_MODEL' to requiredEnvVars array
    2. Line 16: Add `const model = Deno.env.get('OPENROUTER_MODEL')!`
    3. Line 173: Change `model: 'google/gemini-2.5-pro'` to `model`
    4. Lines 181-191: After streaming loop completes, add usage tracking:
       - Capture finalUsage from chunk.usage during streaming (add `let finalUsage: any = null` before loop, set `if (chunk.usage) finalUsage = chunk.usage` inside loop)
       - After assistant message is stored (after line 203), add:
         ```typescript
         // Track API usage with OpenRouter's cost
         if (finalUsage) {
           await supabase.from('coach_api_usage').insert({
             user_id: userId,
             prompt_tokens: finalUsage.prompt_tokens || 0,
             completion_tokens: finalUsage.completion_tokens || 0,
             total_tokens: finalUsage.total_tokens || 0,
             cost_usd: finalUsage.cost || 0,
             model,
             endpoint: 'openrouter-chat',
             time_window_start: new Date().toISOString(),
           }).catch((err) => {
             console.error('Failed to track API usage:', err)
           })
         }
         ```
    Use defensive coding (|| 0 fallbacks) since usage data availability in streaming is uncertain.
  </action>
  <verify>grep -n "OPENROUTER_MODEL" /workspace/supabase/functions/openrouter-chat/index.ts && grep -n "const model" /workspace/supabase/functions/openrouter-chat/index.ts</verify>
  <done>OPENROUTER_MODEL validated at startup, used in API call, usage tracked after streaming completes</done>
</task>

<task type="auto">
  <name>Task 2: Configure OpenRouter model and remove calculateCost from openrouter-coach</name>
  <files>supabase/functions/openrouter-coach/index.ts</files>
  <action>
    Update supabase/functions/openrouter-coach/index.ts:
    1. Line 9: Add 'OPENROUTER_MODEL' to requiredEnvVars array (change SUPABASE_ANON_KEY to SUPABASE_SERVICE_ROLE_KEY for consistency)
    2. Line 18: Add `const model = Deno.env.get('OPENROUTER_MODEL')!`
    3. Lines 309-314: Remove calculateCost() function entirely
    4. Line 404: Change `model: 'google/gemini-2.5-pro'` to `model`
    5. Line 425: Change `const costUsd = calculateCost(lastUsage)` to `const costUsd = lastUsage.cost || 0`
    6. Line 448: Change `model: 'google/gemini-2.5-pro'` to `model`
    7. Line 502: Change `model: 'google/gemini-2.5-pro'` to `model` (error path)
    8. Line 545: Change `model: 'google/gemini-2.5-pro'` to `model` (error path)
    Ensure all model references use the `model` constant from env var.
  </action>
  <verify>grep -c "calculateCost" /workspace/supabase/functions/openrouter-coach/index.ts</verify>
  <done>calculateCost function removed, all model references use OPENROUTER_MODEL env var, cost_usd uses OpenRouter's cost</done>
</task>

<task type="auto">
  <name>Task 3: Update client service for cost tracking from Edge Function</name>
  <files>src/services/coach.ts</files>
  <action>
    Update src/services/coach.ts:
    1. Lines 174-207: Update trackApiUsage function to accept cost_usd parameter:
       ```typescript
   export async function trackApiUsage(
     userId: string,
     usage: {
       prompt_tokens: number
       completion_tokens: number
       total_tokens: number
       model: string
       endpoint: string
       cost_usd?: number  // Optional - if provided, use directly
     },
     isError: boolean = false
   ): Promise<void> {
     if (!supabase) {
       throw new Error('Supabase client not configured')
     }

     // Use provided cost_usd or calculate from usage (for backward compatibility)
     const cost_usd = isError ? 0 : (usage.cost_usd ?? calculateCost(usage))

     const { error } = await supabase.from('coach_api_usage').insert({
       user_id: userId,
       prompt_tokens: usage.prompt_tokens,
       completion_tokens: usage.completion_tokens,
       total_tokens: usage.total_tokens,
       cost_usd,
       model: usage.model,
       endpoint: usage.endpoint,
       time_window_start: new Date().toISOString(),
     })

     if (error) {
       console.error('Failed to track API usage:', error)
       // Don't throw - tracking failure shouldn't break. main flow
     }
   }
   ```
    2. Keep calculateCost function (lines 209-214) for backward compatibility with legacy calls
    3. Update call on line 143-153 to NOT provide cost_usd (Edge Function handles its own tracking now)
       - Simplify to just track error case without cost calculation
    OR remove trackApiUsage call entirely since Edge Functions now track their own usage
  </action>
  <verify>grep -n "cost_usd" /workspace/src/services/coach.ts</verify>
  <done>trackApiUsage function updated to accept optional cost_usd parameter, Edge Functions handle their own usage tracking</done>
</task>

<task type="auto">
  <name>Task 4: Document OPENROUTER_MODEL in .env.example</name>
  <files>.env.example</files>
  <action>
    Add documentation for OPENROUTER_MODEL environment variable to .env.example:
    ```
    # Edge Function secrets (set via supabase CLI, not .env file)
    # Set with: supabase secrets set OPENROUTER_MODEL=google/gemini-2.5-pro
    # OpenRouter model ID to use for LLM calls (e.g., google/gemini-2.5-pro, anthropic/claude-3.5-sonnet)
    ```
    Add this after existing VITE_ variables section as a comment block.
  </action>
  <verify>grep -n "OPENROUTER_MODEL" /workspace/.env.example</verify>
  <done>.env.example documents OPENROUTER_MODEL configuration with example values and setup instructions</done>
</task>

</tasks>

<verification>
After completing all tasks:
1. Verify openrouter-chat reads OPENROUTER_MODEL and tracks usage: Check env var validation, model usage in API call, and usage tracking after streaming
2. Verify openrouter-coach reads OPENROUTER_MODEL and uses OpenRouter cost: Check env var validation, model usage, removal of calculateCost, and lastUsage.cost usage
3. Verify client service doesn't calculate costs internally: Check trackApiUsage accepts optional cost_usd
4. Verify documentation exists: Check .env.example has OPENROUTER_MODEL documentation
</verification>

<success_criteria>
Both Edge Functions use OPENROUTER_MODEL from environment, all cost tracking uses OpenRouter's usage.cost field, internal calculateCost() functions removed, documentation complete.
</success_criteria>

<output>
After completion, create `.planning/phases/22-openrouter-model-configuration/22-01-SUMMARY.md`
</output>
