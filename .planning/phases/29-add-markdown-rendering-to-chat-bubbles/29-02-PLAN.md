---
phase: 29-add-markdown-rendering-to-chat-bubbles
plan: 02
type: execute
wave: 2
depends_on:
  - 29-01
files_modified:
  - src/components/features/chat-page.tsx
autonomous: true

must_haves:
  truths:
    - "Assistant messages render markdown (headings, lists, code blocks, links)"
    - "User messages remain plain text (no markdown rendering)"
    - "Markdown rendering works for both stored messages and streaming responses"
    - "Links open in new tab with security attributes"
    - "Code blocks have dark background and proper syntax highlighting"
    - "All styling matches app's dark theme"
  artifacts:
    - path: "src/components/features/chat-page.tsx"
      provides: "Updated MessageBubble with markdown rendering"
      contains: "ReactMarkdown"
  key_links:
    - from: "src/components/features/chat-page.tsx"
      to: "src/lib/markdown-components.ts"
      via: "import markdownComponents"
      pattern: "import.*markdownComponents"
    - from: "src/components/features/chat-page.tsx"
      to: "react-markdown"
      via: "import ReactMarkdown"
      pattern: "import.*ReactMarkdown"
---

<objective>
Update MessageBubble component to render markdown for assistant messages while keeping user messages as plain text.

Purpose: Enable AI coach responses to display formatted content including bold, italics, lists, code blocks, and links for better readability. User input should remain exactly as typed (plain text) to meet "what you type is what you see" expectations.

Output: Updated chat-page.tsx with conditional markdown rendering for assistant messages only.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@src/components/features/chat-page.tsx
@src/lib/markdown-components.ts

# Reference: Current MessageBubble implementation (lines 21-42)
- Renders plain text with whitespace-pre-wrap
- Distinguishes user vs assistant via isCurrentUser prop
- User messages: bg-blue-600 text-white rounded-br-sm
- Assistant messages: bg-gray-700 text-gray-100 rounded-bl-sm

# Reference: Research pattern (lines 242-274 in RESEARCH.md)
- Use conditional rendering: isCurrentUser ? plain text : ReactMarkdown
- Pass remarkPlugins={[remarkGfm]} for GitHub Flavored Markdown
- Pass components={markdownComponents} for custom styling
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update MessageBubble to render markdown</name>
  <files>src/components/features/chat-page.tsx</files>
  <action>
    Update the MessageBubble component in src/components/features/chat-page.tsx to conditionally render markdown:

    1. Add imports at the top:
       ```typescript
       import ReactMarkdown from 'react-markdown'
       import remarkGfm from 'remark-gfm'
       import { markdownComponents } from '@/lib/markdown-components'
       ```

    2. Modify the MessageBubble function to use conditional rendering:
       - For user messages (isCurrentUser === true): Keep existing plain text rendering with whitespace-pre-wrap
       - For assistant messages (isCurrentUser === false): Render markdown using ReactMarkdown with remarkPlugins={[remarkGfm]} and components={markdownComponents}

    3. The content div structure should follow this pattern:
       ```typescript
       {isCurrentUser ? (
         <div className="text-sm leading-relaxed whitespace-pre-wrap">
           {message.content}
         </div>
       ) : (
         <ReactMarkdown
           remarkPlugins={[remarkGfm]}
           components={markdownComponents}
         >
           {message.content}
         </ReactMarkdown>
       )}
       ```

    DO NOT:
    - Remove the timestamp display (keep it)
    - Change the bubble styling (colors, shadows, rounded corners)
    - Render markdown for user messages (user expects plain text input to appear as-is)
    - Use dangerouslySetInnerHTML (security risk)

    The markdown rendering will work for both:
    - Stored messages (from useCoachMessages)
    - Streaming responses (from streamingResponse state)
    because both are strings that get passed to MessageBubble.
  </action>
  <verify>
    pnpm typecheck && pnpm lint
  </verify>
  <done>
    MessageBubble conditionally renders markdown for assistant messages only, user messages remain plain text, TypeScript compiles without errors, ESLint passes.
  </done>
</task>

</tasks>

<verification>
- [ ] npm run typecheck passes (no TypeScript errors)
- [ ] npm run lint passes (no ESLint errors)
- [ ] Assistant messages render markdown (bold, italics, lists, code blocks, links)
- [ ] User messages remain plain text (no markdown interpretation)
- [ ] Timestamps still display correctly on all messages
- [ ] Bubble styling (colors, shadows, rounded corners) unchanged
  </verification>

<success_criteria>
MessageBubble renders formatted markdown for assistant responses while user messages remain as plain text.
</success_criteria>

<output>
After completion, create `.planning/phases/29-add-markdown-rendering-to-chat-bubbles/29-02-SUMMARY.md`
</output>
