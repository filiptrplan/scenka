---
phase: 20-llm-integration
plan: 02
type: execute
wave: 2
depends_on: [20-01]
files_modified: [supabase/functions/openrouter-coach/index.ts]
autonomous: true
user_setup: []

must_haves:
  truths:
    - "LLM responses are validated against expected JSON schema before storage"
    - "Invalid JSON or missing fields trigger retry logic (MAX_RETRIES=3)"
    - "Successfully validated recommendations persist across sessions"
    - "API costs are tracked and can be monitored by administrators"
    - "All retries exhausted with invalid data returns error response"
  artifacts:
    - path: "supabase/functions/openrouter-coach/index.ts"
      provides: "JSON validation, retry logic, and database storage"
      contains: "validateResponse|MAX_RETRIES|insertRecommendations"
  key_links:
    - from: "supabase/functions/openrouter-coach/index.ts"
      to: "coach_recommendations"
      via: "supabase.from('coach_recommendations').insert()"
      pattern: "supabase\.from\('coach_recommendations'\)"
    - from: "supabase/functions/openrouter-coach/index.ts"
      to: "coach_api_usage"
      via: "supabase.from('coach_api_usage').insert()"
      pattern: "supabase\.from\('coach_api_usage'\)"
    - from: "validateResponse()"
      to: "LLM output"
      via: "JSON.parse and field checks"
      pattern: "parsed\.weekly_focus.*Array\.isArray\(parsed\.drills\)"
---

<objective>
Add JSON response validation with retry logic, store validated recommendations in the database, and track API usage for cost monitoring and rate limiting.

Purpose: Ensure only valid, structured climbing recommendations are stored while handling LLM unreliability through retry mechanisms and monitoring token usage for cost control.

Output: Edge Function with robust validation, database persistence, and API usage tracking.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/phases/20-llm-integration/20-CONTEXT.md
@.planning/phases/20-llm-integration/20-RESEARCH.md

# Prior Plans
@.planning/phases/20-llm-integration/20-01-PLAN.md

# Existing Foundation
@workspace/src/services/coach.ts
@workspace/src/types/index.ts
@workspace/supabase/migrations/20260117_create_coach_tables.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add JSON schema validation with retry logic</name>
  <files>supabase/functions/openrouter-coach/index.ts</files>
  <action>
    Implement JSON validation with retry mechanism:

    1. Add constant at top of file:
       ```typescript
       const MAX_RETRIES = 3
       ```

    2. Create `validateResponse(content: string): object | null` function that:
       - Parses JSON using `JSON.parse(content)`
       - Validates presence of `weekly_focus` field (string, non-empty)
       - Validates presence of `drills` field (array with length 1-3)
       - For each drill in drills array, validates:
         - `name`: string, non-empty
         - `description`: string, non-empty, >20 chars (educational content)
         - `sets`: number, integer, 1-10
         - `reps`: string, non-empty
         - `rest`: string, non-empty
       - Returns validated object or throws validation error with details
       - Example error: "Drill 1 missing required field: description"

    3. Wrap API call in retry loop:
       ```typescript
       const MAX_RETRIES = 3
       let lastError: Error | null = null
       let lastContent: string | null = null
       let lastUsage: any = null

       for (let attempt = 0; attempt < MAX_RETRIES; attempt++) {
         try {
           const response = await openai.chat.completions.create({ /* ... */ })
           lastContent = response.choices[0].message.content
           lastUsage = response.usage

           // Validate response structure
           const validated = validateResponse(lastContent)

           // Success - break out of retry loop
           return { validated, usage: lastUsage }

         } catch (error) {
           lastError = error
           console.warn(`Attempt ${attempt + 1}/${MAX_RETRIES} failed:`, error.message)

           // If this was the last attempt, throw the error
           if (attempt === MAX_RETRIES - 1) {
             throw new Error(`Failed after ${MAX_RETRIES} attempts: ${lastError.message}`)
           }

           // Continue to next retry
           continue
         }
       }
       ```

    4. Clean response before parsing (strip markdown code blocks if present):
       ```typescript
       function cleanResponse(content: string): string {
         // Remove markdown code blocks if present
         return content.replace(/```json\n?|\n?```/g, '').trim()
       }
       ```

    5. Log each retry attempt with attempt number and error message
  </action>
  <verify>
    Check that:
    - MAX_RETRIES constant is set to 3
    - validateResponse() function exists and checks all required fields
    - validateResponse() checks drill array length (1-3)
    - validateResponse() checks each drill for name, description, sets, reps, rest
    - API call is wrapped in retry loop
    - Each failed attempt is logged with attempt number
    - Error thrown after all retries exhausted includes attempt count
    - cleanResponse() function strips markdown code blocks
  </verify>
  <done>
    JSON validation with retry logic added with:
    - MAX_RETRIES = 3 constant
    - validateResponse() checking all required fields
    - Retry loop with logging for each attempt
    - Error thrown after all retries with attempt count
    - Response cleaning to remove markdown code blocks
  </done>
</task>

<task type="auto">
  <name>Task 2: Store validated recommendations and track API usage</name>
  <files>supabase/functions/openrouter-coach/index.ts</files>
  <action>
    Add database storage and API usage tracking:

    1. Add cost calculation function (same as coach.ts for consistency):
       ```typescript
       function calculateCost(usage: { prompt_tokens: number, completion_tokens: number }): number {
         // OpenRouter pricing for gpt-4o-mini
         const promptCost = (usage.prompt_tokens * 0.00015) / 1000 // $0.15 per 1M tokens
         const completionCost = (usage.completion_tokens * 0.0006) / 1000 // $0.60 per 1M tokens
         return promptCost + completionCost
       }
       ```

    2. After successful validation, insert into coach_recommendations table:
       ```typescript
       const { error: insertError } = await supabase
         .from('coach_recommendations')
         .insert({
           user_id: userId,
           generation_date: new Date().toISOString().split('T')[0], // YYYY-MM-DD format
           content: validated, // JSONB: { weekly_focus, drills: [...] }
           is_cached: false,
           error_message: null
         })

       if (insertError) {
         console.error('Failed to store recommendations:', insertError)
         // Continue to return response - don't fail the whole request
       }
       ```

    3. Track API usage in coach_api_usage table:
       ```typescript
       const cost_usd = calculateCost(lastUsage)
       const { error: usageError } = await supabase
         .from('coach_api_usage')
         .insert({
           user_id: userId,
           prompt_tokens: lastUsage.prompt_tokens,
           completion_tokens: lastUsage.completion_tokens,
           total_tokens: lastUsage.total_tokens,
           cost_usd,
           model: 'openai/gpt-4o-mini',
           endpoint: 'openrouter-coach',
           time_window_start: new Date().toISOString()
         })

       if (usageError) {
         console.error('Failed to track API usage:', usageError)
         // Continue - tracking failure shouldn't break the response
       }
       ```

    4. Return success response to client:
       ```typescript
       return Response.json({
         success: true,
         content: validated,
         usage: {
           prompt_tokens: lastUsage.prompt_tokens,
           completion_tokens: lastUsage.completion_tokens,
           total_tokens: lastUsage.total_tokens,
           cost_usd
         }
       })
       ```

    5. For validation failures (all retries exhausted), store error in coach_recommendations:
       ```typescript
       // Store error message for future reference
       await supabase.from('coach_recommendations').insert({
         user_id: userId,
         generation_date: new Date().toISOString().split('T')[0],
         content: {},
         is_cached: false,
         error_message: `Failed to generate valid recommendations: ${lastError.message}`
       })

       // Track failed attempt with cost=0
       await supabase.from('coach_api_usage').insert({
         user_id: userId,
         prompt_tokens: 0,
         completion_tokens: 0,
         total_tokens: 0,
         cost_usd: 0,
         model: 'openai/gpt-4o-mini',
         endpoint: 'openrouter-coach',
         time_window_start: new Date().toISOString()
       })

       return Response.json({ error: lastError.message }, { status: 500 })
       ```

    6. Ensure all database insert errors are logged but don't fail the request (graceful degradation)
  </action>
  <verify>
    Check that:
    - calculateCost() function matches coach.ts pricing (0.15/M prompt, 0.60/M completion)
    - Recommendations insert uses user_id, generation_date (YYYY-MM-DD), content, is_cached=false, error_message=null
    - API usage insert tracks all fields: user_id, prompt_tokens, completion_tokens, total_tokens, cost_usd, model, endpoint, time_window_start
    - Failed requests store error_message in coach_recommendations and track usage with cost=0
    - Database insert errors are logged but don't throw (graceful degradation)
    - Success response includes content and usage with cost_usd
  </verify>
  <done>
    Database storage and usage tracking added with:
    - Cost calculation matching coach.ts
    - Recommendations stored with content, is_cached flag, error_message
    - API usage tracked with tokens, cost, model, endpoint
    - Failed requests tracked with cost=0 and error message stored
    - Database errors logged but don't fail request
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `deno check supabase/functions/openrouter-coach/index.ts`
2. Validation logic tests: Manually verify validateResponse() catches:
   - Missing weekly_focus
   - Missing drills array
   - Drills missing required fields
   - Invalid data types (non-integer sets, empty strings)
3. Database insert logic verified against schema from 20260117_create_coach_tables.sql
4. Cost calculation verified against coach.ts calculateCost() function
</verification>

<success_criteria>
1. JSON validation checks all required fields before storage
2. Retry logic attempts up to 3 times with logging for each attempt
3. Validated recommendations stored in coach_recommendations table
4. API usage tracked in coach_api_usage table with cost calculation
5. Failed requests tracked with error message and cost=0
6. Database errors logged but don't fail the request
</success_criteria>

<output>
After completion, create `.planning/phases/20-llm-integration/20-02-SUMMARY.md`
</output>
