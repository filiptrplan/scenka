---
phase: 20-llm-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: []
autonomous: true
user_setup:
  - service: openrouter
    why: "OpenRouter API for LLM-powered recommendations"
    env_vars:
      - name: OPENROUTER_API_KEY
        source: "OpenRouter Dashboard -> API Keys"
    dashboard_config:
      - task: "Add OPENROUTER_API_KEY to Supabase Edge Functions environment variables"
        location: "Supabase Dashboard → Edge Functions → Settings → Environment Variables"

must_haves:
  truths:
    - "Edge Function 'openrouter-coach' exists in supabase/functions/"
    - "OpenRouter API client is configured with correct base URL"
    - "JWT validation ensures only authenticated users can access recommendations"
    - "Climbing-specific prompts include system role and user context"
    - "API call requests JSON output format with gpt-4o-mini model"
  artifacts:
    - path: "supabase/functions/openrouter-coach/index.ts"
      provides: "Edge Function handler with OpenRouter integration"
      min_lines: 80
  key_links:
    - from: "supabase/functions/openrouter-coach/index.ts"
      to: "OpenRouter API"
      via: "OpenAI SDK with baseURL override"
      pattern: "new OpenAI.*baseURL.*openrouter"
    - from: "supabase/functions/openrouter-coach/index.ts"
      to: "Supabase Auth"
      via: "JWT token validation"
      pattern: "supabase\.auth\.getClaims"
---

<objective>
Create the `openrouter-coach` Edge Function foundation with OpenRouter API integration, JWT authentication, and climbing-specific prompt engineering.

Purpose: Establish the server-side infrastructure for generating personalized climbing recommendations using OpenRouter's LLM API with proper authentication and climbing domain expertise.

Output: Edge Function handler that validates JWT tokens, constructs climbing-specific prompts, and calls OpenRouter API to generate recommendations.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/phases/20-llm-integration/20-CONTEXT.md
@.planning/phases/20-llm-integration/20-RESEARCH.md

# Existing Foundation
@workspace/src/services/coach.ts
@workspace/src/services/patterns.ts
@workspace/src/lib/coachUtils.ts
@workspace/src/types/index.ts
@workspace/supabase/migrations/20260117_create_coach_tables.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Edge Function handler with JWT validation and OpenRouter SDK</name>
  <files>supabase/functions/openrouter-coach/index.ts</files>
  <action>
    Create the Edge Function structure:

    1. Create directory: `mkdir -p supabase/functions/openrouter-coach`

    2. Create `index.ts` with:
       - Import Supabase client from `npm:@supabase/supabase-js@2`
       - Import OpenAI SDK from `npm:openai@4`
       - Initialize Supabase client using `Deno.env.get('SUPABASE_URL')` and `Deno.env.get('SB_PUBLISHABLE_KEY')`
       - Initialize OpenAI client using `Deno.env.get('OPENROUTER_API_KEY')!` and `baseURL: 'https://openrouter.ai/api/v1'`
       - Create `Deno.serve()` handler function
       - In handler: Extract JWT from Authorization header, call `supabase.auth.getClaims(token)`
       - Return 401 if JWT invalid or missing

    3. Parse request body expecting:
       - `user_id`: string
       - `patterns_data`: PatternAnalysis object (failure_patterns, style_weaknesses, climbing_frequency, recent_successes)
       - `user_preferences`: { preferred_discipline, preferred_grade_scale }

    4. Return error if required fields missing or patterns_data invalid
  </action>
  <verify>
    Check that:
    - File exists at `supabase/functions/openrouter-coach/index.ts`
    - Supabase client is initialized with Deno.env variables
    - OpenAI client is initialized with OPENROUTER_API_KEY and correct baseURL
    - JWT validation extracts token and calls supabase.auth.getClaims()
    - Request body parsing includes user_id, patterns_data, user_preferences
  </verify>
  <done>
    Edge Function handler created with:
    - JWT authentication (401 on invalid tokens)
    - OpenRouter SDK integration (OpenAI SDK with baseURL override)
    - Request body parsing for patterns and preferences
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement climbing-specific prompts (system + user with patterns context)</name>
  <files>supabase/functions/openrouter-coach/index.ts</files>
  <action>
    Add climbing-specific prompt engineering:

    1. Create `systemPrompt` constant with:
       - Role: "You are an expert climbing coach specializing in bouldering and sport climbing"
       - Approach: "Weakness-based coaching - identify user's primary weaknesses and target them"
       - Output format: "Return valid JSON with: weekly_focus (string), drills array"
       - Drill requirements: "Each drill must have: name, description (educational explanation), sets (number), reps (string, e.g., '3-5 min' or '6-8 reps'), rest (string, e.g., '90s')"
       - Technical requirements: "Use climbing-specific terminology: hangboard protocols (8-12s hangs), campus board (power), antagonistic training, periodization, contact strength"
       - Safety: "Explain what each drill is and why it's beneficial for the user"

    2. Create function `buildUserPrompt(patterns, preferences)` that:
       - Includes failure_patterns (most_common_failure_reasons with reason, count, percentage)
       - Includes style_weaknesses (struggling_styles with style, fail_rate)
       - Includes climbing_frequency (climbs_per_month, avg_climbs_per_session)
       - Includes recent_successes (redemption_count, grade_progression)
       - Includes user preferences (preferred_discipline, preferred_grade_scale)
       - Asks for: "A weekly focus statement addressing the user's primary weaknesses and 3 specific training drills"

    3. Add example JSON structure in user prompt:
       ```json
       {
         "weekly_focus": "Focus on improving finger strength through structured hangboard training to address your 40% failure rate on crimp-style holds",
         "drills": [
           {
             "name": "7-3-5-3 Hangboard Protocol",
             "description": "A progressive hangboard protocol that builds contact strength by alternating between 7-second, 3-second, 5-second, and 3-second hangs with 90-second rests. Targets the half-crimp and open-hand grip positions critical for bouldering.",
             "sets": 4,
             "reps": "6-8 reps per hold",
             "rest": "90s"
           }
         ]
       }
       ```

    4. Call `buildUserPrompt()` with parsed request body data
  </action>
  <verify>
    Check that:
    - systemPrompt defines climbing coach role and requirements
    - buildUserPrompt() function exists and accepts patterns and preferences
    - Prompts include all pattern analysis fields (failures, styles, frequency, successes)
    - Prompts use technical climbing terminology
    - JSON example structure includes required fields (weekly_focus, drills with name, description, sets, reps, rest)
  </verify>
  <done>
    Climbing-specific prompts implemented with:
    - System prompt defining climbing coach role and JSON output format
    - User prompt function that injects pattern analysis and preferences
    - Example JSON structure demonstrating expected drill format
    - Technical terminology (hangboard, campus board, antagonistic training)
  </done>
</task>

<task type="auto">
  <name>Task 3: Add OpenRouter API call with JSON output format</name>
  <files>supabase/functions/openrouter-coach/index.ts</files>
  <action>
    Add OpenRouter API integration:

    1. After prompt construction, call OpenAI SDK:
       ```typescript
       const response = await openai.chat.completions.create({
         model: 'openai/gpt-4o-mini',
         messages: [
           { role: 'system', content: systemPrompt },
           { role: 'user', content: userPrompt }
         ],
         temperature: 0.6,
         response_format: { type: 'json_object' }
       })
       ```

    2. Extract content and usage:
       ```typescript
       const content = response.choices[0].message.content
       const usage = response.usage // { prompt_tokens, completion_tokens, total_tokens }
       ```

    3. Wrap API call in try/catch:
       - Log error with details (error.message, status code if available)
       - Return Response.json({ error: error.message }, { status: 500 })
       - Include usage tracking placeholder (will be implemented in 20-02)

    4. Return success response:
       ```typescript
       return Response.json({
         content: JSON.parse(content),
         usage: {
           prompt_tokens: usage.prompt_tokens,
           completion_tokens: usage.completion_tokens,
           total_tokens: usage.total_tokens
         }
       })
       ```

    5. Add environment variable validation at function startup:
       ```typescript
       const requiredEnvVars = ['OPENROUTER_API_KEY', 'SUPABASE_URL', 'SB_PUBLISHABLE_KEY']
       for (const envVar of requiredEnvVars) {
         if (!Deno.env.get(envVar)) {
           throw new Error(`Missing required environment variable: ${envVar}`)
         }
       }
       ```
  </action>
  <verify>
    Check that:
    - API call uses 'openai/gpt-4o-mini' model
    - Temperature is set to 0.6
    - response_format: { type: 'json_object' } is included
    - Both system and user messages are sent
    - API call is wrapped in try/catch with error logging
    - Environment variables are validated at startup
    - Response includes content (parsed JSON) and usage data
  </verify>
  <done>
    OpenRouter API integration added with:
    - gpt-4o-mini model with temperature 0.6
    - JSON output format requested
    - System + user message structure
    - Error handling with logging
    - Environment variable validation
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `deno check supabase/functions/openrouter-coach/index.ts`
2. File structure exists: `ls -la supabase/functions/openrouter-coach/` shows index.ts
3. No syntax errors in Edge Function code
4. All required environment variables are documented in user_setup
</verification>

<success_criteria>
1. Edge Function `openrouter-coach` created with handler, JWT validation, and OpenRouter integration
2. Climbing-specific prompts use technical terminology and request structured JSON output
3. API call configured with correct model, temperature, and JSON format
4. User knows to set OPENROUTER_API_KEY in Supabase Dashboard
</success_criteria>

<output>
After completion, create `.planning/phases/20-llm-integration/20-01-SUMMARY.md`
</output>
