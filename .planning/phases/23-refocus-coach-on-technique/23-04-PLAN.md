---
phase: 23-refocus-coach-on-technique
plan: 04
type: execute
wave: 2
depends_on: [23-03]
files_modified: [src/services/coach.ts]
autonomous: true

must_haves:
  truths:
    - "Client service fetches recent climbs before calling Edge Function"
    - "Recent climbs are included in request body"
    - "Function return type includes recent_climbs field"
  artifacts:
    - path: "src/services/coach.ts"
      provides: "Updated generateRecommendations with recent climbs"
      contains: "extractRecentClimbs"
      contains: "recent_climbs"
  key_links:
    - from: "src/services/coach.ts"
      to: "src/services/patterns.ts"
      via: "extractRecentClimbs import"
      pattern: "import.*extractRecentClimbs"
---

<objective>
Update the client coach service to fetch recent climbs and include them in the request to the Edge Function.

Purpose: Send raw climb data (last 30 climbs) to the Edge Function so the LLM can identify patterns and provide more personalized technique recommendations.

Output: Updated generateRecommendations function that includes recent_climbs in the request body.
</object>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/23-refocus-coach-on-technique/23-CONTEXT.md
@.planning/phases/23-refocus-coach-on-technique/23-RESEARCH.md

@src/services/coach.ts
@src/services/patterns.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add extractRecentClimbs import</name>
  <files>src/services/coach.ts</files>
  <action>
Add import for extractRecentClimbs at the top of the file:

1. Add to existing imports: `import { extractPatterns, extractRecentClimbs } from '@/services/patterns'`
2. Keep the existing extractPatterns import (update it to include extractRecentClimbs)
3. Keep all other imports unchanged

Do NOT modify any other part of the file.
</action>
  <verify>grep "import.*extractRecentClimbs" src/services/coach.ts</verify>
  <done>extractRecentClimbs is imported from '@/services/patterns'</done>
</task>

<task type="auto">
  <name>Task 2: Add AnonymizedClimb import</name>
  <files>src/services/coach.ts</files>
  <action>
Add import for AnonymizedClimb type to the types import:

1. Update the existing types import to include AnonymizedClimb
2. Change: `import type { Climb } from '@/types'`
3. To: `import type { Climb, AnonymizedClimb } from '@/types'`

Do NOT modify any other part of the file.
</action>
  <verify>grep "import type.*AnonymizedClimb" src/services/coach.ts</verify>
  <done>AnonymizedClimb type is imported from '@/types'</done>
</task>

<task type="auto">
  <name>Task 3: Fetch recent climbs in generateRecommendations</name>
  <files>src/services/coach.ts</files>
  <action>
Update the generateRecommendations function to fetch recent climbs:

1. After the existing `const patterns = await extractPatterns(user.id)` line
2. Add: `const recentClimbs = await extractRecentClimbs(user.id)`
3. This fetches the last 30 climbs anonymized for the LLM
4. Do NOT modify the existing patterns extraction logic

Place this line immediately after extractPatterns call, before the Edge Function invoke call.

Do NOT modify any other part of the function.
</action>
  <verify>grep -A 2 "const patterns = await extractPatterns" src/services/coach.ts | grep "extractRecentClimbs"</verify>
  <done>generateRecommendations fetches recent climbs after extracting patterns</done>
</task>

<task type="auto">
  <name>Task 4: Include recent_climbs in Edge Function request body</name>
  <files>src/services/coach.ts</files>
  <action>
Update the Edge Function invoke call to include recent_climbs in the request body:

1. Find the supabase.functions.invoke('openrouter-coach') call
2. Add `recent_climbs: recentClimbs` to the body object
3. The body should include: user_id, patterns_data, user_preferences, recent_climbs
4. recent_climbs should be the AnonymizedClimb[] fetched from extractRecentClimbs

The updated body should look like:
```typescript
body: {
  user_id: user.id,
  patterns_data: patterns,
  user_preferences: input.user_preferences,
  recent_climbs: recentClimbs,
},
```

Do NOT modify any other part of the function.
</action>
  <verify>grep -A 5 "supabase.functions.invoke" src/services/coach.ts | grep "recent_climbs"</verify>
  <done>Edge Function request includes recent_climbs field with AnonymizedClimb[] data</done>
</task>

</tasks>

<verification>
- [ ] extractRecentClimbs is imported
- [ ] AnonymizedClimb type is imported
- [ ] generateRecommendations fetches recent climbs
- [ ] Request body includes recent_climbs field
- [ ] TypeScript compiles without errors (pnpm typecheck)
</verification>

<success_criteria>
Client service fetches recent climbs and includes them in the Edge Function request body as recent_climbs field.
</success_criteria>

<output>
After completion, create `.planning/phases/23-refocus-coach-on-technique/23-04-SUMMARY.md`
</output>
