---
phase: 23-refocus-coach-on-technique
plan: 05
type: execute
wave: 2
depends_on: [23-04]
files_modified: [supabase/functions/openrouter-coach/index.ts]
autonomous: true

must_haves:
  truths:
    - "RequestBody interface includes recent_climbs field"
    - "buildUserPrompt accepts and includes recent climbs"
    - "User prompt formats recent climbs in compact JSON"
  artifacts:
    - path: "supabase/functions/openrouter-coach/index.ts"
      provides: "Edge Function that processes recent climbs"
      contains: "recent_climbs: AnonymizedClimb[]"
      contains: "Recent Climb History"
  key_links:
    - from: "RequestBody interface"
      to: "buildUserPrompt function"
      via: "recent_climbs parameter"
      pattern: "recent_climbs.*AnonymizedClimb"
---

<objective>
Update the Edge Function to accept and process recent climbs in the user prompt.

Purpose: Include raw climb data (last 30 climbs) in the LLM prompt so it can identify patterns and provide more personalized technique recommendations.

Output: Edge Function that accepts recent_climbs in request body and includes them in the user prompt.
</object>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/23-refocus-coach-on-technique/23-CONTEXT.md
@.planning/phases/23-refocus-coach-on-technique/23-RESEARCH.md

@supabase/functions/openrouter-coach/index.ts
@src/types/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add AnonymizedClimb interface</name>
  <files>supabase/functions/openrouter-coach/index.ts</files>
  <action>
Add the AnonymizedClimb interface to the Edge Function:

1. Add after the UserPreferences interface (around line 55)
2. Define the interface matching the TypeScript type:
```typescript
interface AnonymizedClimb {
  location: string
  grade_scale: string
  grade_value: string
  climb_type: string
  style: string[]
  outcome: string
  awkwardness: number
  failure_reasons: string[]
  notes?: string | null
  date: string
}
```
3. Keep all other interfaces unchanged

This matches the AnonymizedClimb type from src/types/index.ts (which was updated in Plan 23-01).

Do NOT modify any other interfaces.
</action>
  <verify>grep -A 12 "interface AnonymizedClimb" supabase/functions/openrouter-coach/index.ts | grep "notes:"</verify>
  <done>AnonymizedClimb interface exists with all required fields including notes and date</done>
</task>

<task type="auto">
  <name>Task 2: Update RequestBody interface</name>
  <files>supabase/functions/openrouter-coach/index.ts</files>
  <action>
Update the RequestBody interface to include recent_climbs:

1. Add `recent_climbs?: AnonymizedClimb[]` field to the RequestBody interface
2. Make it optional (using `?`) since older clients might not send it
3. Place it after user_preferences field

The RequestBody should look like:
```typescript
interface RequestBody {
  user_id: string
  patterns_data: PatternAnalysis
  user_preferences: UserPreferences
  recent_climbs?: AnonymizedClimb[]
}
```

Do NOT modify any other interfaces.
</action>
  <verify>grep -A 5 "interface RequestBody" supabase/functions/openrouter-coach/index.ts | grep "recent_climbs"</verify>
  <done>RequestBody interface includes recent_climbs field</done>
</task>

<task type="auto">
  <name>Task 3: Update buildUserPrompt function signature</name>
  <files>supabase/functions/openrouter-coach/index.ts</files>
<action>
Update the buildUserPrompt function to accept recent climbs:

1. Update function signature: `function buildUserPrompt(patterns: PatternAnalysis, preferences: UserPreferences, recentClimbs?: AnonymizedClimb[]): string`
2. Add `recentClimbs?: AnonymizedClimb[]` parameter (optional, default undefined)
3. Keep the existing `patterns` and `preferences` parameters
4. Keep the return type as `string`

Do NOT modify the function body yet (that's the next task).
</action>
  <verify>grep "function buildUserPrompt" supabase/functions/openrouter-coach/index.ts | grep "recentClimbs"</verify>
  <done>buildUserPrompt accepts recentClims parameter</done>
</task>

<task type="auto">
  <name>Task 4: Add recent climbs to user prompt</name>
  <files>supabase/functions/openrouter-coach/index.ts</files>
  <action>
Update the buildUserPrompt function body to include recent climbs:

1. After the "Recent Successes" section, add a new "Recent Climb History" section
2. Add before the final request section (before "Based on this data, provide:")
3. Format as compact JSON to save tokens:
```typescript
// Add recent climb history
if (recentClimbs && recentClimbs.length > 0) {
  prompt += `\nRecent Climb History (last 30 climbs):
${JSON.stringify(recentClimbs, null, 0)}\n`
}
```

Use `JSON.stringify(recentClimbs, null, 0)` for compact JSON (no indentation). This saves tokens compared to pretty-printed JSON.

The section should be placed between "Recent Successes" and the final request section.

Do NOT modify any other sections of the prompt builder.
</action>
  <verify>grep "Recent Climb History" supabase/functions/openrouter-coach/index.ts</verify>
  <done>User prompt includes "Recent Climb History" section with compact JSON</done>
</task>

<task type="auto">
  <name>Task 5: Pass recent_climbs to buildUserPrompt</name>
  <files>supabase/functions/openrouter-coach/index.ts</files>
  <action>
Update the call to buildUserPrompt to pass recent_climbs:

1. Find: `const userPrompt = buildUserPrompt(body.patterns_data, body.user_preferences)`
2. Change to: `const userPrompt = buildUserPrompt(body.patterns_data, body.user_preferences, body.recent_climbs)`
3. This passes the recent_climbs from the request body to the prompt builder

Place this update in the main handler function, before the LLM API call.

Do NOT modify any other parts of the handler.
</action>
  <verify>grep "buildUserPrompt" supabase/functions/openrouter-coach/index.ts | grep "body.recent_climbs"</verify>
  <done>buildUserPrompt is called with recent_climbs from request body</done>
</task>

</tasks>

<verification>
- [ ] AnonymizedClimb interface exists in Edge Function
- [ ] RequestBody includes recent_climbs field
- [ ] buildUserPrompt accepts recentClimbs parameter
- [ ] User prompt includes "Recent Climb History" section
- [ ] buildUserPrompt is called with recent_climbs argument
- [ ] Edge Function compiles without errors
</verification>

<success_criteria>
Edge Function accepts recent_climbs in request body, passes them to buildUserPrompt, and includes them in the user prompt as "Recent Climb History" section.
</success_criteria>

<output>
After completion, create `.planning/phases/23-refocus-coach-on-technique/23-05-SUMMARY.md`
</output>
