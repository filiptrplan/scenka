---
phase: 23-refocus-coach-on-technique
plan: 03
type: execute
wave: 2
depends_on: [23-01]
files_modified: [src/services/patterns.ts]
autonomous: true

must_haves:
  truths:
    - "New function fetches last 30 climbs for LLM context"
    - "Climbs are anonymized before return"
    - "Function returns AnonymizedClimb[] type"
  artifacts:
    - path: "src/services/patterns.ts"
      provides: "extractRecentClimbs function"
      exports: ["extractRecentClimbs"]
  key_links:
    - from: "src/services/patterns.ts"
      to: "src/lib/coachUtils.ts"
      via: "anonymizeClimbsForAI import"
      pattern: "import.*anonymizeClimsForAI"
---

<objective>
Add a new function to patterns.ts that fetches the last 30 climbs and anonymizes them for LLM context.

Purpose: Provide raw climb data to the LLM so it can identify its own patterns and provide more nuanced technique recommendations.

Output: New extractRecentClimbs function that returns AnonymizedClimb[].
</object>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/23-refocus-coach-on-technique/23-CONTEXT.md
@.planning/phases/23-refocus-coach-on-technique/23-RESEARCH.md

@src/services/patterns.ts
@src/lib/coachUtils.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add extractRecentClimbs function</name>
  <files>src/services/patterns.ts</files>
  <action>
Add a new function extractRecentClimbs that fetches and anonymizes the last 30 climbs:

1. Add import at top: `import { anonymizeClimbsForAI } from '@/lib/coachUtils'`
2. Create the function signature: `export async function extractRecentClimbs(userId: string): Promise<AnonymizedClimb[]>`
3. Add type import for AnonymizedClimb: add to existing type imports from '@/types'
4. Inside the function:
   - Check if supabase is configured (throw error if not)
   - Query climbs table: select('*'), eq('user_id', userId), order('created_at', { ascending: false }), limit(30)
   - Handle errors (throw error)
   - Return empty array if no climbs: `return []`
   - Return anonymized climbs: `return anonymizeClimbsForAI(climbs)`

Place this function after the existing extractPatterns function, before the helper functions.

Do NOT modify the existing extractPatterns function or any helper functions.
</action>
  <verify>
grep -A 5 "export async function extractRecentClimbs" src/services/patterns.ts | grep "anonymizeClimsForAI"
</verify>
  <done>extractRecentClimbs function exists and returns AnonymizedClimb[]</done>
</task>

</tasks>

<verification>
- [ ] extractRecentClimbs function exists in patterns.ts
- [ ] Function imports and uses anonymizeClimbsForAI
- [ ] Function returns AnonymizedClimb[] type
- [ ] Query limits to 30 climbs and orders by date descending
- [ ] Function handles empty result case correctly
- [ ] TypeScript compiles without errors (pnpm typecheck)
</verification>

<success_criteria>
extractRecentClimbs function fetches last 30 climbs, anonymizes them using anonymizeClimbsForAI, and returns AnonymizedClimb[].
</success_criteria>

<output>
After completion, create `.planning/phases/23-refocus-coach-on-technique/23-03-SUMMARY.md`
</output>
