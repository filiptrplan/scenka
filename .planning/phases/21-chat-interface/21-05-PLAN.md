---
phase: 21-chat-interface
plan: 05
type: execute
wave: 4
depends_on: [21-01, 21-02, 21-03, 21-04]
files_modified:
  - src/components/features/coach-chat-page.tsx
autonomous: false
user_setup: []

must_haves:
  truths:
    - "Empty chat state shows helpful welcome message"
    - "Loading states display during data fetch (messages, patterns)"
    - "Error messages are user-friendly and actionable"
    - "Streaming errors don't crash the UI"
    - "Retrying after error is possible"
  artifacts:
    - path: "src/components/features/coach-chat-page.tsx"
      provides: "Enhanced chat UI with loading and error states"
      min_lines: 200
      contains: "loading state", "error state", "empty state", "error handling"
  key_links:
    - from: "src/components/features/coach-chat-page.tsx"
      to: "error messages"
      via: "fallback messages for failures"
      pattern: "Sorry, I had trouble"
---

<objective>
Add loading states, error handling, and empty states to chat interface

Purpose: Provide clear feedback during all application states (loading, error, success) and improve UX with helpful messages
Output: Enhanced src/components/features/coach-chat-page.tsx with robust state handling
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@src/components/features/coach-page.tsx
@src/components/features/coach-chat-page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add empty chat state with welcome message</name>
  <files>src/components/features/coach-chat-page.tsx</files>
  <action>
Add empty state when no messages exist:

1. Check if messages array is empty or undefined
2. Display welcome message in message area:
   - Center the message in scroll area
   - Show helpful text: "No messages yet. Ask your climbing coach a question to get started!"
   - Suggested questions (clickable chips):
     - "How can I improve finger strength?"
     - "What's a good warm-up routine?"
     - "How do I tackle overhangs?"

3. Style to match existing coach page (text-[#888], spacing, consistent typography)

Reference: Empty state pattern in src/components/features/coach-page.tsx
</action>
  <verify>cat src/components/features/coach-chat-page.tsx | grep -E "(messages.*length.*0|No messages yet|suggested questions)"</verify>
  <done>Empty state shows welcome message with suggested questions</done>
</task>

<task type="auto">
  <name>Task 2: Add loading states for initial data fetch</name>
  <files>src/components/features/coach-chat-page.tsx</files>
  <action>
Add loading indicators for message and pattern data:

1. Check isLoading from useCoachMessages and patternsLoading from usePatternAnalysis
2. If either is loading:
   - Show "Loading messages..." text centered in message area
   - Optionally show Loader2 spinner from lucide-react
   - Keep header and input visible (don't hide UI)

3. Loading state should appear before empty state (check loading first)
</action>
  <verify>cat src/components/features/coach-chat-page.tsx | grep -E "(isLoading.*messages|patternsLoading|Loading messages)"</verify>
  <done>Loading states display while fetching messages and patterns</done>
</task>

<task type="auto">
  <name>Task 3: Improve error messages and retry handling</name>
  <files>src/components/features/coach-chat-page.tsx</files>
<action>
Enhance error handling with actionable messages:

1. Check error from useCoachMessages and patternsError from usePatternAnalysis
2. If either has error:
   - Show error message in message area with red-400 text
   - Message format: "Failed to load messages. Please refresh the page."
   - Keep input field functional (users can still type if messages loaded)
   - Add "Retry" button that invalidates queries and refetches

3. Enhance streaming error messages in onError callback:
   - Distinguish between:
     - Network errors: "Connection lost. Check your internet and try again."
     - API errors: "Sorry, I'm having trouble right now. Please try again."
     - Auth errors: "Please sign in to chat with your coach."
   - Add timestamp to error messages for debugging

4. Allow retry after error:
   - Input field remains enabled after error
   - User can send a new message to retry automatically

Reference: Error handling pattern in src/components/features/coach-page.tsx
</action>
  <verify>cat src/components/features/coach-chat-page.tsx | grep -E "(error.*message|Connection lost|Please sign in|Retry)"</verify>
  <done>Error messages are user-friendly, context-specific, and actionable</done>
</task>

<task type="auto">
  <name>Task 4: Add optimistic UI improvements and visual feedback</name>
  <files>src/components/features/coach-chat-page.tsx</files>
<action>
Add visual polish and UX improvements:

1. Focus management:
   - Auto-focus input field on page mount (useEffect with inputRef)
   - Re-focus input after sending message

2. Input field improvements:
   - Show character count if approaching limit (optional, max 500 chars)
   - Disable Enter submit when input is empty
   - Allow Shift+Enter for newlines

3. Send button improvements:
   - Show loading spinner when isStreaming (already done)
   - Change text to "Sending..." when isStreaming (optional, icon sufficient)

4. Message timestamp display:
   - Show relative time below each message (e.g., "2 min ago")
   - Use formatDistanceToNow from date-fns
   - Small text-[#888] text-xs

5. Typing indicator polish:
   - Show animated dots (...) instead of just "Coach is typing..."
   - Add subtle animation for smooth appearance

Reference: Existing UI patterns in coach-page.tsx (timestamps, buttons)
</action>
  <verify>cat src/components/features/coach-chat-page.tsx | grep -E "(useEffect.*focus|formatDistanceToNow|timestamp)"</verify>
  <done>Visual polish includes focus management, timestamps, and improved feedback</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Enhanced chat interface with loading states, error handling, empty states, and visual polish</what-built>
  <how-to-verify>
    1. Start dev server: pnpm dev
    2. Navigate to http://localhost:5173/coach/chat (fresh session, no messages)
    3. Verify empty state shows welcome message with suggested questions
    4. Click a suggested question chip (if implemented)
    5. Verify input field is auto-focused
    6. Type and send a message
    7. Verify input re-focuses after sending
    8. Check message timestamps appear below each message
    9. Test loading state: Hard refresh page
    10. Verify "Loading messages..." appears briefly
    11. Test error state: Disconnect network, try to send message
    12. Verify helpful error message appears
    13. Reconnect network, send another message
    14. Verify retry works and error clears
    15. Verify typing indicator has smooth animation
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
1. Empty state displays welcome message with suggested questions
2. Loading state shows "Loading messages..." with optional spinner
3. Error state shows user-friendly message with retry button
4. Streaming errors have context-specific messages (network, API, auth)
5. Input field auto-focuses on mount and after sending
6. Message timestamps display using formatDistanceToNow
7. Typing indicator has smooth animation
8. Input field disabled when empty or streaming
9. Shift+Enter allows newlines in input
10. Retry possible after errors (input remains functional)
</verification>

<success_criteria>
1. Empty chats show helpful guidance
2. Loading states provide clear feedback
3. Errors are actionable with retry options
4. Visual polish improves overall UX (timestamps, focus, animations)
5. All states (empty, loading, error, success) handled gracefully
6. User can recover from errors without page refresh
</success_criteria>

<output>
After completion, create `.planning/phases/21-chat-interface/21-05-SUMMARY.md`
</output>
