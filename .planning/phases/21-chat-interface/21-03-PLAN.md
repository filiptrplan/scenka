---
phase: 21-chat-interface
plan: 03
type: execute
wave: 2
depends_on: [21-02]
files_modified:
  - src/components/features/chat-page.tsx
autonomous: true
user_setup: []

must_haves:
  truths:
    - "ChatPage component renders message list from useCoachMessages"
    - "MessageBubble component visually distinguishes user (right, blue) from assistant (left, gray)"
    - "User messages show right-aligned with blue background and rounded-br-sm"
    - "Assistant messages show left-aligned with gray background and rounded-bl-sm"
    - "Streaming response renders as temporary assistant message bubble"
    - "Typing indicator shows animated bouncing dots while isStreaming is true"
    - "Messages auto-scroll to bottom when new messages arrive"
    - "Timestamp displays in small text at bottom of each bubble"
  artifacts:
    - path: "src/components/features/chat-page.tsx"
      provides: "React chat interface with message bubbles and streaming"
      min_lines: 120
  key_links:
    - from: "src/components/features/chat-page.tsx"
      to: "useCoachMessages"
      via: "TanStack Query"
      pattern: "useCoachMessages\\(\\)"
    - from: "src/components/features/chat-page.tsx"
      to: "useStreamingChat"
      via: "React hook"
      pattern: "useStreamingChat\\(\\)"
    - from: "src/components/features/chat-page.tsx"
      to: "usePatternAnalysis"
      via: "React hook"
      pattern: "usePatternAnalysis\\(\\)"
---

<objective>
Create React chat interface with message bubbles, streaming display, typing indicator, and auto-scroll.

Purpose: Provide mobile-optimized chat UI that displays conversation history with visual distinction between user/assistant messages and real-time streaming responses.
Output: ChatPage component (src/components/features/chat-page.tsx) with message list, streaming bubble, typing indicator, and auto-scroll.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@src/components/features/coach-page.tsx
@src/hooks/useCoachMessages.ts
@src/hooks/useStreamingChat.ts
@src/hooks/useCoach.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ChatPage component with message bubbles</name>
  <files>src/components/features/chat-page.tsx</files>
  <action>
    Create src/components/features/chat-page.tsx with:

    1. Imports:
       - useRef, useEffect, useState from 'react'
       - Send from 'lucide-react'
       - Button from '@/components/ui/button'
       - Textarea from '@/components/ui/textarea'
       - useCoachMessages from '@/hooks/useCoachMessages'
       - import { usePatternAnalysis } from '@/hooks/useCoach'
       - useStreamingChat from '@/hooks/useStreamingChat'

    2. Export function ChatPage()

    3. State and hooks:
       - inputValue state (string, initialized to '')
       - messagesEndRef useRef<HTMLDivElement>(null)
       - textareaRef useRef<HTMLTextAreaElement>(null)
       - { data: messages, isLoading } from useCoachMessages()
       - { data: patterns } from usePatternAnalysis()
       - { sendMessage, streamingResponse, isStreaming, error, cleanup } from useStreamingChat()

    4. Auto-scroll effect:
       - useEffect dependent on [messages, streamingResponse]
       - messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' })

    5. Mobile focus effect:
       - useEffect dependent on [] (mount only)
       - If window.innerWidth < 768, textareaRef.current?.focus()

    6. Cleanup effect:
       - useEffect dependent on [cleanup]
       - Return cleanup function

    7. handleSend function:
       - Validate inputValue.trim() is not empty and not isStreaming
       - Store trimmed message
       - Set inputValue to ''
       - Call await sendMessage(message, patterns)

    8. handleKeyDown function:
       - If e.key === 'Enter' and !e.shiftKey:
         - Prevent default
         - void handleSend()

    9. Render:
       - Main div: min-h-screen bg-[#0a0a0a] text-[#f5f5f5] flex flex-col
       - Messages container: flex-1 overflow-y-auto p-4
       - Loading state: "Loading messages..." text if isLoading
       - Map messages: render MessageBubble with key=msg.id, message, isCurrentUser=(msg.role === 'user')
       - Streaming bubble: if streamingResponse, render assistant bubble with streamingResponse content
       - Typing indicator: if isStreaming, render TypingIndicator component
       - messagesEndRef div at bottom
       - Input container: p-4 border-t border-white/10
       - Flex gap-2 with Textarea and Button
       - Textarea: ref=textareaRef, value=inputValue, onChange=setTextInputValue, onKeyDown=handleKeyDown, placeholder="Ask Coach a question...", disabled=isStreaming, rows=1, className="flex-1 min-h-[44px] resize-none bg-white/[0.02] border-white/20"
       - Button: onClick=handleSend, disabled=!inputValue.trim() || isStreaming, className="h-[44px] w-[44px] flex-shrink-0 bg-white text-black hover:bg-white/90", Send icon h-4 w-4
       - Error message: if error, render red text div

    10. MessageBubble component (inline):
        - Props: message, isCurrentUser
        - Render div with flex justify-end if isCurrentUser else justify-start, mb-4
        - Inner div: max-w-[80%] rounded-2xl px-4 py-2
        - User style: bg-blue-600 text-white rounded-br-sm
        - Assistant style: bg-gray-700 text-gray-100 rounded-bl-sm
        - Content div: text-sm leading-relaxed whitespace-pre-wrap for message.content
        - Timestamp div: text-xs mt-1, blue-200 for user, gray-400 for assistant, formatted with toLocaleTimeString

    11. TypingIndicator component (inline):
        - Render div mb-4 flex items-center gap-2 px-4
        - Animated dots: 3 span elements with w-2 h-2 bg-gray-400 rounded-full animate-bounce, animation delays 0ms, 150ms, 300ms
        - Text: "Coach is thinking..." in text-xs text-gray-400

    Reference coach-page.tsx for styling patterns (bg-[#0a0a0a], border-white/10, etc.) and layout structure.
  </action>
  <verify>
    Check chat-page.tsx exists and exports ChatPage component. Verify MessageBubble, TypingIndicator components are defined. Check imports of useStreamingChat, useCoachMessages, and usePatternAnalysis (imported as named export from @/hooks/useCoach) are present.
  </verify>
  <done>
    ChatPage component renders message bubbles with visual distinction, streaming display, typing indicator, and auto-scroll
  </done>
</task>

</tasks>

<verification>
Overall phase checks:
- ChatPage component exists and exports correctly
- MessageBubble distinguishes user (blue, right) from assistant (gray, left)
- Streaming response renders as temporary assistant bubble
- Typing indicator shows animated dots while streaming
- Auto-scroll keeps newest messages visible
- 44px minimum touch targets on input and button
- Timestamps display on all message bubbles
</verification>

<success_criteria>
React chat interface operational with message bubbles, streaming display, typing indicator, and auto-scroll
</success_criteria>

<output>
After completion, create `.planning/phases/21-chat-interface/21-03-SUMMARY.md`
</output>
