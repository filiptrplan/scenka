---
phase: 21-chat-interface
plan: 03
type: execute
wave: 3
depends_on: [21-01, 21-02]
files_modified:
  - src/components/features/coach-chat-page.tsx
  - src/App.tsx
autonomous: false
user_setup:
  - service: supabase
    why: "Edge Function deployment"
    env_vars: []
    dashboard_config: []

must_haves:
  truths:
    - "Chat page renders message list with user/assistant bubbles"
    - "User messages aligned right (white bg, black text)"
    - "Assistant messages aligned left (transparent bg, white text)"
    - "Text input with send button (h-12 for 48px touch targets)"
    - "Send button disabled when input empty or streaming"
    - "Messages auto-scroll to bottom on new content"
  artifacts:
    - path: "src/components/features/coach-chat-page.tsx"
      provides: "React chat interface component"
      min_lines: 150
      contains: "CoachChatPage", "message bubbles", "auto-scroll", "Send button"
  key_links:
    - from: "src/components/features/coach-chat-page.tsx"
      to: "useCoachMessages hook"
      via: "Import and use message query"
      pattern: "useCoachMessages"
    - from: "src/components/features/coach-chat-page.tsx"
      to: "usePatternAnalysis hook"
      via: "Import and use patterns query"
      pattern: "usePatternAnalysis"
    - from: "src/components/features/coach-chat-page.tsx"
      to: "streamChatResponse service"
      via: "Import and call streaming function"
      pattern: "streamChatResponse"
---

<objective>
Create React chat interface component with message bubbles, streaming input, and auto-scroll

Purpose: Provide users with a polished mobile-optimized chat UI for asking questions and receiving real-time climbing coaching advice
Output: src/components/features/coach-chat-page.tsx component
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-chat-interface/21-RESEARCH.md

@src/components/features/coach-page.tsx
@src/hooks/useCoachMessages.ts
@src/hooks/useCoach.ts
@src/services/coach-chat.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Chat page component with message display and state</name>
  <files>src/components/features/coach-chat-page.tsx</files>
  <action>
Create src/components/features/coach-chat-page.tsx with CoachChatPage component:

1. Imports:
   - useState, useRef, useEffect from 'react'
   - useNavigate from 'react-router-dom'
   - Send, Loader2, ArrowLeft from 'lucide-react'
   - ScrollArea from @/components/ui/scroll-area
   - Input from @/components/ui/input
   - Button from @/components/ui/button
   - FormLabel from @/components/ui/form-label
   - useCoachMessages, useCreateCoachMessage from @/hooks/useCoachMessages
   - usePatternAnalysis from @/hooks/useCoach
   - streamChatResponse from @/services/coach-chat

2. Component state:
   - input: string (text input value)
   - isStreaming: boolean (active response state)
   - streamingContent: string (accumulated response for display)
   - scrollRef: useRef<HTMLDivElement> (for auto-scroll)

3. Hooks:
   - useNavigate for back navigation
   - useCoachMessages() to fetch message history
   - useCreateCoachMessage() to save messages
   - usePatternAnalysis() to fetch climbing patterns

4. Layout structure (dark theme bg-[#0a0a0a]):
   - Header with back button and "Chat" title
   - ScrollArea (h-[60vh]) with message container
   - Input area with text field and send button

Do NOT implement handleSend or streaming logic yet - just UI structure and state initialization.
</action>
  <verify>cat src/components/features/coach-chat-page.tsx | grep -E "(CoachChatPage|useState|useRef|useNavigate|useCoachMessages|usePatternAnalysis)"</verify>
  <done>Chat page component with state, hooks, and layout structure created</done>
</task>

<task type="auto">
  <name>Task 2: Message rendering with auto-scroll</name>
  <files>src/components/features/coach-chat-page.tsx</files>
  <action>
Add message rendering with auto-scroll functionality:

1. Implement auto-scroll effect:
   - useEffect that runs when messages or streamingContent changes
   - If scrollRef.current exists, set scrollTop = scrollHeight

2. Render message list inside scroll container:
   - Map over messages from useCoachMessages hook
   - Each message renders as flex container (justify-end for user, justify-start for assistant)
   - Message bubble div with max-w-[80%], rounded-lg, px-4, py-3
   - User bubble: bg-white text-black
   - Assistant bubble: bg-white/[0.1] text-[#f5f5f5]
   - Message text: text-sm leading-relaxed whitespace-pre-wrap

3. Add streaming message indicator:
   - If isStreaming and streamingContent exists, show assistant bubble with streaming content
   - If isStreaming and !streamingContent, show "Coach is typing..." with Loader2 icon

Reference: src/components/features/coach-page.tsx for styling patterns (dark theme, typography)
</action>
  <verify>cat src/components/features/coach-chat-page.tsx | grep -E "(scrollTop.*scrollHeight|streamingContent|justify-end|justify-start)"</verify>
  <done>Messages render with proper alignment, colors, and auto-scroll on new content</done>
</task>

<task type="auto">
  <name>Task 3: Input area with send button and streaming logic</name>
  <files>src/components/features/coach-chat-page.tsx</files>
  <action>
Implement input handling and streaming logic:

1. Input area layout (flex gap-2, fixed at bottom):
   - Input component:
     - value={input}, onChange=(e) => setInput(e.target.value)
     - onKeyDown: Enter (without Shift) triggers handleSend, Shift+Enter for newline
     - placeholder: "Ask about training, beta, or technique..."
     - disabled={isStreaming}
     - h-12 text-base (48px touch target)
   - Send button:
     - onClick={() => void handleSend()}
     - disabled={!input.trim() || isStreaming}
     - size="lg", h-12 px-6
     - Show Loader2 icon (animate-spin) when isStreaming, otherwise Send icon
     - bg-white text-black hover:bg-white/90

2. Implement handleSend function:
   - Early return if input empty or already streaming
   - Trim input, store in userMessage variable
   - Clear input state
   - Set isStreaming=true, reset streamingContent=''
   - Optimistically add user message via createMessage.mutate({ role: 'user', content: userMessage, context: {} })

Do NOT implement streamChatResponse call yet - just UI input handling and optimistic user message.
</action>
  <verify>cat src/components/features/coach-chat-page.tsx | grep -E "(handleSend|createMessage.mutate|onKeyDown|disabled.*isStreaming)"</verify>
  <done>Input handles text entry, keyboard submit, and optimistically adds user messages</done>
</task>

<task type="auto">
  <name>Task 4: Streaming integration with error handling</name>
  <files>src/components/features/coach-chat-page.tsx</files>
  <action>
Add streaming chat integration:

1. Complete handleSend with streamChatResponse call:
   - Inside try block after optimistic user message:
   - Call streamChatResponse({
       message: userMessage,
       patterns: patterns || getEmptyPatterns() (define helper function),
       onChunk: (chunk) => setStreamingContent(prev => prev + chunk),
       onComplete: () => {
         createMessage.mutate({
           role: 'assistant',
           content: streamingContent,
           context: { patterns_data: patterns }
         })
         setStreamingContent('')
         setIsStreaming(false)
       },
       onError: (err) => {
         console.error('Chat stream error:', err)
         createMessage.mutate({
           role: 'assistant',
           content: 'Sorry, I had trouble generating a response. Please try again.',
           context: { error: err.message }
         })
         setStreamingContent('')
         setIsStreaming(false)
       }
     })

2. Add catch block for stream initiation errors:
   - Log error, create error message via createMessage.mutate
   - Set isStreaming=false

3. Define getEmptyPatterns helper for cases where patterns not loaded:
   - Return PatternAnalysis with empty arrays and zero values

4. Add loading states for hooks (isLoading from useCoachMessages, patternsLoading from usePatternAnalysis)
   - Show "Loading..." message when loading

Reference: src/services/coach-chat.ts for streamChatResponse signature
</action>
  <verify>cat src/components/features/coach-chat-page.tsx | grep -E "(streamChatResponse|onChunk|onComplete|onError|getEmptyPatterns)"</verify>
  <done>Streaming integration complete with real-time updates, error handling, and message persistence</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete chat interface with message bubbles, streaming responses, auto-scroll, and mobile optimization</what-built>
  <how-to-verify>
    1. Start dev server: pnpm dev
    2. Navigate to http://localhost:5173/coach/chat
    3. Verify page loads with "Chat" header and back button
    4. Test message display (empty state shows no messages)
    5. Type a message (e.g., "How can I improve my crimp strength?")
    6. Click send or press Enter
    7. Verify user message appears immediately (right-aligned, white bubble)
    8. Verify "Coach is typing..." indicator shows
    9. Wait for streaming response (may require OPENROUTER_API_KEY configured)
    10. Verify response streams character-by-character (left-aligned, transparent bubble)
    11. Verify auto-scroll keeps latest message visible
    12. Test mobile view (resize to 375px):
      - Verify touch targets are 48px+ (h-12)
      - Verify keyboard doesn't hide messages (pb-24 padding in App.tsx)
      - Verify send button is tappable
    13. Test error handling (disconnect network mid-stream):
      - Verify fallback error message appears
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
1. CoachChatPage component exported from src/components/features/coach-chat-page.tsx
2. Message list renders with proper alignment (user right, assistant left)
3. User messages styled with bg-white text-black
4. Assistant messages styled with bg-white/[0.1] text-[#f5f5f5]
5. Auto-scroll keeps latest message visible
6. Input field h-12 (48px touch target)
7. Send button h-12 (48px touch target), disabled when input empty or streaming
8. StreamChatResponse integration with onChunk, onComplete, onError callbacks
9. Error messages saved to coach_messages table
10. Loading states displayed for initial data fetch
11. getEmptyPatterns helper handles missing patterns data
</verification>

<success_criteria>
1. User can type and send messages via text input and send button
2. User messages appear immediately (optimistic update)
3. Streaming responses appear character-by-character in real-time
4. Message bubbles visually distinguish user from assistant
5. Auto-scroll maintains visibility of latest messages
6. Send button properly disabled/enabled based on state
7. Typing indicator shows while waiting for first chunk
8. Error handling displays helpful fallback messages
9. Mobile touch targets meet 48px minimum
10. Keyboard doesn't hide message area on mobile
</success_criteria>

<output>
After completion, create `.planning/phases/21-chat-interface/21-03-SUMMARY.md`
</output>
