---
phase: 21-chat-interface
plan: 02
type: execute
wave: 2
depends_on: [21-01]
files_modified:
  - src/services/coach-chat.ts
  - package.json
autonomous: true
user_setup:
  - service: npm
    why: "Install @microsoft/fetch-event-source library"
    env_vars: []
    dashboard_config: []

must_haves:
  truths:
    - "@microsoft/fetch-event-source installed as dependency"
    - "streamChatResponse function accepts message, patterns, and callbacks"
    - "SSE connection handled with fetchEventSource (onopen, onmessage, onclose, onerror)"
    - "JWT token passed via Authorization header"
    - "Message and patterns sent in POST request body"
  artifacts:
    - path: "src/services/coach-chat.ts"
      provides: "Client-side SSE streaming service"
      min_lines: 50
      exports: ["streamChatResponse"]
  key_links:
    - from: "src/services/coach-chat.ts"
      to: "supabase/functions/openrouter-coach-chat"
      via: "fetchEventSource with Edge Function URL"
      pattern: "fetchEventSource.*openrouter-coach-chat"
    - from: "src/services/coach-chat.ts"
      to: "supabase client"
      via: "JWT token retrieval"
      pattern: "supabase.auth.getSession"
---

<objective>
Create client-side service for SSE streaming chat using @microsoft/fetch-event-source

Purpose: Provide React component with a clean API for streaming chat responses, handling auth, connection management, and error recovery
Output: src/services/coach-chat.ts with streamChatResponse function
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-chat-interface/21-RESEARCH.md

@supabase/functions/openrouter-coach-chat/index.ts
@src/types/index.ts
@src/hooks/useCoachMessages.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install @microsoft/fetch-event-source dependency</name>
  <files>package.json</files>
  <action>
Install the SSE client library:

1. Run: pnpm add @microsoft/fetch-event-source
2. Verify package.json includes the dependency
3. This library provides better API than native EventSource (supports POST with auth headers, error recovery)

Reference: @microsoft/fetch-event-source GitHub for API usage patterns
</action>
  <verify>grep "@microsoft/fetch-event-source" package.json</verify>
  <done>@microsoft/fetch-event-source installed as project dependency</done>
</task>

<task type="auto">
  <name>Task 2: Create streamChatResponse function with SSE handling</name>
  <files>src/services/coach-chat.ts</files>
  <action>
Create src/services/coach-chat.ts with streamChatResponse function:

1. Import dependencies:
   - fetchEventSource from @microsoft/fetch-event-source
   - supabase from @/lib/supabase
   - PatternAnalysis type from @/types

2. Define ChatStreamOptions interface:
   - message: string
   - patterns: PatternAnalysis
   - onChunk: (chunk: string) => void
   - onComplete: () => void
   - onError: (error: Error) => void

3. Implement streamChatResponse function:
   - Get Supabase session (await supabase.auth.getSession())
   - Throw error if not authenticated
   - Build Edge Function URL: ${import.meta.env.VITE_SUPABASE_URL}/functions/v1/openrouter-coach-chat
   - Call fetchEventSource with:
     - method: POST
     - headers: Content-Type, Authorization: Bearer ${session.access_token}
     - body: JSON.stringify({ message, patterns_data: patterns })
     - onopen(response): Validate response.ok and content-type === text/event-stream
     - onmessage(ev): Parse JSON, call onChunk(data.content) if content exists
     - onclose(): Call onComplete callback
     - onerror(err): Call onError callback, throw err (triggers retry)

4. Export streamChatResponse function

Reference: @microsoft/fetch-event-source GitHub for callback signatures
</action>
  <verify>cat src/services/coach-chat.ts | grep -E "(streamChatResponse|fetchEventSource|onChunk|onComplete|onError)"</verify>
  <done>streamChatResponse function handles SSE connection with proper auth, callbacks, and error handling</done>
</task>

</tasks>

<verification>
1. @microsoft/fetch-event-source installed in package.json
2. src/services/coach-chat.ts exists (min 50 lines)
3. streamChatResponse function exported
4. JWT token retrieved from supabase.auth.getSession()
5. POST request to openrouter-coach-chat Edge Function
6. onChunk callback streams real-time content
7. onComplete callback fires on stream completion
8. onError callback handles connection errors
9. Proper error thrown for unauthenticated sessions
</verification>

<success_criteria>
1. streamChatResponse can be called with message, patterns, and callbacks
2. SSE connection established to openrouter-coach-chat Edge Function
3. Streaming content delivered via onChunk callback
4. Completion signaled via onComplete callback
5. Errors handled via onError callback
6. JWT auth token passed correctly via Authorization header
</success_criteria>

<output>
After completion, create `.planning/phases/21-chat-interface/21-02-SUMMARY.md`
</output>
