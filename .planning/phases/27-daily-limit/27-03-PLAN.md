---
phase: 27-daily-limit
plan: 03
type: execute
wave: 2
depends_on: [27-01]
files_modified: [supabase/functions/openrouter-chat/index.ts]
autonomous: true
must_haves:
  truths:
    - "openrouter-chat Edge Function checks daily chat limit before streaming"
    - "Limit check happens before storing user message or starting stream"
    - "Function returns 429 with error message when limit exceeded"
    - "Counter increments atomically before allowing request to proceed"
  artifacts:
    - path: "supabase/functions/openrouter-chat/index.ts"
      provides: "Chat streaming with daily limit enforcement"
      contains: ["DAILY_CHAT_LIMIT", "increment_chat_count", "status: 429"]
  key_links:
    - from: "supabase/functions/openrouter-chat/index.ts"
      to: "public.user_limits"
      via: "RPC call increment_chat_count"
      pattern: "supabase\\.rpc\\('increment_chat_count'"
    - from: "supabase/functions/openrouter-chat/index.ts"
      to: "OpenRouter API"
      via: "Limit check prevents API call when exceeded"
      pattern: "if.*chat_count.*>=.*dailyChatLimit.*return 429"
---

<objective>
Update openrouter-chat Edge Function to check daily chat limit before starting SSE stream, returning 429 when exceeded.

Purpose: Enforce daily limit of 10 chat messages per user before making expensive LLM API calls, preventing unnecessary costs.
Output: Edge Function with limit check that blocks requests at limit and increments counter atomically.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/phases/27-daily-limit/27-CONTEXT.md
@.planning/phases/27-daily-limit/27-RESEARCH.md
@.planning/phases/27-daily-limit/27-01-SUMMARY.md

@supabase/functions/openrouter-chat/index.ts
</context>

<tasks>

<task type="auto">
  <name>Add daily chat limit check to openrouter-chat Edge Function</name>
  <files>supabase/functions/openrouter-chat/index.ts</files>
  <action>
Update the Edge Function to enforce daily chat limit BEFORE making LLM API call and storing message.

1. Add DAILY_CHAT_LIMIT to requiredEnvVars array (after OPENROUTER_MODEL)
2. Read env var after existing env vars:
   const dailyChatLimit = parseInt(Deno.env.get('DAILY_CHAT_LIMIT') ?? '10')

3. After extracting userId from JWT (before fetching message history), add limit check logic:
   a. Query user_limits for current chat_count and limit_date:
      const { data: limits, error: limitsError } = await supabase
        .from('user_limits')
        .select('chat_count, limit_date')
        .eq('user_id', userId)
        .maybeSingle()  // Use maybeSingle() for users without limits yet

   b. Calculate if limit exceeded:
      const chatCount = limits?.chat_count ?? 0
      const limitDate = limits?.limit_date ? new Date(limits.limit_date) : new Date('1970-01-01')
      const today = new Date()
      today.setUTCHours(0, 0, 0, 0)

      // Reset count if new day (handle same-day check with comparison)
      const isSameDay = limitDate.toISOString().split('T')[0] === today.toISOString().split('T')[0]
      const effectiveCount = isSameDay ? chatCount : 0

      if (effectiveCount >= dailyChatLimit) {
        // Calculate hours until next reset (UTC midnight)
        const tomorrow = new Date(today)
        tomorrow.setUTCDate(tomorrow.getUTCDate() + 1)
        const hoursUntilReset = Math.ceil((tomorrow.getTime() - Date.now()) / (1000 * 60 * 60))

        const resetMessage = hoursUntilReset <= 1
          ? 'Next reset in less than 1 hour'
          : hoursUntilReset < 24
          ? `Next reset in ${hoursUntilReset} hours`
          : 'Next reset tomorrow at midnight UTC'

        return new Response(
          JSON.stringify({
            error: `You've reached your daily limit. ${resetMessage}`,
            limit_type: 'chat',
            current_count: effectiveCount,
            limit: dailyChatLimit,
          }),
          { status: 429, headers: corsHeaders }
        )
      }

4. Immediately after limit check (before storing user message), increment counter:
   await supabase.rpc('increment_chat_count', { p_user_id: userId })

5. Keep the rest of the function unchanged (message history, user message storage, LLM API call, streaming).

IMPORTANT: The increment happens BEFORE any LLM API call, ensuring we don't make expensive API calls for blocked requests.
IMPORTANT: No changes needed to streaming logic or SSE response handling.

NOTE: We calculate effectiveCount client-side in Edge Function to handle cases where limit_date != today (first request after reset). The RPC function handles the reset atomically.
</action>
  <verify>
1. Redeploy Edge Function: supabase functions deploy openrouter-chat --no-verify-jwt
2. Test with user at limit (simulate by manually setting chat_count=10 in database):
   - Call Edge Function with JWT token
   - Verify returns 429 status with error message
   - Verify error message contains "limit_type: chat"
   - Verify no LLM API call made (check logs)
3. Test with user below limit:
   - Call Edge Function with JWT token
   - Verify increments counter
   - Verify returns 200 with streaming response
4. Test with new user (no limits row):
   - Call Edge Function with JWT token
   - Verify creates limits row with chat_count=1
   - Verify returns 200 with streaming response
</verify>
  <done>
openrouter-chat Edge Function enforces daily chat limit by:
- Checking user_limits table before LLM API call
- Returning 429 with error message when limit exceeded (shows time until reset)
- Atomically incrementing counter via increment_chat_count RPC function
- Blocking expensive API calls for users at limit
</done>
</task>

</tasks>

<verification>
1. DAILY_CHAT_LIMIT env var added to requiredEnvVars
2. Limit check happens BEFORE LLM API call and message storage
3. Counter increments via RPC function BEFORE LLM API call
4. 429 response returned with clear error message when limit exceeded
5. Error message shows time until next UTC midnight reset
6. No LLM API calls made for requests at limit (verified in logs)
7. Streaming response works correctly when limit not exceeded
</verification>

<success_criteria>
openrouter-chat Edge Function enforces daily chat limit at Edge Function layer, preventing unnecessary LLM API costs for users who have exceeded their daily quota.
</success_criteria>

<output>
After completion, create `.planning/phases/27-daily-limit/27-03-SUMMARY.md`
</output>
