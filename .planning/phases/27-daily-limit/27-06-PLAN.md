---
phase: 27-daily-limit
plan: 06
type: execute
wave: 3
depends_on: [27-04]
files_modified: [src/components/features/chat-page.tsx]
autonomous: true
must_haves:
  truths:
    - "Chat page displays current chat usage count (e.g., '5/10 used today')"
    - "Counter appears inline next to Send button"
    - "Send button disabled when at limit (remaining <= 0)"
    - "Inline error message shows when at limit with time until reset"
    - "Counter refreshes after each action"
  artifacts:
    - path: "src/components/features/chat-page.tsx"
      provides: "Chat page with usage counter and limit enforcement"
      contains: ["useUserLimits", "isChatAtLimit", "chatCount/10 used today"]
  key_links:
    - from: "src/components/features/chat-page.tsx"
      to: "useUserLimits"
      via: "Import and call hook"
      pattern: "useUserLimits\\(\\)"
    - from: "src/components/features/chat-page.tsx"
      to: "user_limits table"
      via: "useUserLimits hook"
      pattern: "limits\\.chat_count"
---

<objective>
Update chat-page.tsx to display chat usage counter inline next to Send button and disable button at limit.

Purpose: Show users their daily chat usage and prevent actions when limit exceeded, with clear inline error messages.
Output: Chat page with inline counter display (e.g., "5/10 used today") and disabled button with error message at limit.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/phases/27-daily-limit/27-CONTEXT.md
@.planning/phases/27-daily-limit/27-RESEARCH.md
@.planning/phases/27-daily-limit/27-04-SUMMARY.md

@src/components/features/chat-page.tsx
@src/hooks/useUserLimits.ts
</context>

<tasks>

<task type="auto">
  <name>Add chat usage counter to chat-page.tsx</name>
  <files>src/components/features/chat-page.tsx</files>
  <action>
Update chat-page.tsx to display chat usage counter inline next to Send button.

1. Add import for useUserLimits and getTimeUntilNextReset:
   import { useUserLimits, getTimeUntilNextReset } from '@/hooks/useUserLimits'

2. In ChatPage component (around line 95-100), add hook call after existing hooks:
   const { data: limits } = useUserLimits()

3. Add constants for limit calculation after hooks:
   const dailyChatLimit = 10
   const chatCount = limits?.chat_count ?? 0
   const chatRemaining = Math.max(0, dailyChatLimit - chatCount)
   const isChatAtLimit = chatRemaining <= 0

4. Find the handleSend function (around line 110-120). Add client-side limit check:
   const handleSend = async () => {
     if (isChatAtLimit) {
       toast.error('You have reached your daily chat limit')
       return
     }

     if (!inputValue.trim()) {
       return
     }

     try {
       await sendMessage(inputValue, patterns, profile?.climbing_context ?? null)
       setInputValue('')
     } catch (error) {
       console.error('Failed to send message:', error)
     }
   }

5. Find the Send button and Textarea container (around line 150-170). Update the button:
   a. Add disabled prop: disabled={!inputValue.trim() || isStreaming || isChatAtLimit}
   b. Keep existing className and styling

6. Immediately after the Send button, add inline counter display:
   <span className="text-xs text-[#888]">
     {chatCount}/{dailyChatLimit} used today
   </span>

   Wrap the button and counter in a flex container:
   <div className="flex items-center gap-2">
     <Button
       onClick={handleSend}
       disabled={!inputValue.trim() || isStreaming || isChatAtLimit}
     >
       <Send className="h-4 w-4" />
     </Button>
     <span className="text-xs text-[#888]">
       {chatCount}/{dailyChatLimit} used today
     </span>
   </div>

7. After the flex container, add inline error message when at limit:
   {isChatAtLimit && (
     <p className="text-xs text-red-400 mt-2">
       {getTimeUntilNextReset()}
     </p>
   )}

8. Also check if there's an error state in useStreamingChat and use that if available:
   const { error: chatError } = useStreamingChat()
   {isChatAtLimit && (chatError || isChatAtLimit) && (
     <p className="text-xs text-red-400 mt-2">
       {chatError?.message || getTimeUntilNextReset()}
     </p>
   )}

9. Verify the toast notification appears when user tries to send at limit (from handleSend check).

IMPORTANT: Display inline counter text, NOT progress bar (CONTEXT.md requirement).
IMPORTANT: shadcn/ui Tooltip doesn't work on disabled elements - use inline error message instead.
IMPORTANT: The counter refreshes automatically because useUserLimits uses staleTime: 0 and mutations invalidate the query.
</action>
  <verify>
1. Run: pnpm typecheck
2. Run: pnpm lint
3. Verify imports are correct (useUserLimits, getTimeUntilNextReset)
4. Verify counter displays correctly (e.g., "0/10 used today", "5/10 used today", "10/10 used today")
5. Verify button disabled when isChatAtLimit is true (chatRemaining <= 0)
6. Verify error message appears when at limit
7. Verify error message shows time until reset (from getTimeUntilNextReset or API error)
8. Verify toast notification appears when user tries to send at limit
9. Check mobile responsiveness (counter text readable on small screens)
</verify>
  <done>
chat-page.tsx updated with:
- Inline chat usage counter (e.g., "5/10 used today") next to Send button
- Button disabled when limit reached (isChatAtLimit)
- Inline error message when at limit showing time until reset
- Toast notification when user tries to send at limit
- Counter refreshes after each action (via staleTime: 0 and query invalidation)
</done>
</task>

</tasks>

<verification>
1. Chat usage counter displays inline next to Send button
2. Counter shows current count out of daily limit (e.g., "5/10 used today")
3. Button is disabled when limit reached (remaining <= 0)
4. Inline error message appears when at limit
5. Error message shows time until reset (from getTimeUntilNextReset or API error)
6. Toast notification appears when user tries to send at limit
7. Counter refreshes after each successful chat message
8. No tooltip used (inline message instead, as shadcn/ui Tooltip doesn't work on disabled elements)
9. TypeScript type checking passes
10. Linting passes
11. UI is responsive on mobile devices
</verification>

<success_criteria>
Chat page displays chat usage counter inline and disables Send button at limit with clear error message showing time until reset.
</success_criteria>

<output>
After completion, create `.planning/phases/27-daily-limit/27-06-SUMMARY.md`
</output>
