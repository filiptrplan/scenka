---
phase: 27-daily-limit
plan: 02
type: execute
wave: 2
depends_on: [27-01]
files_modified: [supabase/functions/openrouter-coach/index.ts]
autonomous: true
must_haves:
  truths:
    - "openrouter-coach Edge Function checks daily recommendation limit before LLM API call"
    - "Limit check happens before any cost-incurring API calls"
    - "Function returns 429 with error message when limit exceeded"
    - "Counter increments atomically before allowing request to proceed"
  artifacts:
    - path: "supabase/functions/openrouter-coach/index.ts"
      provides: "Recommendation generation with daily limit enforcement"
      contains: ["DAILY_REC_LIMIT", "increment_rec_count", "status: 429"]
  key_links:
    - from: "supabase/functions/openrouter-coach/index.ts"
      to: "public.user_limits"
      via: "RPC call increment_rec_count"
      pattern: "supabase\\.rpc\\('increment_rec_count'"
    - from: "supabase/functions/openrouter-coach/index.ts"
      to: "OpenRouter API"
      via: "Limit check prevents API call when exceeded"
      pattern: "if.*rec_count.*>=.*dailyRecLimit.*return 429"
---

<objective>
Update openrouter-coach Edge Function to check daily recommendation limit before LLM API call, returning 429 when exceeded.

Purpose: Enforce daily limit of 2 recommendation generations per user before making expensive LLM API calls, preventing unnecessary costs.
Output: Edge Function with limit check that blocks requests at limit and increments counter atomically.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/phases/27-daily-limit/27-CONTEXT.md
@.planning/phases/27-daily-limit/27-RESEARCH.md
@.planning/phases/27-daily-limit/27-01-SUMMARY.md

@supabase/functions/openrouter-coach/index.ts
</context>

<tasks>

<task type="auto">
  <name>Add daily recommendation limit check to openrouter-coach Edge Function</name>
  <files>supabase/functions/openrouter-coach/index.ts</files>
  <action>
Update the Edge Function to enforce daily recommendation limit BEFORE making LLM API call.

1. Add DAILY_REC_LIMIT to requiredEnvVars array (after OPENROUTER_MODEL)
2. Read env var after existing env vars:
   const dailyRecLimit = parseInt(Deno.env.get('DAILY_REC_LIMIT') ?? '2')

3. After extracting userId from JWT (before patterns extraction), add limit check logic:
   a. Query user_limits for current rec_count and limit_date:
      const { data: limits, error: limitsError } = await supabase
        .from('user_limits')
        .select('rec_count, limit_date')
        .eq('user_id', userId)
        .maybeSingle()  // Use maybeSingle() for users without limits yet

   b. Calculate if limit exceeded:
      const recCount = limits?.rec_count ?? 0
      const limitDate = limits?.limit_date ? new Date(limits.limit_date) : new Date('1970-01-01')
      const today = new Date()
      today.setUTCHours(0, 0, 0, 0)

      // Reset count if new day (handle same-day check with comparison)
      const isSameDay = limitDate.toISOString().split('T')[0] === today.toISOString().split('T')[0]
      const effectiveCount = isSameDay ? recCount : 0

      if (effectiveCount >= dailyRecLimit) {
        // Calculate hours until next reset (UTC midnight)
        const tomorrow = new Date(today)
        tomorrow.setUTCDate(tomorrow.getUTCDate() + 1)
        const hoursUntilReset = Math.ceil((tomorrow.getTime() - Date.now()) / (1000 * 60 * 60))

        const resetMessage = hoursUntilReset <= 1
          ? 'Next reset in less than 1 hour'
          : hoursUntilReset < 24
          ? `Next reset in ${hoursUntilReset} hours`
          : 'Next reset tomorrow at midnight UTC'

        return new Response(
          JSON.stringify({
            error: `You've reached your daily limit. ${resetMessage}`,
            limit_type: 'recommendations',
            current_count: effectiveCount,
            limit: dailyRecLimit,
          }),
          { status: 429, headers: corsHeaders }
        )
      }

4. Immediately after limit check (before LLM API call), increment counter:
   await supabase.rpc('increment_rec_count', { p_user_id: userId })

5. IMPORTANT: The increment happens BEFORE any LLM API call, ensuring we don't make expensive API calls for blocked requests.

6. Keep the rest of the function unchanged (patterns extraction, LLM API call, JSON validation, storage).

NOTE: We calculate effectiveCount client-side in Edge Function to handle cases where limit_date != today (first request after reset). The RPC function handles the reset atomically.
</action>
  <verify>
1. Redeploy Edge Function: supabase functions deploy openrouter-coach --no-verify-jwt
2. Test with user at limit (simulate by manually setting rec_count=2 in database):
   - Call Edge Function with JWT token
   - Verify returns 429 status with error message
   - Verify error message contains "limit_type: recommendations"
   - Verify no LLM API call made (check logs)
3. Test with user below limit:
   - Call Edge Function with JWT token
   - Verify increments counter
   - Verify returns 200 with recommendations
4. Test with new user (no limits row):
   - Call Edge Function with JWT token
   - Verify creates limits row with rec_count=1
   - Verify returns 200 with recommendations
</verify>
  <done>
openrouter-coach Edge Function enforces daily recommendation limit by:
- Checking user_limits table before LLM API call
- Returning 429 with error message when limit exceeded (shows time until reset)
- Atomically incrementing counter via increment_rec_count RPC function
- Blocking expensive API calls for users at limit
</done>
</task>

</tasks>

<verification>
1. DAILY_REC_LIMIT env var added to requiredEnvVars
2. Limit check happens BEFORE LLM API call
3. Counter increments via RPC function BEFORE LLM API call
4. 429 response returned with clear error message when limit exceeded
5. Error message shows time until next UTC midnight reset
6. No LLM API calls made for requests at limit (verified in logs)
7. First request after reset correctly recalculates count
</verification>

<success_criteria>
openrouter-coach Edge Function enforces daily recommendation limit at Edge Function layer, preventing unnecessary LLM API costs for users who have exceeded their daily quota.
</success_criteria>

<output>
After completion, create `.planning/phases/27-daily-limit/27-02-SUMMARY.md`
</output>
