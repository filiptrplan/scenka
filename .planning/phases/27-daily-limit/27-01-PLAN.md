---
phase: 27-daily-limit
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [supabase/migrations/20260119140000_create_user_limits.sql]
autonomous: true
user_setup:
  - service: supabase
    why: "Set daily limit environment variables for Edge Functions"
    env_vars:
      - name: DAILY_REC_LIMIT
        source: "Run: supabase secrets set DAILY_REC_LIMIT=2"
      - name: DAILY_CHAT_LIMIT
        source: "Run: supabase secrets set DAILY_CHAT_LIMIT=10"

must_haves:
  truths:
    - "user_limits table exists with user_id, rec_count, chat_count, limit_date columns"
    - "RLS policies restrict access to user's own limits"
    - "increment_rec_count RPC function atomically increments recommendation counter with reset"
    - "increment_chat_count RPC function atomically increments chat counter with reset"
  artifacts:
    - path: "supabase/migrations/20260119140000_create_user_limits.sql"
      provides: "Database schema for user_limits table and RPC functions"
      contains: ["CREATE TABLE public.user_limits", "CREATE FUNCTION public.increment_rec_count", "CREATE FUNCTION public.increment_chat_count"]
  key_links:
    - from: "supabase/functions/openrouter-coach/index.ts"
      to: "public.increment_rec_count"
      via: "RPC call before LLM API"
      pattern: "supabase\\.rpc\\('increment_rec_count'"
    - from: "supabase/functions/openrouter-chat/index.ts"
      to: "public.increment_chat_count"
      via: "RPC call before LLM API"
      pattern: "supabase\\.rpc\\('increment_chat_count'"
---

<objective>
Create database foundation for daily usage limits with user_limits table, RLS policies, and atomic counter increment functions.

Purpose: Store daily usage counts (recommendations and chat) with UTC midnight reset, enforced at Edge Function layer.
Output: Database table with RLS policies and two RPC functions for atomic counter increments.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/phases/27-daily-limit/27-CONTEXT.md
@.planning/phases/27-daily-limit/27-RESEARCH.md

@supabase/migrations/20260117132100_create_coach_tables.sql
@supabase/migrations/20260105175621_create_profiles_table.sql
</context>

<tasks>

<task type="auto">
  <name>Create database migration for user_limits table and RPC functions</name>
  <files>supabase/migrations/20260119140000_create_user_limits.sql</files>
  <action>
Create migration file with timestamp 20260119140000 (2026-01-19 14:00:00 UTC) following existing pattern.

Add the following SQL content:

1. Create user_limits table:
   - user_id (UUID, PRIMARY KEY, references profiles.id ON DELETE CASCADE)
   - rec_count (INTEGER NOT NULL DEFAULT 0, CHECK >= 0)
   - chat_count (INTEGER NOT NULL DEFAULT 0, CHECK >= 0)
   - limit_date (DATE NOT NULL DEFAULT CURRENT_DATE)
   - updated_at (TIMESTAMPTZ NOT NULL DEFAULT now())

2. Enable RLS and create policies:
   - "Users can view own limits" (SELECT, auth.uid() = user_id)
   - No INSERT/UPDATE policies (Edge Functions use service role key)
   - Follow existing policy naming pattern from coach_recommendations table

3. Create index on limit_date (optional but recommended for daily reset queries)

4. Add comment on table documenting its purpose

5. Create increment_rec_count function:
   - Input: p_user_id UUID
   - Returns: VOID
   - Logic: INSERT with defaults (rec_count=1, chat_count=0, limit_date=CURRENT_DATE)
   - ON CONFLICT (user_id) DO UPDATE SET:
     - rec_count = CASE WHEN limit_date < CURRENT_DATE THEN 1 ELSE rec_count + 1 END
     - limit_date = CURRENT_DATE
     - updated_at = now()
   - Language: plpgsql

6. Create increment_chat_count function:
   - Input: p_user_id UUID
   - Returns: VOID
   - Logic: INSERT with defaults (rec_count=0, chat_count=1, limit_date=CURRENT_DATE)
   - ON CONFLICT (user_id) DO UPDATE SET:
     - chat_count = CASE WHEN limit_date < CURRENT_DATE THEN 1 ELSE chat_count + 1 END
     - limit_date = CURRENT_DATE
     - updated_at = now()
   - Language: plpgsql

7. Grant EXECUTE on both functions to authenticated users (for Edge Functions to call)
   - GRANT EXECUTE ON FUNCTION public.increment_rec_count(UUID) TO authenticated
   - GRANT EXECUTE ON FUNCTION public.increment_chat_count(UUID) TO authenticated

IMPORTANT: Use separate columns (rec_count, chat_count) NOT JSONB as specified in CONTEXT.md.
IMPORTANT: PostgreSQL CURRENT_DATE returns UTC date on Supabase servers (no explicit timezone handling needed).
IMPORTANT: The CASE statement handles both reset (new day) and increment in one atomic operation.
</action>
  <verify>
1. Run: npx supabase db push
2. Verify migration applies successfully
3. Connect to database: npx supabase db inspect
4. Confirm table exists: SELECT * FROM information_schema.tables WHERE table_name = 'user_limits'
5. Confirm functions exist: SELECT routine_name FROM information_schema.routines WHERE routine_schema = 'public' AND routine_name LIKE 'increment_%'
6. Test function with user_id (use a test user UUID):
   - SELECT public.increment_rec_count('test-uuid')
   - SELECT * FROM user_limits WHERE user_id = 'test-uuid'
   - Verify rec_count = 1, chat_count = 0, limit_date = CURRENT_DATE
</verify>
  <done>
Database migration created and applied with:
- user_limits table with RLS policies
- increment_rec_count RPC function that atomically increments recommendation counter with UTC midnight reset
- increment_chat_count RPC function that atomically increments chat counter with UTC midnight reset
- EXECUTE grants on both functions for authenticated users
</done>
</task>

</tasks>

<verification>
1. Migration file exists with correct timestamp format
2. Migration applies successfully via npx supabase db push
3. user_limits table created with correct schema (separate columns, not JSONB)
4. RLS policies restrict access to user's own limits only
5. Both RPC functions exist and are callable
6. Functions correctly increment counters and reset on new day
7. No existing tests broken by migration
</verification>

<success_criteria>
Daily usage limits database foundation is ready for Edge Function integration. Edge Functions can now call increment_rec_count and increment_chat_count to atomically track usage with UTC midnight reset.
</success_criteria>

<output>
After completion, create `.planning/phases/27-daily-limit/27-01-SUMMARY.md`
</output>
