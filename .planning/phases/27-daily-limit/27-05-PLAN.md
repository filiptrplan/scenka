---
phase: 27-daily-limit
plan: 05
type: execute
wave: 3
depends_on: [27-04]
files_modified: [src/components/features/coach-page.tsx]
autonomous: true
must_haves:
  truths:
    - "Coach page displays current recommendation usage count (e.g., '1/2 used today')"
    - "Counter appears inline next to Generate/Regenerate button"
    - "Button disabled when at limit (remaining <= 0)"
    - "Inline error message shows when at limit with time until reset"
    - "Counter refreshes after each action"
  artifacts:
    - path: "src/components/features/coach-page.tsx"
      provides: "Coach page with recommendation usage counter and limit enforcement"
      contains: ["useUserLimits", "isRecAtLimit", "recCount/2 used today"]
  key_links:
    - from: "src/components/features/coach-page.tsx"
      to: "useUserLimits"
      via: "Import and call hook"
      pattern: "useUserLimits\\(\\)"
    - from: "src/components/features/coach-page.tsx"
      to: "user_limits table"
      via: "useUserLimits hook"
      pattern: "limits\\.rec_count"
---

<objective>
Update coach-page.tsx to display recommendation usage counter inline next to Generate button and disable button at limit.

Purpose: Show users their daily recommendation usage and prevent actions when limit exceeded, with clear inline error messages.
Output: Coach page with inline counter display (e.g., "1/2 used today") and disabled button with error message at limit.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/phases/27-daily-limit/27-CONTEXT.md
@.planning/phases/27-daily-limit/27-RESEARCH.md
@.planning/phases/27-daily-limit/27-04-SUMMARY.md

@src/components/features/coach-page.tsx
@src/hooks/useUserLimits.ts
</context>

<tasks>

<task type="auto">
  <name>Add recommendation usage counter to coach-page.tsx</name>
  <files>src/components/features/coach-page.tsx</files>
  <action>
Update coach-page.tsx to display recommendation usage counter inline next to Generate/Regenerate button.

1. Add import for useUserLimits and getTimeUntilNextReset:
   import { useUserLimits, getTimeUntilNextReset } from '@/hooks/useUserLimits'

2. In CoachPage component, add hook call after existing hooks:
   const { data: limits } = useUserLimits()

3. Add constants for limit calculation after hooks:
   const dailyRecLimit = 2
   const recCount = limits?.rec_count ?? 0
   const recRemaining = Math.max(0, dailyRecLimit - recCount)
   const isRecAtLimit = recRemaining <= 0

4. Find the Generate/Regenerate button (around line 272-280 in existing code). Update the button:
   a. Add disabled prop: disabled={generateRecommendations.isPending || isRecAtLimit}
   b. Keep existing className and styling

5. Immediately after the button, add inline counter display:
   <span className="text-xs text-[#888]">
     {recCount}/{dailyRecLimit} used today
   </span>

   Wrap the button and counter in a flex container if not already:
   <div className="flex items-center justify-between">
     <Button
       onClick={handleRegenerate}
       disabled={generateRecommendations.isPending || isRecAtLimit}
       className="w-full h-12 bg-white text-black disabled:opacity-50"
     >
       <RefreshCw className="h-4 w-4 mr-2" />
       {generateRecommendations.isPending ? 'Generating...' : 'Regenerate Recommendations'}
     </Button>
     <span className="text-xs text-[#888]">
       {recCount}/{dailyRecLimit} used today
     </span>
   </div>

6. After the flex container, add inline error message when at limit:
   {isRecAtLimit && generateRecommendations.error && (
     <p className="text-xs text-red-400 mt-2">
       {generateRecommendations.error.message || getTimeUntilNextReset()}
     </p>
   )}

   OR use the error from generateRecommendations directly if it includes the 429 message:
   {isRecAtLimit && (
     <p className="text-xs text-red-400 mt-2">
       {generateRecommendations.error?.message || getTimeUntilNextReset()}
     </p>
   )}

7. Verify the button is also in the empty state (no recommendations yet) and apply same logic there.

IMPORTANT: Display inline counter text, NOT progress bar (CONTEXT.md requirement).
IMPORTANT: shadcn/ui Tooltip doesn't work on disabled elements - use inline error message instead.
IMPORTANT: The counter refreshes automatically because useUserLimits uses staleTime: 0 and mutations invalidate the query.
</action>
  <verify>
1. Run: pnpm typecheck
2. Run: pnpm lint
3. Verify imports are correct (useUserLimits, getTimeUntilNextReset)
4. Verify counter displays correctly (e.g., "0/2 used today", "1/2 used today", "2/2 used today")
5. Verify button disabled when isRecAtLimit is true (recRemaining <= 0)
6. Verify error message appears when at limit and user clicks button
7. Verify error message shows time until reset or error from API
8. Check mobile responsiveness (counter text readable on small screens)
</verify>
  <done>
coach-page.tsx updated with:
- Inline recommendation usage counter (e.g., "1/2 used today") next to Generate button
- Button disabled when limit reached (isRecAtLimit)
- Inline error message when at limit showing time until reset or API error
- Counter refreshes after each action (via staleTime: 0 and query invalidation)
</done>
</task>

</tasks>

<verification>
1. Recommendation usage counter displays inline next to Generate/Regenerate button
2. Counter shows current count out of daily limit (e.g., "1/2 used today")
3. Button is disabled when limit reached (remaining <= 0)
4. Inline error message appears when at limit
5. Error message shows time until reset (from getTimeUntilNextReset or API error)
6. Counter refreshes after each successful recommendation generation
7. No tooltip used (inline message instead, as shadcn/ui Tooltip doesn't work on disabled elements)
8. TypeScript type checking passes
9. Linting passes
10. UI is responsive on mobile devices
</verification>

<success_criteria>
Coach page displays recommendation usage counter inline and disables button at limit with clear error message showing time until reset.
</success_criteria>

<output>
After completion, create `.planning/phases/27-daily-limit/27-05-SUMMARY.md`
</output>
