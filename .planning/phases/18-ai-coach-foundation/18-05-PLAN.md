---
phase: 18-ai-coach-foundation
plan: 05
type: execute
wave: 3
depends_on: [18-01, 18-03]
files_modified:
  - src/hooks/useCoach.ts
  - src/hooks/useCoachMessages.ts
autonomous: true
user_setup: []

must_haves:
  truths:
    - "useCoachRecommendations() fetches latest recommendations with 24h stale time"
    - "useGenerateRecommendations() mutation generates new recommendations and invalidates cache"
    - "useCoachRateLimit() queries rate limit status with 5min stale time"
    - "useCoachMessages() fetches last 20 chat messages with 1h stale time"
    - "useCreateCoachMessage() mutation creates messages and invalidates message cache"
    - "useClearCoachMessages() mutation deletes all user messages and invalidates cache"
    - "All queries handle auth errors gracefully"
  artifacts:
    - path: "src/hooks/useCoach.ts"
      provides: "TanStack Query hooks for coach recommendations"
      exports:
        - "useCoachRecommendations"
        - "useGenerateRecommendations"
        - "useCoachRateLimit"
    - path: "src/hooks/useCoachMessages.ts"
      provides: "TanStack Query hooks for coach chat messages"
      exports:
        - "useCoachMessages"
        - "useCreateCoachMessage"
        - "useClearCoachMessages"
  key_links:
    - from: "src/hooks/useCoach.ts"
      to: "src/services/coach.ts"
      via: "Uses coach service functions for data operations"
      pattern: "from '@/services/coach'"
    - from: "src/hooks/useCoach.ts"
      to: "src/lib/supabase"
      via: "Imports supabase client for auth.getUser() calls"
      pattern: "import { supabase } from '@/lib/supabase'"
    - from: "src/hooks/useCoachMessages.ts"
      to: "supabase/client"
      via: "Direct Supabase queries for coach_messages table"
      pattern: "from '@/lib/supabase'"
    - from: "src/hooks/useCoach.ts"
      to: "src/hooks/useClimbs.ts"
      via: "Follows existing pattern with queryKeys and useQuery/useMutation"
      pattern: "import { useQuery, useMutation } from '@tanstack/react-query'"
---

<objective>
Create TanStack Query hooks for coach recommendations and chat messages

Purpose: Manage state and caching for coach features with React hooks
Output: useCoach.ts and useCoachMessages.ts hooks with query caching and mutations
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-ai-coach-foundation/18-RESEARCH.md
@src/hooks/useClimbs.ts
@src/services/coach.ts
@src/lib/supabase.ts
@supabase/migrations/20260117_create_coach_tables.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useCoach hooks for recommendations</name>
  <files>src/hooks/useCoach.ts</files>
  <action>
Create src/hooks/useCoach.ts with the following:

```typescript
import { useMutation, useQuery, useQueryClient } from '@tanstack/react-query'

import { supabase } from '@/lib/supabase'
import type { GenerateRecommendationsInput } from '@/services/coach'
import {
  checkUserRateLimit,
  coachKeys,
  generateRecommendations,
  getLatestRecommendations,
} from '@/services/coach'

export function useCoachRecommendations() {
  return useQuery({
    queryKey: coachKeys.currentRecommendations(),
    queryFn: async () => {
      if (!supabase) {
        throw new Error('Supabase client not configured')
      }

      const {
        data: { user },
      } = await supabase.auth.getUser()

      if (!user) {
        throw new Error('Not authenticated')
      }

      return getLatestRecommendations(user.id)
    },
    staleTime: 24 * 60 * 60 * 1000, // 24 hours - show last cached recommendations
    gcTime: 7 * 24 * 60 * 60 * 1000, // 7 days cache
  })
}

export function useGenerateRecommendations() {
  const queryClient = useQueryClient()

  return useMutation({
    mutationFn: generateRecommendations,
    onSuccess: () => {
      void queryClient.invalidateQueries({
        queryKey: coachKeys.currentRecommendations(),
      })
    },
    onError: (error) => {
      console.error('Failed to generate recommendations:', error)
      // Don't throw - UI will show cached recommendations
    },
  })
}

export function useCoachRateLimit() {
  return useQuery({
    queryKey: ['coach', 'rate-limit'],
    queryFn: async () => {
      if (!supabase) {
        throw new Error('Supabase client not configured')
      }

      const {
        data: { user },
      } = await supabase.auth.getUser()

      if (!user) {
        return { allowed: false, remaining: 0 }
      }

      return checkUserRateLimit(user.id)
    },
    staleTime: 5 * 60 * 1000, // 5 minutes
  })
}
```

Key features:
- useCoachRecommendations: Fetches latest recommendations with 24h stale time (REC-04, REC-07)
- useGenerateRecommendations: Generates new recommendations, invalidates cache on success
- useCoachRateLimit: Queries rate limit status, revalidates every 5 minutes
- Follows exact pattern from useClimbs.ts with queryKeys and queryClient invalidation
- Graceful error handling (logs errors, doesn't throw for UI to show cached data)
- Imports supabase client from @/lib/supabase for auth.getUser() calls

Why: These hooks provide React components with cached recommendation data and mutation capabilities, enabling Phase 19 UI implementation.
  </action>
  <verify>Run `pnpm typecheck` - no errors. Verify exports: `grep -E "^export function" src/hooks/useCoach.ts` shows 3 functions. Check stale times: `grep "staleTime" src/hooks/useCoach.ts` shows 24h and 5min values. Verify supabase import: `grep "import.*supabase.*from '@/lib/supabase'" src/hooks/useCoach.ts` shows proper import.</verify>
  <done>useCoach.ts with recommendations and rate limit hooks</done>
</task>

<task type="auto">
  <name>Task 2: Create useCoachMessages hooks for chat</name>
  <files>src/hooks/useCoachMessages.ts</files>
  <action>
Create src/hooks/useCoachMessages.ts with the following:

```typescript
import { useMutation, useQuery, useQueryClient } from '@tanstack/react-query'

import { supabase } from '@/lib/supabase'
import type { TablesInsert } from '@/types'

export interface CoachMessage {
  id: string
  user_id: string
  role: 'user' | 'assistant'
  content: string
  created_at: string
  context: Record<string, unknown>
}

export const coachMessagesKeys = {
  all: ['coach-messages'] as const,
  lists: () => [...coachMessagesKeys.all, 'list'] as const,
  list: () => [...coachMessagesKeys.lists(), 'all'] as const,
}

async function getCoachMessages(): Promise<CoachMessage[]> {
  if (!supabase) {
    throw new Error('Supabase client not configured')
  }

  const {
    data: { user },
  } = await supabase.auth.getUser()

  if (!user) {
    throw new Error('Not authenticated')
  }

  const { data, error } = await supabase
    .from('coach_messages')
    .select('*')
    .eq('user_id', user.id)
    .order('created_at', { ascending: true })
    .limit(20) // Last 20 messages (CHAT-04 requirement)

  if (error) {
    throw error
  }

  return data as CoachMessage[]
}

async function createCoachMessage(
  message: Omit<CoachMessage, 'id' | 'user_id' | 'created_at'>,
): Promise<CoachMessage> {
  if (!supabase) {
    throw new Error('Supabase client not configured')
  }

  const {
    data: { user },
  } = await supabase.auth.getUser()

  if (!user) {
    throw new Error('Not authenticated')
  }

  const { data, error } = await supabase
    .from('coach_messages')
    .insert({
      ...message,
      user_id: user.id,
    } as TablesInsert<'coach_messages'>)
    .select()
    .single()

  if (error) {
    throw error
  }

  return data as CoachMessage
}

export function useCoachMessages() {
  return useQuery({
    queryKey: coachMessagesKeys.list(),
    queryFn: getCoachMessages,
    staleTime: 60 * 60 * 1000, // 1 hour
  })
}

export function useCreateCoachMessage() {
  const queryClient = useQueryClient()

  return useMutation({
    mutationFn: createCoachMessage,
    onSuccess: () => {
      void queryClient.invalidateQueries({ queryKey: coachMessagesKeys.lists() })
    },
  })
}

export function useClearCoachMessages() {
  const queryClient = useQueryClient()

  return useMutation({
    mutationFn: async () => {
      if (!supabase) {
        throw new Error('Supabase client not configured')
      }

      const {
        data: { user },
      } = await supabase.auth.getUser()

      if (!user) {
        throw new Error('Not authenticated')
      }

      const { error } = await supabase
        .from('coach_messages')
        .delete()
        .eq('user_id', user.id)

      if (error) {
        throw error
      }
    },
    onSuccess: () => {
      void queryClient.invalidateQueries({ queryKey: coachMessagesKeys.lists() })
    },
  })
}
```

Key features:
- useCoachMessages: Fetches last 20 messages with 1h stale time (CHAT-04: 10-20 messages)
- useCreateCoachMessage: Creates new message, invalidates cache
- useClearCoachMessages: Deletes all user messages, invalidates cache (for v2 feature CHAT-V2-02)
- Follows exact pattern from useClimbs.ts with queryKeys and mutations
- Messages ordered by created_at ascending for chat display
- RLS ensures users only see their own messages
- Imports supabase client from @/lib/supabase for auth.getUser() calls

Why: These hooks provide React components with cached chat messages and mutation capabilities, enabling Phase 21 chat implementation.
  </action>
  <verify>Run `pnpm typecheck` - no errors. Verify exports: `grep -E "^export" src/hooks/useCoachMessages.ts` shows CoachMessage interface, coachMessagesKeys, and 3 hooks. Check message limit: `grep "limit(20)" src/hooks/useCoachMessages.ts` shows proper limit. Verify supabase import: `grep "import.*supabase.*from '@/lib/supabase'" src/hooks/useCoachMessages.ts` shows proper import.</verify>
  <done>useCoachMessages.ts with chat message hooks</done>
</task>

</tasks>

<verification>
- TypeScript compiles without errors
- All hooks export coachMessagesKeys or coachKeys for cache management
- Query invalidation properly configured in mutations
- Auth errors handled (throws Error for components to handle)
- Stale times set appropriately (24h for recommendations, 5min for rate limit, 1h for messages)
- Message limit set to 20 (CHAT-04 requirement)
- Both hooks import supabase from @/lib/supabase for auth.getUser() calls
</verification>

<success_criteria>
TanStack Query hooks complete:
- Recommendations cached for 24h (offline support - REC-07)
- Rate limit status queried every 5 minutes
- Chat messages limited to 20 (CHAT-04)
- All mutations invalidate relevant queries
- supabase client imported from @/lib/supabase in both hook files
- Ready for UI integration (Phase 19, 21)
</success_criteria>

<output>
After completion, create `.planning/phases/18-ai-coach-foundation/18-05-SUMMARY.md`
</output>
