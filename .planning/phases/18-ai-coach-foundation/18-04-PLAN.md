---
phase: 18-ai-coach-foundation
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/coachUtils.ts
  - src/types/index.ts
autonomous: true
user_setup: []

must_haves:
  truths:
    - "anonymizeClimbsForAI() removes PII before sending to external APIs"
    - "Specific gym names converted to generic 'indoor_gym' or 'outdoor_crags'"
    - "User identifiers (id, user_id, notes) excluded from anonymized data"
    - "validateAnonymizedData() detects common PII patterns in anonymized data"
    - "Anonymized data contains only grade, style, outcome, failure_reasons, awkwardness, generic location"
  artifacts:
    - path: "src/lib/coachUtils.ts"
      provides: "Data anonymization utilities for AI privacy"
      exports:
        - "anonymizeClimbsForAI"
        - "validateAnonymizedData"
    - path: "src/types/index.ts"
      provides: "AnonymizedClimb type definition"
      contains: ["AnonymizedClimb"]
  key_links:
    - from: "src/services/coach.ts"
      to: "src/lib/coachUtils.ts"
      via: "Uses anonymizeClimbsForAI() before Edge Function call"
      pattern: "import { anonymizeClimbsForAI } from '@/lib/coachUtils'"
    - from: "src/lib/coachUtils.ts"
      to: "src/types/index.ts"
      via: "Uses AnonymizedClimb type for type safety"
      pattern: "import type { AnonymizedClimb } from '@/types'"
---

<objective>
Create data anonymization utilities for privacy-safe AI integration

Purpose: Remove PII and sensitive data before sending climbs to external LLM APIs
Output: coachUtils.ts with anonymization and validation functions
</object>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-ai-coach-foundation/18-RESEARCH.md
@src/types/index.ts
@src/lib/supabase.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add AnonymizedClimb type to types/index.ts</name>
  <files>src/types/index.ts</files>
  <action>
Add AnonymizedClimb interface to src/types/index.ts:

```typescript
// AI Coach Types (Privacy-Safe for External APIs)
export interface AnonymizedClimb {
  location: string
  grade_scale: string
  grade_value: string
  climb_type: string
  style: Style[]
  outcome: string
  awkwardness: number
  failure_reasons: FailureReason[]
}
```

Add after PatternAnalysis interfaces, before existing Climb interface.

Why: This type defines the shape of data safe to send to external LLM APIs, excluding PII.
  </action>
  <verify>Run `pnpm typecheck` - no errors. Verify type exists: `grep -c "AnonymizedClimb" src/types/index.ts` shows at least 1 match.</verify>
  <done>AnonymizedClimb type defined in types/index.ts</done>
</task>

<task type="auto">
  <name>Task 2: Create coachUtils with anonymization utilities</name>
  <files>src/lib/coachUtils.ts</files>
  <action>
Create src/lib/coachUtils.ts with the following:

```typescript
import type { Climb, Style, FailureReason } from '@/types'
import type { AnonymizedClimb } from '@/types'

/**
 * Anonymizes climb data before sending to external LLM API.
 * Removes PII, specific locations, and user identifiers.
 */
export function anonymizeClimbsForAI(climbs: Climb[]): AnonymizedClimb[] {
  return climbs.map((climb) => ({
    location: sanitizeLocation(climb.location),
    grade_scale: climb.grade_scale,
    grade_value: climb.grade_value,
    climb_type: climb.climb_type,
    style: climb.style,
    outcome: climb.outcome,
    awkwardness: climb.awkwardness,
    failure_reasons: climb.failure_reasons,
  }))
}

/**
 * Converts specific location names to generic location types.
 * Example: "Metro Rock Gym" -> "indoor_gym"
 * Example: "Red River Gorge" -> "outdoor_crags"
 */
function sanitizeLocation(location: string): string {
  const lowerLocation = location.toLowerCase()

  if (
    lowerLocation.includes('gym') ||
    lowerLocation.includes('climbing wall') ||
    lowerLocation.includes('studio') ||
    lowerLocation.includes('center') ||
    lowerLocation.includes('facility')
  ) {
    return 'indoor_gym'
  }

  if (lowerLocation.includes('crag') || lowerLocation.includes('boulder') || lowerLocation.includes('cliff') || lowerLocation.includes('wall')) {
    return 'outdoor_crags'
  }

  return 'climbing_location'
}

/**
 * Validates that anonymized data contains no PII.
 * Returns list of detected PII fields if any found.
 *
 * Checks for:
 * - Long name-like fields (> 20 chars)
 * - Email addresses
 * - Phone numbers (10+ consecutive digits)
 * - Specific place names (capitalized multi-word locations)
 */
export function validateAnonymizedData(data: unknown): string[] {
  const piiFields: string[] = []

  const checkForPII = (obj: unknown, path = ''): void => {
    if (typeof obj !== 'object' || obj === null) {
      return
    }

    for (const [key, value] of Object.entries(obj as Record<string, unknown>)) {
      const currentPath = path ? `${path}.${key}` : key

      // Check for common PII indicators
      if (typeof value === 'string') {
        // Long name-like field
        if (key.toLowerCase().includes('name') && value.length > 20) {
          piiFields.push(currentPath)
        }

        // Email addresses
        if (key.toLowerCase().includes('email') && value.includes('@')) {
          piiFields.push(currentPath)
        }

        // Phone numbers (10+ consecutive digits)
        if (key.toLowerCase().includes('phone') && /\d{10}/.test(value)) {
          piiFields.push(currentPath)
        }

        // Specific place names (capitalized multi-word locations)
        if (
          currentPath.includes('location') &&
          /^[A-Z][a-z]+(?: [A-Z][a-z]+){2,}$/.test(value)
        ) {
          piiFields.push(currentPath) // Likely a specific place name like "Red River Gorge"
        }

        // User IDs (UUID patterns)
        if (key.toLowerCase().includes('user') && /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(value)) {
          piiFields.push(currentPath)
        }
      }

      if (typeof value === 'object' && value !== null) {
        checkForPII(value, currentPath)
      }
    }
  }

  checkForPII(data)
  return piiFields
}
```

Key privacy features:
- Removes: id, user_id, created_at, notes (may contain PII)
- Converts: Specific gym names -> "indoor_gym", outdoor locations -> "outdoor_crags"
- Keeps: grade, style, outcome, failure_reasons, awkwardness (training-relevant data)
- validateAnonymizedData() detects:
  - Long name-like strings (> 20 chars)
  - Email addresses (@ symbol)
  - Phone numbers (10+ digits)
  - Specific place names (Capitalized multi-word)
  - UUID patterns (user IDs)

Why: This ensures no PII or sensitive user data leaves the application, protecting user privacy and meeting REC-06 error handling requirements.
  </action>
  <verify>Run `pnpm typecheck` - no errors. Verify exports: `grep -E "^export" src/lib/coachUtils.ts` shows both functions exported. Test anonymization: create simple test importing anonymizeClimbsForAI with mock climb containing "Metro Rock Gym" - location becomes "indoor_gym". Test validation: call validateAnonymizedData({ user_id: "abc-123", email: "test@example.com" }) returns array with detected fields.</verify>
  <done>coachUtils.ts with anonymization and PII detection</done>
</task>

</tasks>

<verification>
- TypeScript compiles without errors
- AnonymizedClimb type matches expected structure
- anonymizeClimbsForAI() removes PII fields
- Specific gym names sanitized to generic types
- validateAnonymizedData() detects common PII patterns
- No sensitive data in anonymized output
</verification>

<success_criteria>
Privacy utilities complete:
- Data anonymized before external API calls
- PII detection validates sanitization
- Generic location types replace specific gyms
- User identifiers excluded from AI requests
- Ready for secure LLM integration
</success_criteria>

<output>
After completion, create `.planning/phases/18-ai-coach-foundation/18-04-SUMMARY.md`
</output>
