---
phase: 18-ai-coach-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/20260117_create_coach_tables.sql
  - src/types/index.ts
  - src/services/coach.ts
  - src/services/patterns.ts
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Database tables exist for coach_recommendations, coach_messages, coach_api_usage with proper constraints"
    - "RLS policies enforce user isolation using auth.uid()"
    - "Indexes exist on user_id and timestamp columns for performance"
    - "TypeScript types are defined for all coach tables in types/index.ts"
  artifacts:
    - path: "supabase/migrations/20260117_create_coach_tables.sql"
      provides: "Coach database tables with RLS and indexes"
      contains:
        - "CREATE TABLE public.coach_recommendations"
        - "CREATE TABLE public.coach_messages"
        - "CREATE TABLE public.coach_api_usage"
        - "auth.uid() = user_id"
    - path: "src/types/index.ts"
      provides: "TypeScript types for coach tables"
      contains:
        - "coach_recommendations"
        - "coach_messages"
        - "coach_api_usage"
  key_links:
    - from: "supabase/migrations/20260117_create_coach_tables.sql"
      to: "src/types/index.ts"
      via: "Table structure must match TypeScript types"
      pattern: "Table columns match interface properties"
---

<objective>
Create database schema for AI Coach features with proper RLS policies and performance indexes

Purpose: Enable secure storage of user recommendations, chat messages, and API usage tracking
Output: Three database tables (coach_recommendations, coach_messages, coach_api_usage) with RLS policies, indexes, and TypeScript types
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-ai-coach-foundation/18-RESEARCH.md
@supabase/migrations/20260105175622_create_climbs_table.sql
@src/types/index.ts
@src/services/climbs.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create database migration for coach tables</name>
  <files>supabase/migrations/20260117_create_coach_tables.sql</files>
  <action>
Create migration file supabase/migrations/20260117_create_coach_tables.sql with three tables:

1. **coach_recommendations** table:
   - Columns: id (UUID PK), user_id (UUID FK to profiles, ON DELETE CASCADE), created_at (TIMESTAMPTZ), generation_date (DATE), content (JSONB DEFAULT '{}'), is_cached (BOOLEAN DEFAULT false), error_message (TEXT)
   - RLS policies: Users can SELECT/INSERT/UPDATE own recommendations (auth.uid() = user_id)
   - Indexes: user_id, generation_date DESC, (user_id, generation_date DESC), GIN on content using jsonb_path_ops

2. **coach_messages** table:
   - Columns: id (UUID PK), user_id (UUID FK to profiles, ON DELETE CASCADE), created_at (TIMESTAMPTZ), role (TEXT CHECK IN ('user', 'assistant')), content (TEXT), context (JSONB DEFAULT '{}')
   - RLS policies: Users can SELECT/INSERT/DELETE own messages (auth.uid() = user_id)
   - Indexes: user_id, created_at DESC, (user_id, created_at DESC), GIN on context using jsonb_path_ops

3. **coach_api_usage** table:
   - Columns: id (UUID PK), user_id (UUID FK to profiles, ON DELETE CASCADE), created_at (TIMESTAMPTZ), prompt_tokens (INTEGER), completion_tokens (INTEGER), total_tokens (INTEGER), cost_usd (NUMERIC(10,6)), model (TEXT), endpoint (TEXT), time_window_start (TIMESTAMPTZ)
   - RLS policies: Users can SELECT own usage (auth.uid() = user_id)
   - Indexes: user_id, time_window_start, (user_id, time_window_start)

Follow the exact pattern from supabase/migrations/20260105175622_create_climbs_table.sql:
- Use "public." prefix for all tables
- Enable RLS immediately after table creation
- Use CHECK constraints for enums (role IN ('user', 'assistant'))
- Create indexes with descriptive names (e.g., coach_recommendations_user_id_idx)
- Use gen_random_uuid() for default UUIDs
- Use now() for TIMESTAMPTZ defaults

Why: This structure enables flexible recommendation storage via JSONB, proper user isolation via RLS, and cost tracking for rate limiting.
  </action>
  <verify>Run `npx supabase db push` to apply migration. Verify tables created: `npx supabase db execute --local "SELECT table_name FROM information_schema.tables WHERE table_schema = 'public' AND table_name LIKE 'coach_%'"` returns 3 tables. Verify RLS enabled: `npx supabase db execute --local "SELECT tablename, rowsecurity FROM pg_tables WHERE schemaname = 'public' AND tablename LIKE 'coach_%'"` shows all with rowsecurity=true.</verify>
  <done>Three tables exist with proper RLS policies, indexes, and constraints matching the climbs table pattern</done>
</task>

<task type="auto">
  <name>Task 2: Add TypeScript types for coach tables</name>
  <files>src/types/index.ts</files>
  <action>
Update src/types/index.ts to add coach table types to the Database interface.

Add to Database['public']['Tables'] object:

**coach_recommendations:**
```typescript
coach_recommendations: {
  Row: {
    id: string
    user_id: string
    created_at: string
    generation_date: string
    content: Json
    is_cached: boolean
    error_message: string | null
  }
  Insert: {
    id?: string
    user_id: string
    created_at?: string
    generation_date?: string
    content?: Json
    is_cached?: boolean
    error_message?: string | null
  }
  Update: {
    id?: string
    user_id?: string
    created_at?: string
    generation_date?: string
    content?: Json
    is_cached?: boolean
    error_message?: string | null
  }
}
```

**coach_messages:**
```typescript
coach_messages: {
  Row: {
    id: string
    user_id: string
    created_at: string
    role: 'user' | 'assistant'
    content: string
    context: Json
  }
  Insert: {
    id?: string
    user_id: string
    created_at?: string
    role: 'user' | 'assistant'
    content: string
    context?: Json
  }
  Update: {
    id?: string
    user_id?: string
    created_at?: string
    role?: 'user' | 'assistant'
    content?: string
    context?: Json
  }
}
```

**coach_api_usage:**
```typescript
coach_api_usage: {
  Row: {
    id: string
    user_id: string
    created_at: string
    prompt_tokens: number
    completion_tokens: number
    total_tokens: number
    cost_usd: number
    model: string
    endpoint: string
    time_window_start: string
  }
  Insert: {
    id?: string
    user_id: string
    created_at?: string
    prompt_tokens: number
    completion_tokens: number
    total_tokens: number
    cost_usd: number
    model: string
    endpoint: string
    time_window_start?: string
  }
  Update: {
    id?: string
    user_id?: string
    created_at?: string
    prompt_tokens?: number
    completion_tokens?: number
    total_tokens?: number
    cost_usd?: number
    model?: string
    endpoint?: string
    time_window_start?: string
  }
}
```

Follow the exact pattern from existing climbs and profiles table types in the same file. Place coach_recommendations before coach_messages and coach_api_usage.

Why: These types enable type-safe database operations via TablesInsert<T> and TablesUpdate<T> utilities used in services.
  </action>
  <verify>Run `pnpm typecheck` - no TypeScript errors. Verify types accessible: `grep -c "coach_" src/types/index.ts` shows at least 3 matches.</verify>
  <done>TypeScript types defined for all coach tables matching the database schema</done>
</task>

<task type="auto">
  <name>Task 3: Generate Supabase types from migration</name>
  <files></files>
  <action>
Run Supabase CLI to regenerate TypeScript types from the new database schema:

```bash
npx supabase gen types typescript --local --schema public > src/types/supabase-generated.ts
```

Then verify the generated types include the coach tables.

Why: Ensures TypeScript types are in sync with database schema, catching any type mismatches early.
  </action>
  <verify>Check src/types/supabase-generated.ts contains coach_recommendations, coach_messages, and coach_api_usage types with correct column definitions.</verify>
  <done>Supabase-generated types exist and include all coach tables</done>
</task>

</tasks>

<verification>
- Migration applies cleanly with `npx supabase db push`
- All three tables exist in database with RLS enabled
- Indexes created on user_id, date columns, and JSONB columns
- TypeScript types compile without errors
- Types match database schema (column names, types, nullability)
</verification>

<success_criteria>
Database foundation complete for AI Coach features:
- Tables store recommendations, chat messages, and API usage
- User data isolated via RLS policies
- Performance optimized via indexes
- Type-safe operations via TypeScript types
</success_criteria>

<output>
After completion, create `.planning/phases/18-ai-coach-foundation/18-01-SUMMARY.md`
</output>
