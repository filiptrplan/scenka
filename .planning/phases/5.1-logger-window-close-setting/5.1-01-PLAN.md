---
phase: 5.1-logger-window-close-setting
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [src/types/index.ts, src/lib/validation.ts, src/components/features/settings-page.tsx, src/App.tsx]
autonomous: true
---

<objective>
Add user preference for logger window close behavior after adding climbs.

Purpose: Allow users to choose whether the climb logger sheet stays open after logging a NEW climb (for rapid entry) or closes (one-time entry pattern).

Current behavior:
- NEW climbs: Sheet stays open (Phase 5 auto-reset feature)
- EDIT climbs: Sheet closes

New behavior with preference:
- If `close_logger_after_add = true`: Sheet closes after NEW climbs (same as EDIT)
- If `close_logger_after_add = false`: Sheet stays open after NEW climbs (current behavior)
- EDIT climbs always close (unchanged)

Output: Database field, type update, settings toggle, and App.tsx integration.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/types/index.ts
@src/lib/validation.ts
@src/components/features/settings-page.tsx
@src/App.tsx
</context>

<tasks>
<task type="auto">
  <name>Task 1: Add database field and type definition</name>
  <files>src/types/index.ts</files>
  <action>Add `close_logger_after_add: boolean` field to the Profile interface (around line 146, after `enabled_hold_colors: HoldColor[]`). This field indicates whether the logger sheet should automatically close after logging a NEW climb (true) or stay open for rapid entry (false).

Then create a Supabase migration:
1. Run `npx supabase migration new add_close_logger_after_add_field` to create migration file
2. In the new migration file, add: `alter table profiles add column close_logger_after_add boolean default true not null;`
3. Run `npx supabase db push` to apply the migration
4. Run `npx supabase gen types typescript --local` to regenerate Supabase types

This follows the same pattern as `enabled_hold_colors` and `home_gym` preference fields.</action>
  <verify>Migration file created with `alter table profiles add column close_logger_after_add` statement. Supabase types file includes the new field.</verify>
  <done>Profile interface has `close_logger_after_add` field, Supabase schema updated, types regenerated</done>
</task>

<task type="auto">
  <name>Task 2: Update validation schema</name>
  <files>src/lib/validation.ts</files>
  <action>Add `close_logger_after_add` to the profileSchema object. This should be a z.boolean() field with default true. Place it in the profileSchema definition alongside other profile fields like `enabled_hold_colors` and `home_gym`.</action>
  <verify>TypeScript compiles: `pnpm typecheck`</verify>
  <done>profileSchema includes `close_logger_after_add: z.boolean()`</done>
</task>

<task type="auto">
  <name>Task 3: Add settings toggle control</name>
  <files>src/components/features/settings-page.tsx</files>
  <action>Add a toggle control in the settings form for the `close_logger_after_add` preference. Pattern:

1. Add a Switch/toggle component section (create or use existing shadcn/ui switch component if available, otherwise use a button-based toggle following the existing styling patterns in settings-page.tsx)
2. Position it after the ColorSettings component (around line 143)
3. Use watch() to track the field value: `const closeAfterAdd = watch('close_logger_after_add')`
4. Bind to form with setValue: `setValue('close_logger_after_add', newValue)`
5. Label should be: "Close logger after adding climb"
6. Helper text should explain: "If enabled, the climb logger closes after logging a new climb. If disabled, it stays open for rapid entry."
7. Set default value to `true` in the useForm defaultValues: `close_logger_after_add: profile?.close_logger_after_add ?? true`

Follow the existing settings page styling patterns (bg-white/[0.02], border-white/10, text-xs font-mono labels).</action>
  <verify>Settings form renders toggle control. Switch component works (toggles on/off). Form value updates correctly.</verify>
  <done>Settings page has close_logger_after_add toggle with correct styling and behavior</done>
</task>

<task type="auto">
  <name>Task 4: Integrate preference in App.tsx</name>
  <files>src/App.tsx</files>
  <action>Modify the Layout component to respect the `close_logger_after_add` preference when handling NEW climb submissions.

Current code (around line 281-290):
```typescript
createClimb.mutate(data, {
  onSuccess: () => {
    loggerRef.current?.resetAllState()
    toast.success('Climb logged successfully')
  },
  // ...
})
```

New behavior:
1. Import and use `useProfile` hook to get profile data (already imported, use it)
2. Check `profile?.close_logger_after_add` preference in the onSuccess callback
3. If `close_logger_after_add === true`: Call `setLoggerOpen(false)` to close the sheet
4. If `close_logger_after_add === false`: Keep current behavior (sheet stays open, only reset form)
5. The `resetAllState()` call should remain in both cases

Note: EDIT climb behavior should remain unchanged (always calls setLoggerOpen(false) at line 270).</action>
  <verify>When preference is true, new climb submission closes sheet. When preference is false, sheet stays open. Edit climbs always close sheet.</verify>
  <done>App.tsx respects close_logger_after_add preference for new climbs</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Database migration applied successfully
- [ ] Supabase types regenerated and include new field
- [ ] Settings page shows new toggle control
- [ ] Toggle switches between on/off states
- [ ] Test: With preference true, new climb closes sheet
- [ ] Test: With preference false, new climb keeps sheet open
- [ ] Test: Edit climbs always close sheet regardless of preference
- [ ] `pnpm typecheck` passes with no errors
- [ ] `pnpm build` completes successfully
</verification>

<success_criteria>

- Profile interface includes `close_logger_after_add: boolean` field
- Supabase migration adds column with default true
- Settings form has working toggle for the preference
- App.tsx integrates preference correctly (true closes, false stays open)
- Edit climb behavior unchanged (always closes)
- All type checks and build pass
  </success_criteria>

<output>
After completion, create `.planning/phases/5.1-logger-window-close-setting/5.1-01-SUMMARY.md`
</output>
