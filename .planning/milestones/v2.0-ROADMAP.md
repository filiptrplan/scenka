# Milestone v2.0: AI Coach

**Status:** ✅ SHIPPED 2026-01-20
**Phases:** 18-29
**Total Plans:** 47

## Overview

AI-powered climbing coach with weekly recommendations, streaming chat, pattern analysis, and daily usage limits. Scenka v2.0 transformed from a simple logging tool into an intelligent coaching system that analyzes user data and provides personalized training recommendations.

## Phases

### Phase 18: AI Coach Foundation

**Goal**: Database tables, services, and hooks for AI coach with cost tracking
**Depends on**: None
**Plans**: 5 plans

Plans:
- [x] 18-01: Create database tables for coach recommendations, messages, and usage tracking
- [x] 18-02: Create patterns service for aggregating climb data
- [x] 18-03: Create cost tracking infrastructure
- [x] 18-04: Add privacy safeguards and data anonymization
- [x] 18-05: Create useCoach hook with caching

**Details:**
- Created coach_recommendations, coach_messages, and coach_api_usage tables with JSONB columns for flexible content
- Implemented GIN indexes for efficient JSONB queries
- Built patterns.ts service to extract failure patterns, style weaknesses, and climbing frequency
- Added cost tracking with daily rate limit enforcement (50k tokens/day)
- Implemented data anonymization at source before external API calls

### Phase 19: Coach Page + Recommendations UI

**Goal**: Build UI for displaying weekly recommendations and pattern analysis
**Depends on**: Phase 18
**Plans**: 6 plans

Plans:
- [x] 19-01: Create usePatternAnalysis hook
- [x] 19-02: Build Coach page layout with tabs
- [x] 19-03: Create RecommendationsDisplay component
- [x] 19-04: Create PatternAnalysis component
- [x] 19-05: Add loading and error states
- [x] 19-06: Add chat placeholder route

**Details:**
- Built complete coach page with Recommendations and Pattern Analysis tabs using Radix UI Tabs
- Created pattern analysis display showing failure patterns, style weaknesses, climbing frequency
- Integrated mock data for rapid UI iteration before LLM integration
- Added 24h cache for pattern analysis to match recommendation refresh cycle

### Phase 20: LLM Integration

**Goal**: Connect to OpenRouter API and generate real recommendations
**Depends on**: Phase 19
**Plans**: 3 plans

Plans:
- [x] 20-01: Create OpenRouter Edge Function for recommendations
- [x] 20-02: Add output validation and error handling
- [x] 20-03: Integrate real recommendations with graceful fallback

**Details:**
- Built openrouter-coach Edge Function with JWT validation and prompt construction
- Integrated OpenAI SDK with baseURL override for OpenRouter API compatibility
- Implemented structured JSON output with retry logic (up to 3 times)
- Added graceful fallback to cached recommendations on API failures

### Phase 21: Chat Interface

**Goal**: Build streaming chat interface for Q&A with climbing coach
**Depends on**: Phase 20
**Plans**: 5 plans

Plans:
- [x] 21-01: Build streaming chat infrastructure
- [x] 21-02: Integrate @microsoft/fetch-event-source for SSE
- [x] 21-03: Create chat UI components (messages, input)
- [x] 21-04: Add message persistence and history
- [x] 21-05: Add polish and error handling

**Details:**
- Chose Server-Sent Events over WebSocket for simpler HTTP-based streaming
- Implemented useStreamingChat hook with message history limit (20 messages)
- Built MessageBubble and TypingIndicator components with mobile-first design
- Added auto-scroll behavior and mobile auto-focus for frictionless experience
- Implemented AbortController for cleanup and manual abort

### Phase 22: OpenRouter Model Configuration

**Goal**: Centralize OpenRouter model configuration
**Depends on**: Phase 21
**Plans**: 1 plan

Plans:
- [x] 22-01: Add OPENROUTER_MODEL environment variable support

**Details:**
- Centralized model configuration for both chat and coach Edge Functions
- Used OPENROUTER_MODEL env var for consistent model selection
- Removed calculateCost in favor of OpenRouter's provided usage.cost field

### Phase 23: Refocus Coach on Technique

**Goal**: Shift from strength training to technique-focused coaching
**Depends on**: Phase 22
**Plans**: 7 plans

Plans:
- [x] 23-01: Extend anonymization for climb notes and dates
- [x] 23-02: Refactor system prompt to technique-first philosophy
- [x] 23-03: Extract recent climbs for LLM context
- [x] 23-04: Pass recent climbs to Edge Function
- [x] 23-05: Extend Edge Function types for recent climbs
- [x] 23-06: Update system prompt with recent climbs
- [x] 23-07: Update example outputs for technique drills

**Details:**
- Refactored system prompt to technique-first coaching (strength failures = technique gaps)
- Added specific strength-to-technique reframing for common failure types
- Extracted last 30 climbs for LLM context
- Included "Recent Climb History" section in prompts with compact JSON formatting
- Updated drill examples to technique-focused (Silent Feet Ladder instead of hangboard)

### Phase 24: Projecting Focus Recommendations

**Goal**: Add projecting focus areas to help select boulders each week
**Depends on**: Phase 23
**Plans**: 3 plans

Plans:
- [x] 24-01: Add projecting focus to system prompt
- [x] 24-02: Update UI to display projecting focus
- [x] 24-03: Add projecting focus to types

**Details:**
- Added projecting_focus field to CoachRecommendation interface
- Provided qualitative grade guidance (e.g., 'slightly above max grade')
- Base recommendations primarily on style weaknesses from pattern analysis
- Added 3-4 focus areas to give users options rather than single recommendation

### Phase 25: User Climbing Context for Prompts

**Goal**: Allow users to describe their climbing style and goals
**Depends on**: Phase 24
**Plans**: 4 plans

Plans:
- [x] 25-01: Add climbing_context column to profiles table
- [x] 25-02: Add climbing context input to settings page
- [x] 25-03: Fetch user profile for coach context
- [x] 25-04: Pass climbing context to Edge Function

**Details:**
- Added nullable TEXT column (2000 char limit) to profiles table
- Added optional climbing_context field to profile schema
- Implemented real-time character count via React Hook Form watch()
- Integrated climbing context into system prompt after User Profile section
- Added explicit PII warning in help text

### Phase 26: Update README with Milestone Work

**Goal**: Document AI Coach features in README
**Depends on**: Phase 25
**Plans**: 1 plan

Plans:
- [x] 26-01: Update README with AI Coach section

**Details:**
- Added AI Coach section to README after "What Makes Scenka Different"
- Placed Upgrade section after Development Notes
- Included all migration file references for developer access
- Described 5-step privacy architecture data flow
- Added TODO comments for screenshot capture

### Phase 27: Impose Daily Limit on Usage

**Goal**: Control API costs with daily usage limits
**Depends on**: Phase 26
**Plans**: 6 plans

Plans:
- [x] 27-01: Create user_limits table and RPC functions
- [x] 27-02: Add daily recommendation limit check to coach Edge Function
- [x] 27-03: Add daily chat limit enforcement to chat Edge Function
- [x] 27-04: Create useUserLimits hook
- [x] 27-05: Add recommendation usage counter to coach page
- [x] 27-06: Add chat usage counter and limit enforcement to chat page

**Details:**
- Created user_limits table with separate rec_count and chat_count columns
- Implemented atomic reset and increment pattern with CASE statement
- Added RLS policy with SELECT only (Edge Functions use RPC with elevated permissions)
- Set limits: 2 recommendations/day, 10 chat messages/day
- Implemented client-side limit check for immediate feedback
- Added time until reset calculation with UTC midnight handling

### Phase 28: Rework Chat System Prompt and Data Context

**Goal**: Include latest recommendations in chat context for coherent conversations
**Depends on**: Phase 27
**Plans**: 1 plan

Plans:
- [x] 28-01: Update system prompt with recommendations support

**Details:**
- Exported Drill, ProjectingFocus, RecommendationsContent, and RecommendationsData interfaces
- Created formatRecommendationsForLLM helper for structured prompt sections
- Added conditional recommendations section only if recommendations.content exists
- Enhanced useStreamingChat hook to pass recommendations to Edge Function
- Added logging for recommendation fetch status

### Phase 29: Add Markdown Rendering to Chat Bubbles

**Goal**: Render formatted responses with code blocks and syntax highlighting
**Depends on**: Phase 28
**Plans**: 3 plans

Plans:
- [x] 29-01: Create markdown components with dark theme
- [x] 29-02: Add markdown rendering to assistant messages
- [x] 29-03: Wire up rehype-highlight for syntax highlighting

**Details:**
- Installed react-markdown, remark-gfm, rehype-highlight, and github-dark.css
- Created dark-themed markdown components matching app's color system (#09090b background)
- Added conditional markdown rendering for assistant messages only (user messages remain plain text)
- Implemented code block detection via className presence
- Added rehypeHighlight plugin for syntax coloring

---

## Milestone Summary

**Decimal Phases:**
None in this milestone

**Key Decisions:**

From PROJECT.md Key Decisions table:

- Edge Functions for LLM calls: Server-side API calls with JWT auth, no client secrets
- SSE streaming for chat: Server-Sent Events for real-time responses
- Technique-first coaching: Strength failures = technique gaps to reframe
- Markdown rendering for chat: react-markdown + remark-gfm + rehype-highlight
- Daily usage limits via RPC functions: Atomic counters with UTC midnight reset
- JSONB for recommendation content: Support schema evolution without migrations
- Data anonymization at source: Prevent PII leakage to OpenRouter API
- Cost tracking from day one: Track usage and enforce limits immediately
- System prompt module in _shared: Reusability and centralized maintenance

**Issues Resolved:**

- Privacy violations risk: Anonymized data at source before any external API calls
- Uncontrolled API costs: Implemented usage tracking and per-user quotas from day one
- Hallucination risk: Constrained outputs with structured prompts and validation
- No offline fallback: Cached recommendations work offline
- Poor Chat UX: Mobile-optimized with quick replies, typing indicators, streaming

**Technical Debt Incurred:**

- Screenshots need capture: README includes TODO comments for screenshot capture (coach page, chat page)
- Edge Function deployment: User must manually deploy updated functions (openrouter-chat, openrouter-coach)
- OPENROUTER_MODEL required: User must set environment variable before Edge Functions work
- OpenRouter API key required: User must configure API key in Supabase Dashboard

---

_For current project status, see .planning/ROADMAP.md_

---

## Usage Guidelines

This archive documents v2.0 AI Coach milestone (Phases 18-29) completed 2026-01-20.

**Files modified:**
- 184 files (37,569 insertions, 143 deletions)
- ~7,162 lines of TypeScript
- 12 phases, 47 plans
- 3 days from start to ship (2026-01-17 → 2026-01-20)

**Git range:** feat(18-02) → feat(29-03)
